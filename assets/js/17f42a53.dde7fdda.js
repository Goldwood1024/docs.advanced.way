(window.webpackJsonp=window.webpackJsonp||[]).push([[18],{269:function(e,n,t){"use strict";t.d(n,"a",(function(){return p})),t.d(n,"b",(function(){return h}));var a=t(0),r=t.n(a);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function c(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?c(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):c(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function i(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var s=r.a.createContext({}),b=function(e){var n=r.a.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},p=function(e){var n=b(e.components);return r.a.createElement(s.Provider,{value:n},e.children)},d={inlineCode:"code",wrapper:function(e){var n=e.children;return r.a.createElement(r.a.Fragment,{},n)}},u=r.a.forwardRef((function(e,n){var t=e.components,a=e.mdxType,o=e.originalType,c=e.parentName,s=i(e,["components","mdxType","originalType","parentName"]),p=b(t),u=a,h=p["".concat(c,".").concat(u)]||p[u]||d[u]||o;return t?r.a.createElement(h,l(l({ref:n},s),{},{components:t})):r.a.createElement(h,l({ref:n},s))}));function h(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var o=t.length,c=new Array(o);c[0]=u;var l={};for(var i in n)hasOwnProperty.call(n,i)&&(l[i]=n[i]);l.originalType=e,l.mdxType="string"==typeof e?e:a,c[1]=l;for(var s=2;s<o;s++)c[s]=t[s];return r.a.createElement.apply(null,c)}return r.a.createElement.apply(null,t)}u.displayName="MDXCreateElement"},84:function(e,n,t){"use strict";t.r(n),t.d(n,"frontMatter",(function(){return c})),t.d(n,"metadata",(function(){return l})),t.d(n,"toc",(function(){return i})),t.d(n,"default",(function(){return b}));var a=t(3),r=t(7),o=(t(0),t(269)),c={title:"\u4ee3\u7406"},l={unversionedId:"java/base/\u4ee3\u7406",id:"java/base/\u4ee3\u7406",isDocsHomePage:!1,title:"\u4ee3\u7406",description:"\u9759\u6001\u4ee3\u7406",source:"@site/docs/java/base/\u4ee3\u7406.md",slug:"/java/base/\u4ee3\u7406",permalink:"/docs.advanced.way/docs/java/base/\u4ee3\u7406",editUrl:"https://github.com/Goldwood1024/docs.advanced.way/docs/docs/java/base/\u4ee3\u7406.md",version:"current",lastUpdatedAt:1616131278,formattedLastUpdatedAt:"3/19/2021",sidebar:"java",previous:{title:"\u5bf9\u8c61\u5f15\u7528",permalink:"/docs.advanced.way/docs/java/base/Reference"},next:{title:"\u5173\u952e\u5b57",permalink:"/docs.advanced.way/docs/java/base/\u5173\u952e\u5b57"}},i=[{value:"\u9759\u6001\u4ee3\u7406",id:"\u9759\u6001\u4ee3\u7406",children:[]},{value:"\u52a8\u6001\u4ee3\u7406",id:"\u52a8\u6001\u4ee3\u7406",children:[{value:"JDK \u52a8\u6001\u4ee3\u7406",id:"jdk-\u52a8\u6001\u4ee3\u7406",children:[]},{value:"\u6709\u5b9e\u73b0\u7c7b",id:"\u6709\u5b9e\u73b0\u7c7b",children:[]},{value:"\u65e0\u5b9e\u73b0\u7c7b",id:"\u65e0\u5b9e\u73b0\u7c7b",children:[]},{value:"\u4fdd\u5b58\u4ee3\u7406\u7c7b",id:"\u4fdd\u5b58\u4ee3\u7406\u7c7b",children:[]},{value:"\u4ee3\u7406\u7c7b",id:"\u4ee3\u7406\u7c7b",children:[]},{value:"Proxy.class",id:"proxyclass",children:[]}]}],s={toc:i};function b(e){var n=e.components,t=Object(r.a)(e,["components"]);return Object(o.b)("wrapper",Object(a.a)({},s,t,{components:n,mdxType:"MDXLayout"}),Object(o.b)("h2",{id:"\u9759\u6001\u4ee3\u7406"},"\u9759\u6001\u4ee3\u7406"),Object(o.b)("p",null,"\u4ee3\u7406\u7c7b\u5728\u7a0b\u5e8f\u8fd0\u884c\u524d\u5c31\u5df2\u7ecf\u5b58\u5728"),Object(o.b)("h2",{id:"\u52a8\u6001\u4ee3\u7406"},"\u52a8\u6001\u4ee3\u7406"),Object(o.b)("blockquote",null,Object(o.b)("p",{parentName:"blockquote"},"\u4ee3\u7406\u5bf9\u8c61\u662f\u5728jvm\u8fd0\u884c\u65f6\u52a8\u6001\u751f\u6210")),Object(o.b)("h3",{id:"jdk-\u52a8\u6001\u4ee3\u7406"},"JDK \u52a8\u6001\u4ee3\u7406"),Object(o.b)("p",null,"\u5728java\u7684\u52a8\u6001\u4ee3\u7406\u673a\u5236\u4e2d\uff0c\u6709\u4e24\u4e2a\u91cd\u8981\u7684\u7c7b\u6216\u63a5\u53e3\uff0c\u4e00\u4e2a\u662f ",Object(o.b)("inlineCode",{parentName:"p"},"InvocationHandler(Interface)"),"\u3001\u53e6\u4e00\u4e2a\u5219\u662f ",Object(o.b)("inlineCode",{parentName:"p"},"Proxy(Class)"),"\uff0c\u8fd9\u4e00\u4e2a\u7c7b\u548c\u63a5\u53e3\u662f\u5b9e\u73b0\u6211\u4eec\u52a8\u6001\u4ee3\u7406\u6240\u5fc5\u987b\u7528\u5230\u7684"),Object(o.b)("h4",{id:"invocationhandler"},Object(o.b)("inlineCode",{parentName:"h4"},"InvocationHandler")),Object(o.b)("p",null,"\u6bcf\u4e00\u4e2a\u52a8\u6001\u4ee3\u7406\u7c7b\u90fd\u5fc5\u987b\u8981\u5b9e\u73b0 ",Object(o.b)("inlineCode",{parentName:"p"},"InvocationHandler")," \u8fd9\u4e2a\u63a5\u53e3\uff0c\u5e76\u4e14\u6bcf\u4e2a\u4ee3\u7406\u7c7b\u7684\u5b9e\u4f8b\u90fd\u5173\u8054\u5230\u4e86\u4e00\u4e2a ",Object(o.b)("inlineCode",{parentName:"p"},"handler"),"\uff0c\u5f53\u6211\u4eec\u901a\u8fc7\u4ee3\u7406\u5bf9\u8c61\u8c03\u7528\u4e00\u4e2a\u65b9\u6cd5\u7684\u65f6\u5019\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u7684\u8c03\u7528\u5c31\u4f1a\u88ab\u8f6c\u53d1\u4e3a\u7531 ",Object(o.b)("inlineCode",{parentName:"p"},"InvocationHandler")," \u8fd9\u4e2a\u63a5\u53e3\u7684 ",Object(o.b)("inlineCode",{parentName:"p"},"invoke")," \u65b9\u6cd5\u6765\u8fdb\u884c\u8c03\u7528"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-java"},"Object invoke(Object proxy, Method method, Object[] args) throws Throwable\n\nproxy:\u3000\u6307\u4ee3\u6211\u4eec\u6240\u4ee3\u7406\u7684\u90a3\u4e2a\u771f\u5b9e\u5bf9\u8c61\nmethod: \u6307\u4ee3\u7684\u662f\u6211\u4eec\u6240\u8981\u8c03\u7528\u771f\u5b9e\u5bf9\u8c61\u7684\u67d0\u4e2a\u65b9\u6cd5\u7684Method\u5bf9\u8c61\nargs:\u3000\u3000\u6307\u4ee3\u7684\u662f\u8c03\u7528\u771f\u5b9e\u5bf9\u8c61\u67d0\u4e2a\u65b9\u6cd5\u65f6\u63a5\u53d7\u7684\u53c2\u6570\n")),Object(o.b)("h4",{id:"proxy"},Object(o.b)("inlineCode",{parentName:"h4"},"Proxy")),Object(o.b)("p",null,"\u7528\u6765\u52a8\u6001\u521b\u5efa\u4e00\u4e2a\u4ee3\u7406\u5bf9\u8c61\u7684\u7c7b"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-java"},"public static Object newProxyInstance(ClassLoader loader, Class<?>[] interfaces,  InvocationHandler h)  throws IllegalArgumentException\n\nloader:\u3000\u4e00\u4e2aClassLoader\u5bf9\u8c61\uff0c\u5b9a\u4e49\u4e86\u7531\u54ea\u4e2aClassLoader\u5bf9\u8c61\u6765\u5bf9\u751f\u6210\u7684\u4ee3\u7406\u5bf9\u8c61\u8fdb\u884c\u52a0\u8f7d\n\ninterfaces:\u3000\u4e00\u4e2aInterface\u5bf9\u8c61\u7684\u6570\u7ec4\uff0c\u8868\u793a\u7684\u662f\u6211\u5c06\u8981\u7ed9\u6211\u9700\u8981\u4ee3\u7406\u7684\u5bf9\u8c61\u63d0\u4f9b\u4e00\u7ec4\u4ec0\u4e48\u63a5\u53e3\uff0c\u5982\u679c\u6211\u63d0\u4f9b\u4e86\u4e00\u7ec4\u63a5\u53e3\u7ed9\u5b83\uff0c\u90a3\u4e48\u8fd9\u4e2a\u4ee3\u7406\u5bf9\u8c61\u5c31\u5ba3\u79f0\u5b9e\u73b0\u4e86\u8be5\u63a5\u53e3(\u591a\u6001)\uff0c\u8fd9\u6837\u6211\u5c31\u80fd\u8c03\u7528\u8fd9\u7ec4\u63a5\u53e3\u4e2d\u7684\u65b9\u6cd5\u4e86\n\nh:\u3000\u4e00\u4e2aInvocationHandler\u5bf9\u8c61\uff0c\u8868\u793a\u7684\u662f\u5f53\u6211\u8fd9\u4e2a\u52a8\u6001\u4ee3\u7406\u5bf9\u8c61\u5728\u8c03\u7528\u65b9\u6cd5\u7684\u65f6\u5019\uff0c\u4f1a\u5173\u8054\u5230\u54ea\u4e00\u4e2aInvocationHandler\u5bf9\u8c61\u4e0a\n")),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"Proxy.newProxyInstance")," \u521b\u5efa\u7684\u4ee3\u7406\u5bf9\u8c61\u662f\u5728jvm\u8fd0\u884c\u65f6\u52a8\u6001\u751f\u6210\u7684\u4e00\u4e2a\u5bf9\u8c61"),Object(o.b)("h3",{id:"\u6709\u5b9e\u73b0\u7c7b"},"\u6709\u5b9e\u73b0\u7c7b"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-java"},'// \u4ee3\u7406\u63a5\u53e3\u5b9a\u4e49\npublic interface Hello {\n    void say();\n}\n\n// \u63a5\u53e3\u65b9\u6cd5\u5b9e\u73b0\u7c7b\npublic class HelloImpl implements Hello {\n\n    @Override\n    public void say() {\n        System.out.println("\u8fd9\u662f\u5177\u4f53\u5b9e\u73b0\u65b9\u6cd5");\n    }\n}\n\n// \u4ee3\u7406\u7c7b\npublic class HelloProxy implements InvocationHandler {\n    // \u76ee\u6807\u5bf9\u8c61\n    private final Object target;\n\n    HelloProxy(Object target) {\n        this.target = target;\n    }\n\n    public Object newProxyInstance() {\n        // \u751f\u6210\u4ee3\u7406\u5bf9\u8c61\n        return Proxy.newProxyInstance(target.getClass().getClassLoader(),\n                target.getClass().getInterfaces(),\n                this);\n    }\n\n    @Override\n    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n        System.out.println("before");\n\n        // \u8c03\u7528\u88ab\u4ee3\u7406\u7684\u65b9\u6cd5\n        Object result = method.invoke(target, args);\n        System.out.println("after");\n        return result;\n    }\n}\n\n\npublic class ProxyMain {\n    public static void main(String[] args) {\n        // \u771f\u5b9e\u5bf9\u8c61\n        Hello helloProxy = (Hello) (new HelloProxy(new HelloImpl())).newProxyInstance();\n        helloProxy.say();\n    }\n}\n')),Object(o.b)("h3",{id:"\u65e0\u5b9e\u73b0\u7c7b"},"\u65e0\u5b9e\u73b0\u7c7b"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-java"},'// \u4ee3\u7406\u63a5\u53e3\u5b9a\u4e49\npublic interface Hello {\n    void say();\n}\n\n// \u4ee3\u7406\u7c7b\npublic class NoProxy implements InvocationHandler {\n    public Object newProxyInstance(Class<?> clazz) {\n        // \u751f\u6210\u4ee3\u7406\u5bf9\u8c61\uff0c clazz \u4e3a\u4ee3\u7406\u7684\u63a5\u53e3\n        return Proxy.newProxyInstance(clazz.getClassLoader(), new Class[]{clazz}, this);\n    }\n\n    @Override\n    public Object invoke(Object proxy, Method method, Object[] args) {\n        // \u4ee3\u7406\u63a5\u53e3\u65b9\u6cd5-\u6267\u884c\u903b\u8f91\n        System.out.println("\u4ee3\u7406\u65b9\u6cd5");\n        return null;\n    }\n}\n\npublic class ProxyMain {\n\n    public static void main(String[] args) {\n        // \u771f\u5b9e\u5bf9\u8c61\n        Hello helloProxy = (Hello) new NoProxy().newProxyInstance(Hello.class);\n        helloProxy.say();\n    }\n}\n')),Object(o.b)("h3",{id:"\u4fdd\u5b58\u4ee3\u7406\u7c7b"},"\u4fdd\u5b58\u4ee3\u7406\u7c7b"),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"java.lang.reflect.ProxyGenerator")," \u7528\u4e8e\u4fdd\u5b58\u4ee3\u7406\u7c7b"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-java"},'System.getProperties().put("jdk.proxy.ProxyGenerator.saveGeneratedFiles", "true");\n')),Object(o.b)("h3",{id:"\u4ee3\u7406\u7c7b"},"\u4ee3\u7406\u7c7b"),Object(o.b)("blockquote",null,Object(o.b)("p",{parentName:"blockquote"},"\u6709\u65e0\u5b9e\u73b0\u7c7b \u751f\u6210\u7684\u4ee3\u7406\u7c7b\u76f8\u540c")),Object(o.b)("ol",null,Object(o.b)("li",{parentName:"ol"},"\u4ee3\u7406\u7c7b\u7ee7\u627f\u4e86 ",Object(o.b)("inlineCode",{parentName:"li"},"Proxy")," \u7c7b\u5e76\u4e14\u5b9e\u73b0\u4e86\u8981\u4ee3\u7406\u7684\u63a5\u53e3\uff0c\u7531\u4e8ejava\u4e0d\u652f\u6301\u591a\u7ee7\u627f\uff0c\u6240\u4ee5JDK\u52a8\u6001\u4ee3\u7406\u4e0d\u80fd\u4ee3\u7406\u7c7b"),Object(o.b)("li",{parentName:"ol"},"\u91cd\u5199\u4e86",Object(o.b)("inlineCode",{parentName:"li"},"equals"),"\u3001",Object(o.b)("inlineCode",{parentName:"li"},"hashCode"),"\u3001",Object(o.b)("inlineCode",{parentName:"li"},"toString")),Object(o.b)("li",{parentName:"ol"},"\u6709\u4e00\u4e2a\u9759\u6001\u4ee3\u7801\u5757\uff0c\u901a\u8fc7\u53cd\u5c04\u83b7\u5f97\u4ee3\u7406\u7c7b\u7684\u6240\u6709\u65b9\u6cd5"),Object(o.b)("li",{parentName:"ol"},"\u901a\u8fc7 ",Object(o.b)("inlineCode",{parentName:"li"},"invoke")," \u6267\u884c\u4ee3\u7406\u7c7b\u4e2d\u7684\u76ee\u6807\u65b9\u6cd5")),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-java"},'public final class $Proxy0 extends Proxy implements Hello {\n    // \u4ee3\u7406\u7684\u65b9\u6cd5\n    private static Method m1;\n    private static Method m2;\n    private static Method m3;\n    private static Method m0;\n\n    public $Proxy0(InvocationHandler var1) throws  {\n        super(var1);\n    }\n\n    public final boolean equals(Object var1) throws  {\n        try {\n            return (Boolean)super.h.invoke(this, m1, new Object[]{var1});\n        } catch (RuntimeException | Error var3) {\n            throw var3;\n        } catch (Throwable var4) {\n            throw new UndeclaredThrowableException(var4);\n        }\n    }\n\n    public final String toString() throws  {\n        try {\n            return (String)super.h.invoke(this, m2, (Object[])null);\n        } catch (RuntimeException | Error var2) {\n            throw var2;\n        } catch (Throwable var3) {\n            throw new UndeclaredThrowableException(var3);\n        }\n    }\n\n    public final void say() throws  {\n        try {\n            // \u8c03\u7528\u65b9\u6cd5\n            // \u8c03\u7528 Proxy\u7c7b\u7684InvocationHandler\u7684\u5b9e\u73b0\u7c7b (invoke(proxy, method, args))\n            super.h.invoke(this, m3, (Object[])null);\n        } catch (RuntimeException | Error var2) {\n            throw var2;\n        } catch (Throwable var3) {\n            throw new UndeclaredThrowableException(var3);\n        }\n    }\n\n    public final int hashCode() throws  {\n        try {\n            return (Integer)super.h.invoke(this, m0, (Object[])null);\n        } catch (RuntimeException | Error var2) {\n            throw var2;\n        } catch (Throwable var3) {\n            throw new UndeclaredThrowableException(var3);\n        }\n    }\n\n    static {\n        try {\n            m1 = Class.forName("java.lang.Object").getMethod("equals", Class.forName("java.lang.Object"));\n            m2 = Class.forName("java.lang.Object").getMethod("toString");\n            m3 = Class.forName("com.jdk.baseapi.proxy.Hello").getMethod("say");\n            m0 = Class.forName("java.lang.Object").getMethod("hashCode");\n        } catch (NoSuchMethodException var2) {\n            throw new NoSuchMethodError(var2.getMessage());\n        } catch (ClassNotFoundException var3) {\n            throw new NoClassDefFoundError(var3.getMessage());\n        }\n    }\n}\n')),Object(o.b)("h3",{id:"proxyclass"},"Proxy.class"),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-java"},"public class Proxy implements java.io.Serializable {\n    private static final long serialVersionUID = -2222568056686623797L;\n\n    /** parameter types of a proxy class constructor */\n    private static final Class<?>[] constructorParams =\n        { InvocationHandler.class };\n\n    /**\n     * a cache of proxy constructors with\n     * {@link Constructor#setAccessible(boolean) accessible} flag already set\n     */\n    private static final ClassLoaderValue<Constructor<?>> proxyCache =\n        new ClassLoaderValue<>();\n\n    /**\n     * the invocation handler for this proxy instance.\n     * @serial\n     */\n    // \u4ee3\u7406\u63a5\u53e3\n    protected InvocationHandler h;\n\n    protected Proxy(InvocationHandler h) {\n        Objects.requireNonNull(h);\n        this.h = h;\n    }\n\n    ...\n\n    @CallerSensitive\n    public static Object newProxyInstance(ClassLoader loader,\n                                          Class<?>[] interfaces,\n                                          InvocationHandler h) {\n        Objects.requireNonNull(h);\n\n        final Class<?> caller = System.getSecurityManager() == null\n                                    ? null\n                                    : Reflection.getCallerClass();\n\n        /*\n         * Look up or generate the designated proxy class and its constructor.\n         */\n        // \u6784\u9020\u51fd\u6570\n        Constructor<?> cons = getProxyConstructor(caller, loader, interfaces);\n\n        return newProxyInstance(caller, cons, h);\n    }\n\n    private static Object newProxyInstance(Class<?> caller, // null if no SecurityManager\n                                           Constructor<?> cons,\n                                           InvocationHandler h) {\n        /*\n         * Invoke its constructor with the designated invocation handler.\n         */\n        try {\n            if (caller != null) {\n                checkNewProxyPermission(caller, cons.getDeclaringClass());\n            }\n\n            // \u521b\u5efa\u5b9e\u4f8b\n            return cons.newInstance(new Object[]{h});\n\n        } catch (IllegalAccessException | InstantiationException e) {\n            throw new InternalError(e.toString(), e);\n        } catch (InvocationTargetException e) {\n            Throwable t = e.getCause();\n            if (t instanceof RuntimeException) {\n                throw (RuntimeException) t;\n            } else {\n                throw new InternalError(t.toString(), t);\n            }\n        }\n    }\n}\n")))}b.isMDXComponent=!0}}]);