(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[2505],{3905:function(e,n,t){"use strict";t.d(n,{Zo:function(){return d},kt:function(){return m}});var r=t(67294);function l(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function a(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){l(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function p(e,n){if(null==e)return{};var t,r,l=function(e,n){if(null==e)return{};var t,r,l={},o=Object.keys(e);for(r=0;r<o.length;r++)t=o[r],n.indexOf(t)>=0||(l[t]=e[t]);return l}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)t=o[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(l[t]=e[t])}return l}var i=r.createContext({}),s=function(e){var n=r.useContext(i),t=n;return e&&(t="function"==typeof e?e(n):a(a({},n),e)),t},d=function(e){var n=s(e.components);return r.createElement(i.Provider,{value:n},e.children)},c={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},u=r.forwardRef((function(e,n){var t=e.components,l=e.mdxType,o=e.originalType,i=e.parentName,d=p(e,["components","mdxType","originalType","parentName"]),u=s(t),m=l,k=u["".concat(i,".").concat(m)]||u[m]||c[m]||o;return t?r.createElement(k,a(a({ref:n},d),{},{components:t})):r.createElement(k,a({ref:n},d))}));function m(e,n){var t=arguments,l=n&&n.mdxType;if("string"==typeof e||l){var o=t.length,a=new Array(o);a[0]=u;var p={};for(var i in n)hasOwnProperty.call(n,i)&&(p[i]=n[i]);p.originalType=e,p.mdxType="string"==typeof e?e:l,a[1]=p;for(var s=2;s<o;s++)a[s]=t[s];return r.createElement.apply(null,a)}return r.createElement.apply(null,t)}u.displayName="MDXCreateElement"},78413:function(e,n,t){"use strict";t.r(n),t.d(n,{frontMatter:function(){return p},metadata:function(){return i},toc:function(){return s},default:function(){return c}});var r=t(22122),l=t(19756),o=(t(67294),t(3905)),a=["components"],p={title:"Docker Compose"},i={unversionedId:"zoology/cloud/docker/base/Compose",id:"zoology/cloud/docker/base/Compose",isDocsHomePage:!1,title:"Docker Compose",description:"\u7528\u4e8e\u5b9a\u4e49\u548c\u8fd0\u884c\u591a\u5bb9\u5668 Docker \u5e94\u7528\u7a0b\u5e8f\u7684\u5de5\u5177",source:"@site/docs/zoology/cloud/docker/base/Compose.md",sourceDirName:"zoology/cloud/docker/base",slug:"/zoology/cloud/docker/base/Compose",permalink:"/docs.advanced.way/docs/zoology/cloud/docker/base/Compose",editUrl:"https://github.com/Goldwood1024/docs.advanced.way/tree/master/docs/zoology/cloud/docker/base/Compose.md",version:"current",lastUpdatedAt:1622711894,formattedLastUpdatedAt:"6/3/2021",frontMatter:{title:"Docker Compose"},sidebar:"docker",previous:{title:"Dockerfile",permalink:"/docs.advanced.way/docs/zoology/cloud/docker/base/Dockerfile"},next:{title:"YAML",permalink:"/docs.advanced.way/docs/zoology/cloud/docker/base/YAML"}},s=[{value:"Compose \u5b89\u88c5",id:"compose-\u5b89\u88c5",children:[]},{value:"\u6307\u4ee4",id:"\u6307\u4ee4",children:[{value:"version",id:"version",children:[]},{value:"build",id:"build",children:[]},{value:"cap_add\uff0ccap_drop",id:"cap_add\uff0ccap_drop",children:[]},{value:"cgroup_parent",id:"cgroup_parent",children:[]},{value:"command",id:"command",children:[]},{value:"container_name",id:"container_name",children:[]},{value:"depends_on",id:"depends_on",children:[]},{value:"deploy",id:"deploy",children:[]},{value:"devices",id:"devices",children:[]},{value:"dns",id:"dns",children:[]},{value:"dns_search",id:"dns_search",children:[]},{value:"entrypoint",id:"entrypoint",children:[]},{value:"env_file",id:"env_file",children:[]},{value:"environment",id:"environment",children:[]},{value:"expose",id:"expose",children:[]},{value:"extra_hosts",id:"extra_hosts",children:[]},{value:"healthcheck",id:"healthcheck",children:[]},{value:"image",id:"image",children:[]},{value:"logging",id:"logging",children:[]},{value:"network_mode",id:"network_mode",children:[]},{value:"restart",id:"restart",children:[]},{value:"secrets",id:"secrets",children:[]},{value:"security_opt",id:"security_opt",children:[]},{value:"stop_grace_period",id:"stop_grace_period",children:[]},{value:"stop_signal",id:"stop_signal",children:[]},{value:"sysctls",id:"sysctls",children:[]},{value:"tmpfs",id:"tmpfs",children:[]},{value:"ulimits",id:"ulimits",children:[]},{value:"volumes",id:"volumes",children:[]}]}],d={toc:s};function c(e){var n=e.components,t=(0,l.Z)(e,a);return(0,o.kt)("wrapper",(0,r.Z)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"\u7528\u4e8e\u5b9a\u4e49\u548c\u8fd0\u884c\u591a\u5bb9\u5668 Docker \u5e94\u7528\u7a0b\u5e8f\u7684\u5de5\u5177"),(0,o.kt)("h2",{id:"compose-\u5b89\u88c5"},"Compose \u5b89\u88c5"),(0,o.kt)("p",null,"\u6700\u65b0\u53d1\u884c\u7248 ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/docker/compose/releases"},"https://github.com/docker/compose/releases")),(0,o.kt)("h2",{id:"\u6307\u4ee4"},"\u6307\u4ee4"),(0,o.kt)("h3",{id:"version"},"version"),(0,o.kt)("p",null,"\u6307\u5b9a\u672c yml \u4f9d\u4ece\u7684 compose \u54ea\u4e2a\u7248\u672c\u5236\u5b9a\u7684\u3002"),(0,o.kt)("h3",{id:"build"},"build"),(0,o.kt)("p",null,"\u6307\u5b9a\u4e3a\u6784\u5efa\u955c\u50cf\u4e0a\u4e0b\u6587\u8def\u5f84\uff1a"),(0,o.kt)("p",null,"\u4f8b\u5982 webapp \u670d\u52a1\uff0c\u6307\u5b9a\u4e3a\u4ece\u4e0a\u4e0b\u6587\u8def\u5f84 ./dir/Dockerfile \u6240\u6784\u5efa\u7684\u955c\u50cf\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'version: "3.7"\nservices:\n  webapp:\n    build: ./dir\n')),(0,o.kt)("p",null,"\u6216\u8005\uff0c\u4f5c\u4e3a\u5177\u6709\u5728\u4e0a\u4e0b\u6587\u6307\u5b9a\u7684\u8def\u5f84\u7684\u5bf9\u8c61\uff0c\u4ee5\u53ca\u53ef\u9009\u7684 Dockerfile \u548c args\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'version: "3.7"\nservices:\n  webapp:\n    build:\n      context: ./dir\n      dockerfile: Dockerfile-alternate\n      args:\n        buildno: 1\n      labels:\n        - "com.example.description=Accounting webapp"\n        - "com.example.department=Finance"\n        - "com.example.label-with-empty-value"\n      target: prod\n')),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"context\uff1a\u4e0a\u4e0b\u6587\u8def\u5f84\u3002"),(0,o.kt)("li",{parentName:"ul"},"dockerfile\uff1a\u6307\u5b9a\u6784\u5efa\u955c\u50cf\u7684 Dockerfile \u6587\u4ef6\u540d\u3002"),(0,o.kt)("li",{parentName:"ul"},"args\uff1a\u6dfb\u52a0\u6784\u5efa\u53c2\u6570\uff0c\u8fd9\u662f\u53ea\u80fd\u5728\u6784\u5efa\u8fc7\u7a0b\u4e2d\u8bbf\u95ee\u7684\u73af\u5883\u53d8\u91cf\u3002"),(0,o.kt)("li",{parentName:"ul"},"labels\uff1a\u8bbe\u7f6e\u6784\u5efa\u955c\u50cf\u7684\u6807\u7b7e\u3002"),(0,o.kt)("li",{parentName:"ul"},"target\uff1a\u591a\u5c42\u6784\u5efa\uff0c\u53ef\u4ee5\u6307\u5b9a\u6784\u5efa\u54ea\u4e00\u5c42\u3002")),(0,o.kt)("h3",{id:"cap_add\uff0ccap_drop"},"cap_add\uff0ccap_drop"),(0,o.kt)("p",null,"\u6dfb\u52a0\u6216\u5220\u9664\u5bb9\u5668\u62e5\u6709\u7684\u5bbf\u4e3b\u673a\u7684\u5185\u6838\u529f\u80fd\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"cap_add:\n  - ALL # \u5f00\u542f\u5168\u90e8\u6743\u9650\n\ncap_drop:\n  - SYS_PTRACE # \u5173\u95ed ptrace\u6743\u9650\n")),(0,o.kt)("h3",{id:"cgroup_parent"},"cgroup_parent"),(0,o.kt)("p",null,"\u4e3a\u5bb9\u5668\u6307\u5b9a\u7236 cgroup \u7ec4\uff0c\u610f\u5473\u7740\u5c06\u7ee7\u627f\u8be5\u7ec4\u7684\u8d44\u6e90\u9650\u5236\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"cgroup_parent: m-executor-abcd\n")),(0,o.kt)("h3",{id:"command"},"command"),(0,o.kt)("p",null,"\u8986\u76d6\u5bb9\u5668\u542f\u52a8\u7684\u9ed8\u8ba4\u547d\u4ee4\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'command: ["bundle", "exec", "thin", "-p", "3000"]\n')),(0,o.kt)("h3",{id:"container_name"},"container_name"),(0,o.kt)("p",null,"\u6307\u5b9a\u81ea\u5b9a\u4e49\u5bb9\u5668\u540d\u79f0\uff0c\u800c\u4e0d\u662f\u751f\u6210\u7684\u9ed8\u8ba4\u540d\u79f0\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"container_name: my-web-container\n")),(0,o.kt)("h3",{id:"depends_on"},"depends_on"),(0,o.kt)("p",null,"\u8bbe\u7f6e\u4f9d\u8d56\u5173\u7cfb\u3002"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"docker-compose up \uff1a\u4ee5\u4f9d\u8d56\u6027\u987a\u5e8f\u542f\u52a8\u670d\u52a1\u3002\u5728\u4ee5\u4e0b\u793a\u4f8b\u4e2d\uff0c\u5148\u542f\u52a8 db \u548c redis \uff0c\u624d\u4f1a\u542f\u52a8 web\u3002"),(0,o.kt)("li",{parentName:"ul"},"docker-compose up SERVICE \uff1a\u81ea\u52a8\u5305\u542b SERVICE \u7684\u4f9d\u8d56\u9879\u3002\u5728\u4ee5\u4e0b\u793a\u4f8b\u4e2d\uff0cdocker-compose up web \u8fd8\u5c06\u521b\u5efa\u5e76\u542f\u52a8 db \u548c redis\u3002"),(0,o.kt)("li",{parentName:"ul"},"docker-compose stop \uff1a\u6309\u4f9d\u8d56\u5173\u7cfb\u987a\u5e8f\u505c\u6b62\u670d\u52a1\u3002\u5728\u4ee5\u4e0b\u793a\u4f8b\u4e2d\uff0cweb \u5728 db \u548c redis \u4e4b\u524d\u505c\u6b62\u3002")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'version: "3.7"\nservices:\n  web:\n    build: .\n    depends_on:\n      - db\n      - redis\n  redis:\n    image: redis\n  db:\n    image: postgres\n')),(0,o.kt)("p",null,"\u6ce8\u610f\uff1aweb \u670d\u52a1\u4e0d\u4f1a\u7b49\u5f85 redis db \u5b8c\u5168\u542f\u52a8 \u4e4b\u540e\u624d\u542f\u52a8\u3002"),(0,o.kt)("h3",{id:"deploy"},"deploy"),(0,o.kt)("p",null,"\u6307\u5b9a\u4e0e\u670d\u52a1\u7684\u90e8\u7f72\u548c\u8fd0\u884c\u6709\u5173\u7684\u914d\u7f6e\u3002\u53ea\u5728 swarm \u6a21\u5f0f\u4e0b\u624d\u4f1a\u6709\u7528\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"version: \"3.7\"\nservices:\n  redis:\n    image: redis:alpine\n    deploy:\n      mode\uff1areplicated\n      replicas: 6\n      endpoint_mode: dnsrr\n      labels: \n        description: \"This redis service label\"\n      resources:\n        limits:\n          cpus: '0.50'\n          memory: 50M\n        reservations:\n          cpus: '0.25'\n          memory: 20M\n      restart_policy:\n        condition: on-failure\n        delay: 5s\n        max_attempts: 3\n        window: 120s\n")),(0,o.kt)("p",null,"\u53ef\u4ee5\u9009\u53c2\u6570\uff1a"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"endpoint_mode"),"\uff1a\u8bbf\u95ee\u96c6\u7fa4\u670d\u52a1\u7684\u65b9\u5f0f\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"endpoint_mode: vip \n# Docker \u96c6\u7fa4\u670d\u52a1\u4e00\u4e2a\u5bf9\u5916\u7684\u865a\u62df ip\u3002\u6240\u6709\u7684\u8bf7\u6c42\u90fd\u4f1a\u901a\u8fc7\u8fd9\u4e2a\u865a\u62df ip \u5230\u8fbe\u96c6\u7fa4\u670d\u52a1\u5185\u90e8\u7684\u673a\u5668\u3002\nendpoint_mode: dnsrr\n# DNS \u8f6e\u8be2\uff08DNSRR\uff09\u3002\u6240\u6709\u7684\u8bf7\u6c42\u4f1a\u81ea\u52a8\u8f6e\u8be2\u83b7\u53d6\u5230\u96c6\u7fa4 ip \u5217\u8868\u4e2d\u7684\u4e00\u4e2a ip \u5730\u5740\u3002\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"labels"),"\uff1a\u5728\u670d\u52a1\u4e0a\u8bbe\u7f6e\u6807\u7b7e\u3002\u53ef\u4ee5\u7528\u5bb9\u5668\u4e0a\u7684 labels\uff08\u8ddf deploy \u540c\u7ea7\u7684\u914d\u7f6e\uff09 \u8986\u76d6 deploy \u4e0b\u7684 labels\u3002"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"mode"),"\uff1a\u6307\u5b9a\u670d\u52a1\u63d0\u4f9b\u7684\u6a21\u5f0f\u3002"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("strong",{parentName:"p"},"replicated"),"\uff1a\u590d\u5236\u670d\u52a1\uff0c\u590d\u5236\u6307\u5b9a\u670d\u52a1\u5230\u96c6\u7fa4\u7684\u673a\u5668\u4e0a\u3002")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("strong",{parentName:"p"},"global"),"\uff1a\u5168\u5c40\u670d\u52a1\uff0c\u670d\u52a1\u5c06\u90e8\u7f72\u81f3\u96c6\u7fa4\u7684\u6bcf\u4e2a\u8282\u70b9\u3002")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"\u56fe\u89e3\uff1a\u4e0b\u56fe\u4e2d\u9ec4\u8272\u7684\u65b9\u5757\u662f replicated \u6a21\u5f0f\u7684\u8fd0\u884c\u60c5\u51b5\uff0c\u7070\u8272\u65b9\u5757\u662f global \u6a21\u5f0f\u7684\u8fd0\u884c\u60c5\u51b5\u3002"),(0,o.kt)("p",{parentName:"li"},(0,o.kt)("img",{parentName:"p",src:"https://www.runoob.com/wp-content/uploads/2019/11/docker-composex.png",alt:"img"})))),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"replicas\uff1amode")," \u4e3a replicated \u65f6\uff0c\u9700\u8981\u4f7f\u7528\u6b64\u53c2\u6570\u914d\u7f6e\u5177\u4f53\u8fd0\u884c\u7684\u8282\u70b9\u6570\u91cf\u3002"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"resources"),"\uff1a\u914d\u7f6e\u670d\u52a1\u5668\u8d44\u6e90\u4f7f\u7528\u7684\u9650\u5236\uff0c\u4f8b\u5982\u4e0a\u4f8b\u5b50\uff0c\u914d\u7f6e redis \u96c6\u7fa4\u8fd0\u884c\u9700\u8981\u7684 cpu \u7684\u767e\u5206\u6bd4 \u548c \u5185\u5b58\u7684\u5360\u7528\u3002\u907f\u514d\u5360\u7528\u8d44\u6e90\u8fc7\u9ad8\u51fa\u73b0\u5f02\u5e38\u3002"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"restart_policy"),"\uff1a\u914d\u7f6e\u5982\u4f55\u5728\u9000\u51fa\u5bb9\u5668\u65f6\u91cd\u65b0\u542f\u52a8\u5bb9\u5668\u3002"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"condition\uff1a\u53ef\u9009 none\uff0con-failure \u6216\u8005 any\uff08\u9ed8\u8ba4\u503c\uff1aany\uff09\u3002"),(0,o.kt)("li",{parentName:"ul"},"delay\uff1a\u8bbe\u7f6e\u591a\u4e45\u4e4b\u540e\u91cd\u542f\uff08\u9ed8\u8ba4\u503c\uff1a0\uff09\u3002"),(0,o.kt)("li",{parentName:"ul"},"max_attempts\uff1a\u5c1d\u8bd5\u91cd\u65b0\u542f\u52a8\u5bb9\u5668\u7684\u6b21\u6570\uff0c\u8d85\u51fa\u6b21\u6570\uff0c\u5219\u4e0d\u518d\u5c1d\u8bd5\uff08\u9ed8\u8ba4\u503c\uff1a\u4e00\u76f4\u91cd\u8bd5\uff09\u3002"),(0,o.kt)("li",{parentName:"ul"},"window\uff1a\u8bbe\u7f6e\u5bb9\u5668\u91cd\u542f\u8d85\u65f6\u65f6\u95f4\uff08\u9ed8\u8ba4\u503c\uff1a0\uff09\u3002")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"rollback_config"),"\uff1a\u914d\u7f6e\u5728\u66f4\u65b0\u5931\u8d25\u7684\u60c5\u51b5\u4e0b\u5e94\u5982\u4f55\u56de\u6eda\u670d\u52a1\u3002"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"parallelism\uff1a\u4e00\u6b21\u8981\u56de\u6eda\u7684\u5bb9\u5668\u6570\u3002\u5982\u679c\u8bbe\u7f6e\u4e3a0\uff0c\u5219\u6240\u6709\u5bb9\u5668\u5c06\u540c\u65f6\u56de\u6eda\u3002"),(0,o.kt)("li",{parentName:"ul"},"delay\uff1a\u6bcf\u4e2a\u5bb9\u5668\u7ec4\u56de\u6eda\u4e4b\u95f4\u7b49\u5f85\u7684\u65f6\u95f4\uff08\u9ed8\u8ba4\u4e3a0s\uff09\u3002"),(0,o.kt)("li",{parentName:"ul"},"failure_action\uff1a\u5982\u679c\u56de\u6eda\u5931\u8d25\uff0c\u8be5\u600e\u4e48\u529e\u3002\u5176\u4e2d\u4e00\u4e2a continue \u6216\u8005 pause\uff08\u9ed8\u8ba4pause\uff09\u3002"),(0,o.kt)("li",{parentName:"ul"},"monitor\uff1a\u6bcf\u4e2a\u5bb9\u5668\u66f4\u65b0\u540e\uff0c\u6301\u7eed\u89c2\u5bdf\u662f\u5426\u5931\u8d25\u4e86\u7684\u65f6\u95f4 (ns|us|ms|s|m|h)\uff08\u9ed8\u8ba4\u4e3a0s\uff09\u3002"),(0,o.kt)("li",{parentName:"ul"},"max_failure_ratio\uff1a\u5728\u56de\u6eda\u671f\u95f4\u53ef\u4ee5\u5bb9\u5fcd\u7684\u6545\u969c\u7387\uff08\u9ed8\u8ba4\u4e3a0\uff09\u3002"),(0,o.kt)("li",{parentName:"ul"},"order\uff1a\u56de\u6eda\u671f\u95f4\u7684\u64cd\u4f5c\u987a\u5e8f\u3002\u5176\u4e2d\u4e00\u4e2a stop-first\uff08\u4e32\u884c\u56de\u6eda\uff09\uff0c\u6216\u8005 start-first\uff08\u5e76\u884c\u56de\u6eda\uff09\uff08\u9ed8\u8ba4 stop-first \uff09\u3002")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"update_config"),"\uff1a\u914d\u7f6e\u5e94\u5982\u4f55\u66f4\u65b0\u670d\u52a1\uff0c\u5bf9\u4e8e\u914d\u7f6e\u6eda\u52a8\u66f4\u65b0\u5f88\u6709\u7528\u3002"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"parallelism\uff1a\u4e00\u6b21\u66f4\u65b0\u7684\u5bb9\u5668\u6570\u3002"),(0,o.kt)("li",{parentName:"ul"},"delay\uff1a\u5728\u66f4\u65b0\u4e00\u7ec4\u5bb9\u5668\u4e4b\u95f4\u7b49\u5f85\u7684\u65f6\u95f4\u3002"),(0,o.kt)("li",{parentName:"ul"},"failure_action\uff1a\u5982\u679c\u66f4\u65b0\u5931\u8d25\uff0c\u8be5\u600e\u4e48\u529e\u3002\u5176\u4e2d\u4e00\u4e2a continue\uff0crollback \u6216\u8005pause \uff08\u9ed8\u8ba4\uff1apause\uff09\u3002"),(0,o.kt)("li",{parentName:"ul"},"monitor\uff1a\u6bcf\u4e2a\u5bb9\u5668\u66f4\u65b0\u540e\uff0c\u6301\u7eed\u89c2\u5bdf\u662f\u5426\u5931\u8d25\u4e86\u7684\u65f6\u95f4 (ns|us|ms|s|m|h)\uff08\u9ed8\u8ba4\u4e3a0s\uff09\u3002"),(0,o.kt)("li",{parentName:"ul"},"max_failure_ratio\uff1a\u5728\u66f4\u65b0\u8fc7\u7a0b\u4e2d\u53ef\u4ee5\u5bb9\u5fcd\u7684\u6545\u969c\u7387\u3002"),(0,o.kt)("li",{parentName:"ul"},"order\uff1a\u56de\u6eda\u671f\u95f4\u7684\u64cd\u4f5c\u987a\u5e8f\u3002\u5176\u4e2d\u4e00\u4e2a stop-first\uff08\u4e32\u884c\u56de\u6eda\uff09\uff0c\u6216\u8005 start-first\uff08\u5e76\u884c\u56de\u6eda\uff09\uff08\u9ed8\u8ba4stop-first\uff09\u3002")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"\u6ce8"),"\uff1a\u4ec5\u652f\u6301 V3.4 \u53ca\u66f4\u9ad8\u7248\u672c\u3002"),(0,o.kt)("h3",{id:"devices"},"devices"),(0,o.kt)("p",null,"\u6307\u5b9a\u8bbe\u5907\u6620\u5c04\u5217\u8868\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'devices:\n  - "/dev/ttyUSB0:/dev/ttyUSB0"\n')),(0,o.kt)("h3",{id:"dns"},"dns"),(0,o.kt)("p",null,"\u81ea\u5b9a\u4e49 DNS \u670d\u52a1\u5668\uff0c\u53ef\u4ee5\u662f\u5355\u4e2a\u503c\u6216\u5217\u8868\u7684\u591a\u4e2a\u503c\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"dns: 8.8.8.8\n\ndns:\n  - 8.8.8.8\n  - 9.9.9.9\n")),(0,o.kt)("h3",{id:"dns_search"},"dns_search"),(0,o.kt)("p",null,"\u81ea\u5b9a\u4e49 DNS \u641c\u7d22\u57df\u3002\u53ef\u4ee5\u662f\u5355\u4e2a\u503c\u6216\u5217\u8868\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"dns_search: example.com\n\ndns_search:\n  - dc1.example.com\n  - dc2.example.com\n")),(0,o.kt)("h3",{id:"entrypoint"},"entrypoint"),(0,o.kt)("p",null,"\u8986\u76d6\u5bb9\u5668\u9ed8\u8ba4\u7684 entrypoint\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"entrypoint: /code/entrypoint.sh\n")),(0,o.kt)("p",null,"\u4e5f\u53ef\u4ee5\u662f\u4ee5\u4e0b\u683c\u5f0f\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"entrypoint:\n    - php\n    - -d\n    - zend_extension=/usr/local/lib/php/extensions/no-debug-non-zts-20100525/xdebug.so\n    - -d\n    - memory_limit=-1\n    - vendor/bin/phpunit\n")),(0,o.kt)("h3",{id:"env_file"},"env_file"),(0,o.kt)("p",null,"\u4ece\u6587\u4ef6\u6dfb\u52a0\u73af\u5883\u53d8\u91cf\u3002\u53ef\u4ee5\u662f\u5355\u4e2a\u503c\u6216\u5217\u8868\u7684\u591a\u4e2a\u503c\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"env_file: .env\n")),(0,o.kt)("p",null,"\u4e5f\u53ef\u4ee5\u662f\u5217\u8868\u683c\u5f0f\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"env_file:\n  - ./common.env\n  - ./apps/web.env\n  - /opt/secrets.env\n")),(0,o.kt)("h3",{id:"environment"},"environment"),(0,o.kt)("p",null,"\u6dfb\u52a0\u73af\u5883\u53d8\u91cf\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u6570\u7ec4\u6216\u5b57\u5178\u3001\u4efb\u4f55\u5e03\u5c14\u503c\uff0c\u5e03\u5c14\u503c\u9700\u8981\u7528\u5f15\u53f7\u5f15\u8d77\u6765\uff0c\u4ee5\u786e\u4fdd YML \u89e3\u6790\u5668\u4e0d\u4f1a\u5c06\u5176\u8f6c\u6362\u4e3a True \u6216 False\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"environment:\n  RACK_ENV: development\n  SHOW: 'true'\n")),(0,o.kt)("h3",{id:"expose"},"expose"),(0,o.kt)("p",null,"\u66b4\u9732\u7aef\u53e3\uff0c\u4f46\u4e0d\u6620\u5c04\u5230\u5bbf\u4e3b\u673a\uff0c\u53ea\u88ab\u8fde\u63a5\u7684\u670d\u52a1\u8bbf\u95ee\u3002"),(0,o.kt)("p",null,"\u4ec5\u53ef\u4ee5\u6307\u5b9a\u5185\u90e8\u7aef\u53e3\u4e3a\u53c2\u6570\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'expose:\n - "3000"\n - "8000"\n')),(0,o.kt)("h3",{id:"extra_hosts"},"extra_hosts"),(0,o.kt)("p",null,"\u6dfb\u52a0\u4e3b\u673a\u540d\u6620\u5c04\u3002\u7c7b\u4f3c docker client --add-host\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'extra_hosts:\n - "somehost:162.242.195.82"\n - "otherhost:50.31.209.229"\n')),(0,o.kt)("p",null,"\u4ee5\u4e0a\u4f1a\u5728\u6b64\u670d\u52a1\u7684\u5185\u90e8\u5bb9\u5668\u4e2d /etc/hosts \u521b\u5efa\u4e00\u4e2a\u5177\u6709 ip \u5730\u5740\u548c\u4e3b\u673a\u540d\u7684\u6620\u5c04\u5173\u7cfb\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"162.242.195.82  somehost\n50.31.209.229   otherhost\n")),(0,o.kt)("h3",{id:"healthcheck"},"healthcheck"),(0,o.kt)("p",null,"\u7528\u4e8e\u68c0\u6d4b docker \u670d\u52a1\u662f\u5426\u5065\u5eb7\u8fd0\u884c\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'healthcheck:\n  test: ["CMD", "curl", "-f", "http://localhost"] # \u8bbe\u7f6e\u68c0\u6d4b\u7a0b\u5e8f\n  interval: 1m30s # \u8bbe\u7f6e\u68c0\u6d4b\u95f4\u9694\n  timeout: 10s # \u8bbe\u7f6e\u68c0\u6d4b\u8d85\u65f6\u65f6\u95f4\n  retries: 3 # \u8bbe\u7f6e\u91cd\u8bd5\u6b21\u6570\n  start_period: 40s # \u542f\u52a8\u540e\uff0c\u591a\u5c11\u79d2\u5f00\u59cb\u542f\u52a8\u68c0\u6d4b\u7a0b\u5e8f\n')),(0,o.kt)("h3",{id:"image"},"image"),(0,o.kt)("p",null,"\u6307\u5b9a\u5bb9\u5668\u8fd0\u884c\u7684\u955c\u50cf\u3002\u4ee5\u4e0b\u683c\u5f0f\u90fd\u53ef\u4ee5\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"image: redis\nimage: ubuntu:14.04\nimage: tutum/influxdb\nimage: example-registry.com:4000/postgresql\nimage: a4bc65fd # \u955c\u50cfid\n")),(0,o.kt)("h3",{id:"logging"},"logging"),(0,o.kt)("p",null,"\u670d\u52a1\u7684\u65e5\u5fd7\u8bb0\u5f55\u914d\u7f6e\u3002"),(0,o.kt)("p",null,"driver\uff1a\u6307\u5b9a\u670d\u52a1\u5bb9\u5668\u7684\u65e5\u5fd7\u8bb0\u5f55\u9a71\u52a8\u7a0b\u5e8f\uff0c\u9ed8\u8ba4\u503c\u4e3ajson-file\u3002\u6709\u4ee5\u4e0b\u4e09\u4e2a\u9009\u9879"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'driver: "json-file"\ndriver: "syslog"\ndriver: "none"\n')),(0,o.kt)("p",null,"\u4ec5\u5728 json-file \u9a71\u52a8\u7a0b\u5e8f\u4e0b\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u53c2\u6570\uff0c\u9650\u5236\u65e5\u5fd7\u5f97\u6570\u91cf\u548c\u5927\u5c0f\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'logging:\n  driver: json-file\n  options:\n    max-size: "200k" # \u5355\u4e2a\u6587\u4ef6\u5927\u5c0f\u4e3a200k\n    max-file: "10" # \u6700\u591a10\u4e2a\u6587\u4ef6\n')),(0,o.kt)("p",null,"\u5f53\u8fbe\u5230\u6587\u4ef6\u9650\u5236\u4e0a\u9650\uff0c\u4f1a\u81ea\u52a8\u5220\u9664\u65e7\u5f97\u6587\u4ef6\u3002"),(0,o.kt)("p",null,"syslog \u9a71\u52a8\u7a0b\u5e8f\u4e0b\uff0c\u53ef\u4ee5\u4f7f\u7528 syslog-address \u6307\u5b9a\u65e5\u5fd7\u63a5\u6536\u5730\u5740\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'logging:\n  driver: syslog\n  options:\n    syslog-address: "tcp://192.168.0.42:123"\n')),(0,o.kt)("h3",{id:"network_mode"},"network_mode"),(0,o.kt)("p",null,"\u8bbe\u7f6e\u7f51\u7edc\u6a21\u5f0f\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'network_mode: "bridge"\nnetwork_mode: "host"\nnetwork_mode: "none"\nnetwork_mode: "service:[service name]"\nnetwork_mode: "container:[container name/id]"\n')),(0,o.kt)("p",null,"networks"),(0,o.kt)("p",null,"\u914d\u7f6e\u5bb9\u5668\u8fde\u63a5\u7684\u7f51\u7edc\uff0c\u5f15\u7528\u9876\u7ea7 networks \u4e0b\u7684\u6761\u76ee \u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"services:\n  some-service:\n    networks:\n      some-network:\n        aliases:\n         - alias1\n      other-network:\n        aliases:\n         - alias2\nnetworks:\n  some-network:\n    # Use a custom driver\n    driver: custom-driver-1\n  other-network:\n    # Use a custom driver which takes special options\n    driver: custom-driver-2\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"aliases")," \uff1a\u540c\u4e00\u7f51\u7edc\u4e0a\u7684\u5176\u4ed6\u5bb9\u5668\u53ef\u4ee5\u4f7f\u7528\u670d\u52a1\u540d\u79f0\u6216\u6b64\u522b\u540d\u6765\u8fde\u63a5\u5230\u5bf9\u5e94\u5bb9\u5668\u7684\u670d\u52a1\u3002"),(0,o.kt)("h3",{id:"restart"},"restart"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"no\uff1a\u662f\u9ed8\u8ba4\u7684\u91cd\u542f\u7b56\u7565\uff0c\u5728\u4efb\u4f55\u60c5\u51b5\u4e0b\u90fd\u4e0d\u4f1a\u91cd\u542f\u5bb9\u5668\u3002"),(0,o.kt)("li",{parentName:"ul"},"always\uff1a\u5bb9\u5668\u603b\u662f\u91cd\u65b0\u542f\u52a8\u3002"),(0,o.kt)("li",{parentName:"ul"},"on-failure\uff1a\u5728\u5bb9\u5668\u975e\u6b63\u5e38\u9000\u51fa\u65f6\uff08\u9000\u51fa\u72b6\u6001\u975e0\uff09\uff0c\u624d\u4f1a\u91cd\u542f\u5bb9\u5668\u3002"),(0,o.kt)("li",{parentName:"ul"},"unless-stopped\uff1a\u5728\u5bb9\u5668\u9000\u51fa\u65f6\u603b\u662f\u91cd\u542f\u5bb9\u5668\uff0c\u4f46\u662f\u4e0d\u8003\u8651\u5728Docker\u5b88\u62a4\u8fdb\u7a0b\u542f\u52a8\u65f6\u5c31\u5df2\u7ecf\u505c\u6b62\u4e86\u7684\u5bb9\u5668")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'restart: "no"\nrestart: always\nrestart: on-failure\nrestart: unless-stopped\n')),(0,o.kt)("p",null,"\u6ce8\uff1aswarm \u96c6\u7fa4\u6a21\u5f0f\uff0c\u8bf7\u6539\u7528 restart_policy\u3002"),(0,o.kt)("h3",{id:"secrets"},"secrets"),(0,o.kt)("p",null,"\u5b58\u50a8\u654f\u611f\u6570\u636e\uff0c\u4f8b\u5982\u5bc6\u7801\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'version: "3.1"\nservices:\n\nmysql:\n  image: mysql\n  environment:\n    MYSQL_ROOT_PASSWORD_FILE: /run/secrets/my_secret\n  secrets:\n    - my_secret\n\nsecrets:\n  my_secret:\n    file: ./my_secret.txt\n')),(0,o.kt)("h3",{id:"security_opt"},"security_opt"),(0,o.kt)("p",null,"\u4fee\u6539\u5bb9\u5668\u9ed8\u8ba4\u7684 schema \u6807\u7b7e\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"security-opt\uff1a\n  - label:user:USER   # \u8bbe\u7f6e\u5bb9\u5668\u7684\u7528\u6237\u6807\u7b7e\n  - label:role:ROLE   # \u8bbe\u7f6e\u5bb9\u5668\u7684\u89d2\u8272\u6807\u7b7e\n  - label:type:TYPE   # \u8bbe\u7f6e\u5bb9\u5668\u7684\u5b89\u5168\u7b56\u7565\u6807\u7b7e\n  - label:level:LEVEL  # \u8bbe\u7f6e\u5bb9\u5668\u7684\u5b89\u5168\u7b49\u7ea7\u6807\u7b7e\n")),(0,o.kt)("h3",{id:"stop_grace_period"},"stop_grace_period"),(0,o.kt)("p",null,"\u6307\u5b9a\u5728\u5bb9\u5668\u65e0\u6cd5\u5904\u7406 SIGTERM (\u6216\u8005\u4efb\u4f55 stop_signal \u7684\u4fe1\u53f7)\uff0c\u7b49\u5f85\u591a\u4e45\u540e\u53d1\u9001 SIGKILL \u4fe1\u53f7\u5173\u95ed\u5bb9\u5668\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"stop_grace_period: 1s # \u7b49\u5f85 1 \u79d2\nstop_grace_period: 1m30s # \u7b49\u5f85 1 \u5206 30 \u79d2 \n")),(0,o.kt)("p",null,"\u9ed8\u8ba4\u7684\u7b49\u5f85\u65f6\u95f4\u662f 10 \u79d2\u3002"),(0,o.kt)("h3",{id:"stop_signal"},"stop_signal"),(0,o.kt)("p",null,"\u8bbe\u7f6e\u505c\u6b62\u5bb9\u5668\u7684\u66ff\u4ee3\u4fe1\u53f7\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u4f7f\u7528 SIGTERM \u3002"),(0,o.kt)("p",null,"\u4ee5\u4e0b\u793a\u4f8b\uff0c\u4f7f\u7528 SIGUSR1 \u66ff\u4ee3\u4fe1\u53f7 SIGTERM \u6765\u505c\u6b62\u5bb9\u5668\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"stop_signal: SIGUSR1\n")),(0,o.kt)("h3",{id:"sysctls"},"sysctls"),(0,o.kt)("p",null,"\u8bbe\u7f6e\u5bb9\u5668\u4e2d\u7684\u5185\u6838\u53c2\u6570\uff0c\u53ef\u4ee5\u4f7f\u7528\u6570\u7ec4\u6216\u5b57\u5178\u683c\u5f0f\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"sysctls:\n  net.core.somaxconn: 1024\n  net.ipv4.tcp_syncookies: 0\n\nsysctls:\n  - net.core.somaxconn=1024\n  - net.ipv4.tcp_syncookies=0\n")),(0,o.kt)("h3",{id:"tmpfs"},"tmpfs"),(0,o.kt)("p",null,"\u5728\u5bb9\u5668\u5185\u5b89\u88c5\u4e00\u4e2a\u4e34\u65f6\u6587\u4ef6\u7cfb\u7edf\u3002\u53ef\u4ee5\u662f\u5355\u4e2a\u503c\u6216\u5217\u8868\u7684\u591a\u4e2a\u503c\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"tmpfs: /run\n\ntmpfs:\n  - /run\n  - /tmp\n")),(0,o.kt)("h3",{id:"ulimits"},"ulimits"),(0,o.kt)("p",null,"\u8986\u76d6\u5bb9\u5668\u9ed8\u8ba4\u7684 ulimit\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"ulimits:\n  nproc: 65535\n  nofile:\n    soft: 20000\n    hard: 40000\n")),(0,o.kt)("h3",{id:"volumes"},"volumes"),(0,o.kt)("p",null,"\u5c06\u4e3b\u673a\u7684\u6570\u636e\u5377\u6216\u7740\u6587\u4ef6\u6302\u8f7d\u5230\u5bb9\u5668\u91cc\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'version: "3.7"\nservices:\n  db:\n    image: postgres:latest\n    volumes:\n      - "/localhost/postgres.sock:/var/run/postgres/postgres.sock"\n      - "/localhost/data:/var/lib/postgresql/data"\n')))}c.isMDXComponent=!0}}]);