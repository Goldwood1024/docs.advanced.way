<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.72">
<link rel="alternate" type="application/rss+xml" href="/docs.advanced.way/blog/rss.xml" title="进阶之路 Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/docs.advanced.way/blog/atom.xml" title="进阶之路 Blog Atom Feed"><title data-react-helmet="true">线程池 | 进阶之路</title><meta data-react-helmet="true" property="og:url" content="https://Goldwood1024.github.io/docs.advanced.way/docs/java/hc/线程池"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="线程池 | 进阶之路"><meta data-react-helmet="true" name="description" content="线程池简介"><meta data-react-helmet="true" property="og:description" content="线程池简介"><link data-react-helmet="true" rel="shortcut icon" href="/docs.advanced.way/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://Goldwood1024.github.io/docs.advanced.way/docs/java/hc/线程池"><link data-react-helmet="true" rel="alternate" href="https://Goldwood1024.github.io/docs.advanced.way/docs/java/hc/线程池" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://Goldwood1024.github.io/docs.advanced.way/docs/java/hc/线程池" hreflang="x-default"><link rel="stylesheet" href="/docs.advanced.way/assets/css/styles.1814d5b2.css">
<link rel="preload" href="/docs.advanced.way/assets/js/styles.d2979f79.js" as="script">
<link rel="preload" href="/docs.advanced.way/assets/js/runtime~main.c79be437.js" as="script">
<link rel="preload" href="/docs.advanced.way/assets/js/main.a0c081f8.js" as="script">
<link rel="preload" href="/docs.advanced.way/assets/js/1.68ccfdd8.js" as="script">
<link rel="preload" href="/docs.advanced.way/assets/js/2.0ae89a79.js" as="script">
<link rel="preload" href="/docs.advanced.way/assets/js/3.ef70b8bc.js" as="script">
<link rel="preload" href="/docs.advanced.way/assets/js/1be78505.8900d4c5.js" as="script">
<link rel="preload" href="/docs.advanced.way/assets/js/202.499d5c45.js" as="script">
<link rel="preload" href="/docs.advanced.way/assets/js/935f2afb.410f6dda.js" as="script">
<link rel="preload" href="/docs.advanced.way/assets/js/17896441.a99ce0cd.js" as="script">
<link rel="preload" href="/docs.advanced.way/assets/js/6424d8c8.473276fb.js" as="script">
</head>
<body>
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_2qcr"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/docs.advanced.way/"><img src="/docs.advanced.way/img/logo.svg" alt="进阶之路 Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/docs.advanced.way/img/logo.svg" alt="进阶之路 Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">进阶之路</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.advanced.way/docs/java/">Java</a><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link">常用框架</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs.advanced.way/docs/framework/spring/">常用框架</a></li><li><a class="dropdown__link" href="/docs.advanced.way/docs/framework/mybatis/">Mybatis</a></li><li><a class="dropdown__link" href="/docs.advanced.way/docs/framework/auth/auth">权限管理</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link">中间件</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs.advanced.way/docs/distributed/">分布式</a></li><li><a class="dropdown__link" href="/docs.advanced.way/docs/tranctional/">事务</a></li><li><a class="dropdown__link" href="/docs.advanced.way/docs/mq/">消息队列</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link">云原生</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs.advanced.way/docs/cloud/docker/base/镜像/">Docker容器</a></li><li><a class="dropdown__link" href="/docs.advanced.way/docs/k8s/">K8s</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link">服务器</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs.advanced.way/docs/linux/">Linux</a></li><li><a class="dropdown__link" href="/docs.advanced.way/docs/cache/">缓存</a></li><li><a class="dropdown__link" href="/docs.advanced.way/docs/db/mysql/InnoDB/">数据库</a></li><li><a class="dropdown__link" href="/docs.advanced.way/docs/cs/network/tcpip/">计算机系统</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link">编码实践</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs.advanced.way/docs/algorithm/algorithm/">算法/数据结构</a></li><li><a class="dropdown__link" href="/docs.advanced.way/docs/patterns/">设计模式</a></li><li><a class="dropdown__link" href="/docs.advanced.way/docs/architecture/">架构设计</a></li><li><a class="dropdown__link" href="/docs.advanced.way/docs/job/java/">面试</a></li><li><a class="dropdown__link" href="/docs.advanced.way/docs/memo/tool/sublime/">备忘</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link">小百科</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs.advanced.way/docs/cyclopedia/chinese/notes/dingding/">课堂笔记</a></li><li><a class="dropdown__link" href="/docs.advanced.way/docs/cyclopedia/chinese/lan/idiom/">大中国</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs.advanced.way/blog">博客</a><a href="https://github.com/Goldwood1024/docs.advanced.way.git" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_GrZ2"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">🌜</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">🌞</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/docs.advanced.way/"><img src="/docs.advanced.way/img/logo.svg" alt="进阶之路 Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/docs.advanced.way/img/logo.svg" alt="进阶之路 Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">进阶之路</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs.advanced.way/docs/java/">Java</a></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">常用框架</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/framework/spring/">常用框架</a></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/framework/mybatis/">Mybatis</a></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/framework/auth/auth">权限管理</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">中间件</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/distributed/">分布式</a></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/tranctional/">事务</a></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/mq/">消息队列</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">云原生</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/cloud/docker/base/镜像/">Docker容器</a></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/k8s/">K8s</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">服务器</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/linux/">Linux</a></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/cache/">缓存</a></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/db/mysql/InnoDB/">数据库</a></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/cs/network/tcpip/">计算机系统</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">编码实践</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/algorithm/algorithm/">算法/数据结构</a></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/patterns/">设计模式</a></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/architecture/">架构设计</a></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/job/java/">面试</a></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/memo/tool/sublime/">备忘</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">小百科</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/cyclopedia/chinese/notes/dingding/">课堂笔记</a></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/cyclopedia/chinese/lan/idiom/">大中国</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/blog">博客</a></li><li class="menu__list-item"><a href="https://github.com/Goldwood1024/docs.advanced.way.git" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper main-docs-wrapper"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo sidebarWithHideableNavbar_267A"><a tabindex="-1" class="sidebarLogo_3h0W" href="/docs.advanced.way/"><img src="/docs.advanced.way/img/logo.svg" alt="进阶之路 Logo" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/docs.advanced.way/img/logo.svg" alt="进阶之路 Logo" class="themedImage_1VuW themedImage--dark_hz6m"><strong>进阶之路</strong></a><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">基础</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/">简介</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/object">面向对象</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/数据类型">数据类型</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/关键字">关键字</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/String">String</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/io">I/O</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/nio">NIO</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/Reference">对象引用</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/代理">代理</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/函数式接口">函数式接口</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/反射">反射</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/base64">Base64编码</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/jdk">JDK</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">集合</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/collection/Collection">Collection</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/collection/List">List</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/collection/Map">Map</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">高并发</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs.advanced.way/docs/java/hc/高并发">高并发</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs.advanced.way/docs/java/hc/多线程">多线程</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs.advanced.way/docs/java/hc/并发编程的艺术">并发编程的艺术</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs.advanced.way/docs/java/hc/内存模型">内存模型</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs.advanced.way/docs/java/hc/原子类">原子类</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs.advanced.way/docs/java/hc/并发容器">并发容器</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs.advanced.way/docs/java/hc/并发工具类">并发工具类</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs.advanced.way/docs/java/hc/线程池">线程池</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs.advanced.way/docs/java/hc/锁">锁</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">JVM</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/jvm/对象创建过程">对象创建过程</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/jvm/对象回收机制">对象回收机制</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/jvm/jvm参数">JVM参数</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/jvm/jvm内存模型">内存模型</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/jvm/内存优化">内存优化</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/jvm/垃圾收集器">垃圾收集器</a></li></ul></li></ul></div><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_1CGd"><svg width="20" height="20" role="img" class="collapseSidebarButtonIcon_3E-R"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><header><h1 class="docTitle_3a4h">线程池</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="线程池简介"></a>线程池简介<a class="hash-link" href="#线程池简介" title="Direct link to heading">#</a></h2><p>在使用线程池之后，创建线程变成了从线程池获得空闲线程，关闭线程变成了向线程池归还线程。  </p><p>好处:</p><ul><li>降低资源消耗。通过重复利用已创建的线程降低线程创建和销毁造成的消耗。</li><li>提高响应速度。当任务到达时，任务可以不需要等到线程创建就能立即执行。</li><li>提高线程的可管理性。线程是稀缺资源，如果无限制的创建，不仅会消耗系统资源，还会降低系统的稳定性，使用线程池可以进行统一的分配，调优和监控。</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="executor-框架"></a>Executor 框架<a class="hash-link" href="#executor-框架" title="Direct link to heading">#</a></h3><p>java线程被一对一的映射成本地操作系统线程，操作系统会调度所有的线程并分配可用的CPU.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="架构图"></a>架构图<a class="hash-link" href="#架构图" title="Direct link to heading">#</a></h2><p><img src="/docs.advanced.way/assets/images/java-7-concurrent-executors-uml-class-diagram-example-5a060fcf244bf15c9a95fb91837c8677.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="核心类"></a>核心类<a class="hash-link" href="#核心类" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="executorclass"></a>Executor.class<a class="hash-link" href="#executorclass" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public interface Executor {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    void execute(Runnable command);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>是 <code>Executor</code> 框架的基础，将任务的提交和任务的执行分离开</p><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="executorserviceclass"></a>ExecutorService.class<a class="hash-link" href="#executorserviceclass" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public interface ExecutorService extends Executor {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    /**</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * 关闭执行器, 主要有以下特点:</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * 1. 已经提交给该执行器的任务将会继续执行, 但是不再接受新任务的提交;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * 2. 如果执行器已经关闭了, 则再次调用没有副作用.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     */</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    void shutdown();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    /**</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * 立即关闭执行器, 主要有以下特点:</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * 1. 尝试停止所有正在执行的任务, 无法保证能够停止成功, 但会尽力尝试(例如, 通过 Thread.interrupt中断任务, 但是不响应中断的任务可能无法终止);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * 2. 暂停处理已经提交但未执行的任务;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     *</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * @return 返回已经提交但未执行的任务列表</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     */</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    List&lt;Runnable&gt; shutdownNow();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // 如果该执行器已经关闭, 则返回true.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    boolean isShutdown();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    /**</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * 判断执行器是否已经【终止】.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * &lt;p&gt;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * 仅当执行器已关闭且所有任务都已经执行完成, 才返回true.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * 注意: 除非首先调用 shutdown 或 shutdownNow, 否则该方法永远返回false.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     */</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    boolean isTerminated();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // 阻塞调用线程, 等待执行器到达【终止】状态.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    boolean awaitTermination(long timeout, TimeUnit unit)throws InterruptedException;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // 提交一个具有返回值的任务用于执行.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    &lt;T&gt; Future&lt;T&gt; submit(Callable&lt;T&gt; task);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // 提交一个 Runnable 任务用于执行.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    &lt;T&gt; Future&lt;T&gt; submit(Runnable task, T result);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // 提交一个 Runnable 任务用于执行.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    Future&lt;?&gt; submit(Runnable task);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // 执行给定集合中的所有任务, 当所有任务都执行完成后, 返回保持任务状态和结果的 Future 列表.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    &lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        throws InterruptedException;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // 执行给定集合中的所有任务, 当所有任务都执行完成后或超时期满时（无论哪个首先发生）, 返回保持任务状态和结果的 Future 列表</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    &lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                                  long timeout, TimeUnit unit)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        throws InterruptedException;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // 执行给定集合中的任务, 只有其中某个任务率先成功完成（未抛出异常）, 则返回其结果. 一旦正常或异常返回后, 则取消尚未完成的任务.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    &lt;T&gt; T invokeAny(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        throws InterruptedException, ExecutionException;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // 执行给定集合中的任务, 如果在给定的超时期满前, 某个任务已成功完成（未抛出异常）, 则返回其结果. 一旦正常或异常返回后, 则取消尚未完成的任务</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    &lt;T&gt; T invokeAny(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    long timeout, TimeUnit unit)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        throws InterruptedException, ExecutionException, TimeoutException;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>继承 Executor，增强了对任务的控制，和对自身生命周期的管理</p><ul><li>关闭线程池</li><li>监视执行器的状态</li><li>对异步的支持</li><li>对批处理任务的支持</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="abstractexecutorserviceclass"></a>AbstractExecutorService.class<a class="hash-link" href="#abstractexecutorserviceclass" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public abstract class AbstractExecutorService implements ExecutorService {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    protected &lt;T&gt; RunnableFuture&lt;T&gt; newTaskFor(Runnable runnable, T value) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return new FutureTask&lt;T&gt;(runnable, value);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    protected &lt;T&gt; RunnableFuture&lt;T&gt; newTaskFor(Callable&lt;T&gt; callable) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return new FutureTask&lt;T&gt;(callable);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public Future&lt;?&gt; submit(Runnable task) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (task == null) throw new NullPointerException();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        RunnableFuture&lt;Void&gt; ftask = newTaskFor(task, null);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        execute(ftask);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return ftask;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public &lt;T&gt; Future&lt;T&gt; submit(Runnable task, T result) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (task == null) throw new NullPointerException();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        RunnableFuture&lt;T&gt; ftask = newTaskFor(task, result);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        execute(ftask);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return ftask;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public &lt;T&gt; Future&lt;T&gt; submit(Callable&lt;T&gt; task) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (task == null) throw new NullPointerException();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        RunnableFuture&lt;T&gt; ftask = newTaskFor(task);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        execute(ftask);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return ftask;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private &lt;T&gt; T doInvokeAny(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                              boolean timed, long nanos)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        throws InterruptedException, ExecutionException, TimeoutException {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (tasks == null)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            throw new NullPointerException();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        int ntasks = tasks.size();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (ntasks == 0)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            throw new IllegalArgumentException();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        ArrayList&lt;Future&lt;T&gt;&gt; futures = new ArrayList&lt;&gt;(ntasks);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        ExecutorCompletionService&lt;T&gt; ecs =</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            new ExecutorCompletionService&lt;T&gt;(this);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // Record exceptions so that if we fail to obtain any</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // result, we can throw the last exception we got.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            ExecutionException ee = null;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            final long deadline = timed ? System.nanoTime() + nanos : 0L;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            Iterator&lt;? extends Callable&lt;T&gt;&gt; it = tasks.iterator();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // Start one task for sure; the rest incrementally</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            futures.add(ecs.submit(it.next()));</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            --ntasks;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            int active = 1;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            for (;;) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                Future&lt;T&gt; f = ecs.poll();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (f == null) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    if (ntasks &gt; 0) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        --ntasks;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        futures.add(ecs.submit(it.next()));</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        ++active;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    else if (active == 0)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        break;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    else if (timed) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        f = ecs.poll(nanos, NANOSECONDS);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        if (f == null)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                            throw new TimeoutException();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        nanos = deadline - System.nanoTime();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    else</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        f = ecs.take();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (f != null) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    --active;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        return f.get();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    } catch (ExecutionException eex) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        ee = eex;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    } catch (RuntimeException rex) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        ee = new ExecutionException(rex);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            if (ee == null)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                ee = new ExecutionException();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            throw ee;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        } finally {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            cancelAll(futures);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public &lt;T&gt; T invokeAny(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        throws InterruptedException, ExecutionException {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            return doInvokeAny(tasks, false, 0);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        } catch (TimeoutException cannotHappen) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            assert false;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            return null;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public &lt;T&gt; T invokeAny(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                           long timeout, TimeUnit unit)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        throws InterruptedException, ExecutionException, TimeoutException {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return doInvokeAny(tasks, true, unit.toNanos(timeout));</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public &lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        throws InterruptedException {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (tasks == null)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            throw new NullPointerException();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        ArrayList&lt;Future&lt;T&gt;&gt; futures = new ArrayList&lt;&gt;(tasks.size());</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            for (Callable&lt;T&gt; t : tasks) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                RunnableFuture&lt;T&gt; f = newTaskFor(t);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                futures.add(f);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                execute(f);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            for (int i = 0, size = futures.size(); i &lt; size; i++) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                Future&lt;T&gt; f = futures.get(i);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (!f.isDone()) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    try { f.get(); }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    catch (CancellationException | ExecutionException ignore) {}</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            return futures;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        } catch (Throwable t) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            cancelAll(futures);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            throw t;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public &lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                                         long timeout, TimeUnit unit)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        throws InterruptedException {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (tasks == null)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            throw new NullPointerException();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        final long nanos = unit.toNanos(timeout);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        final long deadline = System.nanoTime() + nanos;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        ArrayList&lt;Future&lt;T&gt;&gt; futures = new ArrayList&lt;&gt;(tasks.size());</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        int j = 0;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        timedOut: try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            for (Callable&lt;T&gt; t : tasks)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                futures.add(newTaskFor(t));</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            final int size = futures.size();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // Interleave time checks and calls to execute in case</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // executor doesn&#x27;t have any/much parallelism.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            for (int i = 0; i &lt; size; i++) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (((i == 0) ? nanos : deadline - System.nanoTime()) &lt;= 0L)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    break timedOut;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                execute((Runnable)futures.get(i));</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            for (; j &lt; size; j++) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                Future&lt;T&gt; f = futures.get(j);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (!f.isDone()) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    try { f.get(deadline - System.nanoTime(), NANOSECONDS); }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    catch (CancellationException | ExecutionException ignore) {}</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    catch (TimeoutException timedOut) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        break timedOut;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            return futures;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        } catch (Throwable t) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            cancelAll(futures);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            throw t;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        // Timed out before all the tasks could be completed; cancel remaining</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        cancelAll(futures, j);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return futures;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private static &lt;T&gt; void cancelAll(ArrayList&lt;Future&lt;T&gt;&gt; futures) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        cancelAll(futures, 0);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private static &lt;T&gt; void cancelAll(ArrayList&lt;Future&lt;T&gt;&gt; futures, int j) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        for (int size = futures.size(); j &lt; size; j++)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            futures.get(j).cancel(true);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p><code>ExecutorService</code> 类的抽象实现</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="threadpoolexecutor"></a>ThreadPoolExecutor<a class="hash-link" href="#threadpoolexecutor" title="Direct link to heading">#</a></h2><p><code>ThreadPoolExecutor</code> 是线程池的核心实现类，用来执行被提交的任务</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="结构图"></a>结构图<a class="hash-link" href="#结构图" title="Direct link to heading">#</a></h3><p><img src="/docs.advanced.way/assets/images/ThreadPoolExecutor-c4504db2cc35911ed2d6b509a8077f2d.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="执行流程"></a>执行流程<a class="hash-link" href="#执行流程" title="Direct link to heading">#</a></h3><p><img src="/docs.advanced.way/assets/images/11183270-a01aea078d7f4178-c08184849bd69b9c718e15b36385fd9b.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="threadpoolexecutorclass"></a>ThreadPoolExecutor.class<a class="hash-link" href="#threadpoolexecutorclass" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public class ThreadPoolExecutor extends AbstractExecutorService {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private final BlockingQueue&lt;Runnable&gt; workQueue;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private volatile ThreadFactory threadFactory;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private volatile RejectedExecutionHandler handler;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private volatile long keepAliveTime;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private volatile int corePoolSize;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private volatile int maximumPoolSize;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private static final RejectedExecutionHandler defaultHandler = new AbortPolicy();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private int largestPoolSize;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    /**</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * @param corePoolSize 核心线程数</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * @param maximumPoolSize 最大线程数</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * @param keepAliveTime 线程活动保持时间</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * @param unit 时间单位</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * @param workQueue 排队策略</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * @param threadFactory 线程工厂</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * @param handler 拒绝策略</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     */</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public ThreadPoolExecutor(int corePoolSize,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                              int maximumPoolSize,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                              long keepAliveTime,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                              TimeUnit unit,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                              BlockingQueue&lt;Runnable&gt; workQueue,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                              ThreadFactory threadFactory,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                              RejectedExecutionHandler handler) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (corePoolSize &lt; 0 ||</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            maximumPoolSize &lt;= 0 ||</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            maximumPoolSize &lt; corePoolSize ||</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            keepAliveTime &lt; 0)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            throw new IllegalArgumentException();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (workQueue == null || threadFactory == null || handler == null)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            throw new NullPointerException();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        this.corePoolSize = corePoolSize;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        this.maximumPoolSize = maximumPoolSize;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        this.workQueue = workQueue;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        this.keepAliveTime = unit.toNanos(keepAliveTime);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        this.threadFactory = threadFactory;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        this.handler = handler;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public void execute(Runnable command) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (command == null)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            throw new NullPointerException();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        /*</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         * Proceed in 3 steps:</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         *</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         * 1. If fewer than corePoolSize threads are running, try to</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         * start a new thread with the given command as its first</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         * task.  The call to addWorker atomically checks runState and</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         * workerCount, and so prevents false alarms that would add</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         * threads when it shouldn&#x27;t, by returning false.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         *</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         * 2. If a task can be successfully queued, then we still need</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         * to double-check whether we should have added a thread</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         * (because existing ones died since last checking) or that</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         * the pool shut down since entry into this method. So we</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         * recheck state and if necessary roll back the enqueuing if</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         * stopped, or start a new thread if there are none.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         *</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         * 3. If we cannot queue task, then we try to add a new</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         * thread.  If it fails, we know we are shut down or saturated</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         * and so reject the task.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         */</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        int c = ctl.get();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        // 小于核心线程数，则创建线程并执行任务</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (workerCountOf(c) &lt; corePoolSize) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            if (addWorker(command, true))</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                return;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            c = ctl.get();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        // 线程数&gt;=核心线程数，将任务放入工作队列</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (isRunning(c) &amp;&amp; workQueue.offer(command)) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            int recheck = ctl.get();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            if (! isRunning(recheck) &amp;&amp; remove(command))</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                reject(command);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            else if (workerCountOf(recheck) == 0)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                addWorker(null, false);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        // 无法放入工作队列，执行拒绝策略</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        else if (!addWorker(command, false))</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            reject(command);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private boolean addWorker(Runnable firstTask, boolean core) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        retry:</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        for (int c = ctl.get();;) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // Check if queue empty only if necessary.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            if (runStateAtLeast(c, SHUTDOWN)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    &amp;&amp; (runStateAtLeast(c, STOP)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    || firstTask != null</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    || workQueue.isEmpty()))</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                return false;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            for (;;) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (workerCountOf(c)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    &gt;= ((core ? corePoolSize : maximumPoolSize) &amp; COUNT_MASK))</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    return false;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (compareAndIncrementWorkerCount(c))</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    break retry;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                c = ctl.get();  // Re-read ctl</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (runStateAtLeast(c, SHUTDOWN))</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    continue retry;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                // else CAS failed due to workerCount change; retry inner loop</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        // 线程启动标志位</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        boolean workerStarted = false;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        // 线程是否加入workers 标志位</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        boolean workerAdded = false;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        Worker w = null;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // 创建 worker</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            w = new Worker(firstTask);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            final Thread t = w.thread;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            if (t != null) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                final ReentrantLock mainLock = this.mainLock;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                mainLock.lock();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    // 获取到锁以后仍需检查ctl，可能在上一个获取到锁处理的线程可能会改变runState</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    // 如 ThreadFactory 创建失败 或线程池被 shut down等</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    int c = ctl.get();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    if (isRunning(c) ||</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        (runStateLessThan(c, STOP) &amp;&amp; firstTask == null)) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        if (t.getState() != Thread.State.NEW)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                            throw new IllegalThreadStateException();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        // 加入到工作队列</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        workers.add(w);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        workerAdded = true;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        int s = workers.size();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        if (s &gt; largestPoolSize)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                            largestPoolSize = s;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                } finally {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    mainLock.unlock();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (workerAdded) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    // 启动线程</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    t.start();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    // 已启动</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    workerStarted = true;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        } finally {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // 线程加入失败</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            if (! workerStarted)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                addWorkerFailed(w);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return workerStarted;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private static boolean isRunning(int c) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return c &lt; SHUTDOWN;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public boolean remove(Runnable task) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        boolean removed = workQueue.remove(task);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        tryTerminate(); // In case SHUTDOWN and now empty</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return removed;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // 拒绝策略</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    final void reject(Runnable command) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        handler.rejectedExecution(command, this);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public BlockingQueue&lt;Runnable&gt; getQueue() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return workQueue;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public ThreadFactory getThreadFactory() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return threadFactory;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // 关闭线程池</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public void shutdown() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        final ReentrantLock mainLock = this.mainLock;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        mainLock.lock();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            checkShutdownAccess();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            advanceRunState(SHUTDOWN);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            interruptIdleWorkers();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            onShutdown(); // hook for ScheduledThreadPoolExecutor</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        } finally {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            mainLock.unlock();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        tryTerminate();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private void interruptIdleWorkers() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        interruptIdleWorkers(false);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private void interruptIdleWorkers(boolean onlyOne) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        final ReentrantLock mainLock = this.mainLock;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        mainLock.lock();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // 遍历工作队列</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            for (Worker w : workers) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                Thread t = w.thread;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (!t.isInterrupted() &amp;&amp; w.tryLock()) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        t.interrupt();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    } catch (SecurityException ignore) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    } finally {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        w.unlock();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (onlyOne)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    break;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        } finally {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            mainLock.unlock();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // 执行任务</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    final void runWorker(Worker w) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        Thread wt = Thread.currentThread();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        Runnable task = w.firstTask;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        w.firstTask = null;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        w.unlock(); // allow interrupts</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        boolean completedAbruptly = true;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // loop 直至 task = null （线程池关闭、超时等）</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            while (task != null || (task = getTask()) != null) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                w.lock();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                // If pool is stopping, ensure thread is interrupted;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                // if not, ensure thread is not interrupted.  This</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                // requires a recheck in second case to deal with</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                // shutdownNow race while clearing interrupt</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if ((runStateAtLeast(ctl.get(), STOP) ||</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                     (Thread.interrupted() &amp;&amp;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                      runStateAtLeast(ctl.get(), STOP))) &amp;&amp;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    !wt.isInterrupted())</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    wt.interrupt();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    beforeExecute(wt, task);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        task.run();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        afterExecute(task, null);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    } catch (Throwable ex) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        afterExecute(task, ex);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        throw ex;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                } finally {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    task = null;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    w.completedTasks++;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    w.unlock();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            completedAbruptly = false;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        } finally {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            processWorkerExit(w, completedAbruptly);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // 从工作队列中返回一个任务</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private Runnable getTask() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        // 最近一次 poll() 是否超时</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        boolean timedOut = false;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        for (;;) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            int c = ctl.get();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // 是否继续处理任务</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            if (runStateAtLeast(c, SHUTDOWN) &amp;&amp; (runStateAtLeast(c, STOP) || workQueue.isEmpty())) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                decrementWorkerCount();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                return null;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            int wc = workerCountOf(c);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // 是否允许超时</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            boolean timed = allowCoreThreadTimeOut || wc &gt; corePoolSize;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            if ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut))</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                &amp;&amp; (wc &gt; 1 || workQueue.isEmpty())) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (compareAndDecrementWorkerCount(c))</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    return null;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                continue;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                // 取出一个任务</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                Runnable r = timed ?</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    workQueue.take();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (r != null)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    return r;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                timedOut = true;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            } catch (InterruptedException retry) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                timedOut = false;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private void processWorkerExit(Worker w, boolean completedAbruptly) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (completedAbruptly) // If abrupt, then workerCount wasn&#x27;t adjusted</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            decrementWorkerCount();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        final ReentrantLock mainLock = this.mainLock;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        mainLock.lock();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            completedTaskCount += w.completedTasks;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            workers.remove(w);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        } finally {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            mainLock.unlock();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        tryTerminate();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        int c = ctl.get();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (runStateLessThan(c, STOP)) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            if (!completedAbruptly) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                int min = allowCoreThreadTimeOut ? 0 : corePoolSize;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (min == 0 &amp;&amp; ! workQueue.isEmpty())</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    min = 1;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (workerCountOf(c) &gt;= min)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    return; // replacement not needed</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            addWorker(null, false);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    protected void beforeExecute(Thread t, Runnable r) { }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    protected void afterExecute(Runnable r, Throwable t) { }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="worker"></a>Worker<a class="hash-link" href="#worker" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">// Worker 实现了简单的 非重入互斥锁</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">private final class Worker</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        extends AbstractQueuedSynchronizer</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        implements Runnable</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">{</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private static final long serialVersionUID = 6138294804551838833L;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // 每个worker有自己的内部线程，ThreadFactory创建失败时是null</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    final Thread thread;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // 初始化任务，可能是null</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    Runnable firstTask;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // 每个worker的完成任务数</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    volatile long completedTasks;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    Worker(Runnable firstTask) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        //  // 禁止线程在启动前被打断</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        setState(-1);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        this.firstTask = firstTask;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        // 创建线程</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        this.thread = getThreadFactory().newThread(this);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // 执行方法</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public void run() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        runWorker(this);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // Lock methods</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    //</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // The value 0 represents the unlocked state.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // The value 1 represents the locked state.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // state = 0 代表未锁；state = 1 代表已锁</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    protected boolean isHeldExclusively() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return getState() != 0;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    protected boolean tryAcquire(int unused) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (compareAndSetState(0, 1)) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            setExclusiveOwnerThread(Thread.currentThread());</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            return true;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return false;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    protected boolean tryRelease(int unused) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        setExclusiveOwnerThread(null);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        setState(0);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return true;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public void lock()        { acquire(1); }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public boolean tryLock()  { return tryAcquire(1); }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public void unlock()      { release(1); }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public boolean isLocked() { return isHeldExclusively(); }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    void interruptIfStarted() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        Thread t;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (getState() &gt;= 0 &amp;&amp; (t = thread) != null &amp;&amp; !t.isInterrupted()) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                t.interrupt();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            } catch (SecurityException ignore) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="拒绝策略"></a>拒绝策略<a class="hash-link" href="#拒绝策略" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">// 声明拒绝策略接口</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public interface RejectedExecutionHandler {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    void rejectedExecution(Runnable r, ThreadPoolExecutor executor);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public static class AbortPolicy implements RejectedExecutionHandler {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public AbortPolicy() { }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // 直接抛出异常</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        throw new RejectedExecutionException(&quot;Task &quot; + r.toString() +</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                                                &quot; rejected from &quot; +</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                                                e.toString());</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public static class CallerRunsPolicy implements RejectedExecutionHandler {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public CallerRunsPolicy() { }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // 只用调用者所在线程来运行任务</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (!e.isShutdown()) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            r.run();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public static class DiscardPolicy implements RejectedExecutionHandler {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public DiscardPolicy() { }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // 不做处理，直接丢弃</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public static class DiscardOldestPolicy implements RejectedExecutionHandler {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public DiscardOldestPolicy() { }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // 丢弃工作队列最近的一个任务，并执行当前任务</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (!e.isShutdown()) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // 移除队列头元素</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            e.getQueue().poll();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // 执行任务</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            e.execute(r);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="任务队列"></a>任务队列<a class="hash-link" href="#任务队列" title="Direct link to heading">#</a></h3><ul><li>ArrayBlockingQueue 基于数组结构的有界阻塞队列FIFO</li><li>LinkedBlockingQueue 基于链表结构的阻塞队列</li><li>SynchronousQueue 不存储元素的阻塞队列，每个插入操作必须等到另一个线程调用移除</li><li>PriorityBlockingQueue 具有优先级的无限阻塞队列</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="合理的配置线程池"></a>合理的配置线程池<a class="hash-link" href="#合理的配置线程池" title="Direct link to heading">#</a></h3><ul><li>CPU密集型 N+1</li><li>IO密集型 2*N</li><li>混合型</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="executors"></a>Executors<a class="hash-link" href="#executors" title="Direct link to heading">#</a></h2><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">// 默认的线程工厂</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public static ThreadFactory defaultThreadFactory() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    return new DefaultThreadFactory();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">private static class DefaultThreadFactory implements ThreadFactory {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private static final AtomicInteger poolNumber = new AtomicInteger(1);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private final ThreadGroup group;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private final AtomicInteger threadNumber = new AtomicInteger(1);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private final String namePrefix;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    DefaultThreadFactory() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        SecurityManager s = System.getSecurityManager();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        // 线程组</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        group = (s != null) ? s.getThreadGroup() : Thread.currentThread().getThreadGroup();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        namePrefix = &quot;pool-&quot; +</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        poolNumber.getAndIncrement() +</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        &quot;-thread-&quot;;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public Thread newThread(Runnable r) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        Thread t = new Thread(group, r,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                                namePrefix + threadNumber.getAndIncrement(),</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                                0);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (t.isDaemon())</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            t.setDaemon(false);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (t.getPriority() != Thread.NORM_PRIORITY)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            t.setPriority(Thread.NORM_PRIORITY);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return t;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="fixedthreadpool"></a>FixedThreadPool<a class="hash-link" href="#fixedthreadpool" title="Direct link to heading">#</a></h3><p>创建定长的线程池</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public static ExecutorService newFixedThreadPool(int nThreads) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // 核心线程数和最大线程数相等，使用默认的线程工厂，基于链表的阻塞队列, 0L:空闲线程会立即终止</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    return new ThreadPoolExecutor(nThreads, nThreads,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                                      0L, TimeUnit.MILLISECONDS,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                                      new LinkedBlockingQueue&lt;Runnable&gt;());</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="singlethreadexecutor"></a>SingleThreadExecutor<a class="hash-link" href="#singlethreadexecutor" title="Direct link to heading">#</a></h3><p>创建只有一个线程的线程池</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public static ExecutorService newSingleThreadExecutor() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    return new FinalizableDelegatedExecutorService</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        (new ThreadPoolExecutor(1, 1,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                                0L, TimeUnit.MILLISECONDS,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                                new LinkedBlockingQueue&lt;Runnable&gt;()));</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="cachedthreadpool"></a>CachedThreadPool<a class="hash-link" href="#cachedthreadpool" title="Direct link to heading">#</a></h3><p>可缓存线程池</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public static ExecutorService newCachedThreadPool() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    return new ThreadPoolExecutor(0, Integer.MAX_VALUE,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                                    60L, TimeUnit.SECONDS,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                                    new SynchronousQueue&lt;Runnable&gt;());</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="scheduledthreadpool"></a>ScheduledThreadPool<a class="hash-link" href="#scheduledthreadpool" title="Direct link to heading">#</a></h3><p>创建一个定长线程池，支持定时及周期性任务执行</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public static ScheduledExecutorService newScheduledThreadPool(int corePoolSize, </span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        ThreadFactory threadFactory) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    return new ScheduledThreadPoolExecutor(corePoolSize, threadFactory);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="workstealingpool"></a>WorkStealingPool<a class="hash-link" href="#workstealingpool" title="Direct link to heading">#</a></h3><p>基于工作窃取模式的线程池</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public static final ForkJoinWorkerThreadFactory defaultForkJoinWorkerThreadFactory </span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        = new DefaultForkJoinWorkerThreadFactory();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public static ExecutorService newWorkStealingPool() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    return new ForkJoinPool</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        // 默认cpu核心数</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        (Runtime.getRuntime().availableProcessors(),</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            ForkJoinPool.defaultForkJoinWorkerThreadFactory,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            null, true);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">// 指定cpu核心数</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public static ExecutorService newWorkStealingPool(int parallelism) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    return new ForkJoinPool</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        (parallelism,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            ForkJoinPool.defaultForkJoinWorkerThreadFactory,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            null, true);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="forkjoin-框架"></a>Fork/Join 框架<a class="hash-link" href="#forkjoin-框架" title="Direct link to heading">#</a></h2><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAW4AAAEXCAMAAAC6UV60AAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAERUExURf///yAgIL7r1EDEfAAAAP9/f9/f339/f0BAQL+/v9v/////2zs6ODoAAP9BQWY6Ov/bkP8DA7a2tp+fn2ZmZjo6Zma2/zqQ2wWxU/+2Ztvb2/+/v7b//5CQkP//tpDb/wAAOmZmkJBmZv/btmLOkyW8av/b25CQwf9iYjo6kABmtpA5Q2aQtra22/koKNu2kPz19f+bm7ZmZkVmtpC2ttvgttvbkDpmZraQZmZmOpBmOtKQOp/fxH/Xp5C22wAmgGWPirZmMLa2kLbb/zpmkEUALuPy58WQkNuQZtvb/yQ6HZC2/9u2tv+2kNu2Zv+2tjqRtwBmkD+XZ2a2y5CQZti+2GaQ22Y6ZjoAZv9UVJC2kNzXSWgAAAvISURBVHja7d17W9PYFgbwAOWWpLeYChSLtJUWD1DK/SIiopbRUXFGZ+bM+f4f5DRtKtlpLivp3s3e+K4/5pk87K6s/AihxPCiaahftOwcv6qCM66WlmVsBW5wgxvcKHCDG9zgBje4wS3GqFXVPVtG9SO4RXK/rTzTmjvm8+HWb+bzVhXcwri/mL8b5/lv7hleMk0z90YHtyBuo/HPj7PipntuN4uV74f9sx3cgrjP/3uja2sud7P2bsMc0YObP/e+fXOs9bmvP1t7g5P90rw4ewduMdzGX/rtzoX5aXN3b/D+ZL94kXu6b+7q4Bb0rdKytNHF5LPdrr7KnZnmmX2sg1s0t6ad3No3J7U2LibT4XbeFpaKv4NbGPdtzbIuc5/M987lo2nvVn+rPAe3sPfdtfbDT/H79rX29cN7Hdzifoj33i/RebUCt3StwA1ucIMbBW5wgxvc4AY3uMGtCHdtmVAWZZEJ7tiqLRFqp0xZtdQDJ5c6KMMA3OBGDcu4q/n+ofG0+FIXwT3Rnh5LHVZmL9lnoIxGXQj3RHt6LCf3ztjzZoK4J9vT46iWVTSP93StWTyrXJ+8NStF81sf4aRRn+XMPeGeFCKdD60D95zbKB5pa7mnpfzmVa3dRzg3n0e86qEK5XlqrYfuSTuIeWlLKe7tf2O513IrfYiXp/kV50v8Mt/fJHHPbyflDthTHHdhXi3ug9gr6qvcUw/CzodP0Y+0TvBdIsWe5h8dd8lc0Ur5ldIQoVE/zf9HEHeKPT0ibmO//w1s1vl9j91i/eo8/4el998NV2bf5lY4v2dIv6fHdHYrUOAGN7jBDW5wgxvc4AY3uMEN7oyqu10oFMqd/n/m1aR25u84828rMW6rUx5Uoasmd9edv6PI/ENvVbVH3h1l5ne81dUeesuiXaU8xtfpUB7ky+TBsgXa/JQnERfET9vLLfEq08yCm9/8S7kpnBwzMrZKwi1lK3CDG9zgBje4wQ1ucIMb3BJzs0nEUVHEcnLT58+Iu1W1bu2LUQIum0QcFUUsC3fa+TPiblrVjz9/KYBNIvZEERtjuX+ycNPmb16a5t9yXEyMk52b4YBsErEnitj4OvbcqTwXE8L8zjP5zpPLUly772ru78AwScRMFHFJYm7C/KX8G915Ll8C7pYTyXphVnZ1fxKxJ4pYYm7S/JomxdndbNSP9/bzg0H8ScTeKGJZuanzO0dwJMkbwVJ+9Hn3ZrUyUcRSX0wI8/ev3rua1NxMFLGC3Mz849rycXuiiJXkfpjfeR9r1K5l4G42Ht46MUnEniji5nnujS/cXBpuyvxruU0zL8kbwdKH0e/1M0nEMVHE8pzd6eaX7RZVTBSx9Leo4qKUcUeQK/cUW4Eb3OAGN7jBDW5wgxvc4Ab3r8KdWyTUIWWRnQ03ZbRGg7JqCtxdyhyL5Q5llZUFd40yWYc0/xNNkuqo8TuJoVUoKDUuuMGtIDcxMjiAW46wYeIUAdyZzE+MDA7gliNsmDhFAHcW81Mjg8e55Qgbpk4xzp3F/OTI4DFuOcKGyVOMcU95/lbBqVZ4OHGBqUHAhqf+DY81PhiuEBwpvJ1w/jK7XdDiXnnPddz57fV+dUMjg7vrTN3fs9vrEbHGg49vCw4/Ka+Lmn/4ynm+b8Xc+Jr04cQxrxQdj1PWxM5/IJA7TThxzCunyi1gfiHc6SOD4145HW5x84s5u4XVlM5uYQVucIMb3OAGN7jBDW5wg1sp7vlRBq0gEsH9B7fsygLvOjr3NDtlbhm93YLYDF3R/e+H7cv3ok7tbb4ZvUMPcamuovvfi9V2vfmlxjoeIjN0Rfe/F6s98KZqUzJ0l2kZutUM+ncpL7wr31GWBYpRMnqXC6SMXmd+0Rm0gvsvznBrP7MYNP+MyW/+nvhHQgX3X1zk1j641Qy/3GinFbjBDW5wgxvc4AY3uMEN7gy5E4TPpuLm0z+cO3H/hNzJ5/dxpw6fJXKL6O81mrB/LPek8/u4aeGzbHqudyOOO0V/Juk2jpvU35ed69lZLHeKcF5mY+xiQgifZdNzmY34i0nS/mzSbfzFJL6/LzvXuzPCxSRpOC+7t/FrNyE8l40ELCXiTtqfTbolXLtj+/uzc0uJuJOG87J783PTwmfTc6foryU5u4nhud7s3ETcqcJ5Q85ucvhsSu50/b1Jt9HcCfofaSm4U4bzejbGLyaU8NlJLiaJ+3uzVwkXE0J/Ns014cUkcTivd4PKzYTPCuAO78+Mnprb29+XncuFOzycl9mgc3vCc90JWx95cof0Z5NuJ+D+2X/U0R2fF/d4OG/A/H5uSvism55bGgbQMlG6sdyJ+7NJt7HchP5uR3d8Zv547gThvEHzj53dKcNnyWc3//6s0UT9CWf3ZPNTb1HFhc9Oeotqgv6kW1S0/ulvURHnxx1B3IAFN7jBDW5wgxvc4AY3uMEN7gm5F7lVMLfY/otLlFfeUBYtBXPb3HaQ63M/oSz8809f2mxgBWboWoFLY/rTM24XSJ+oVd92LXCoXtD8y4FLa2nmr1G/DF6/1oSW6P6rYttrVy+U4gA3uKXi3ihWRv/Or62ZRyE3fGmrsuAmTkZbJp7bOKz/TEUt2bshL6StyoKbOBltGS4mj+tiYuwXnSdAnQha7eStk2N4WjRN/1cbbVUW3MTJiMt4c2/NeWvQ/NB+5kbQaoPYyI0Pb56t5b45H3dXz4auejrH1pZobt/+YicbHkH4Ya745ufL3Z1ly53DjaDVh3P0/6c/lPPhrbnBqm70Km91xXL3AnYXNdncFuUwPdXTRFd/DjeClpnD+ZDnkx2xKuOKmuzFlnQH0J/DjaDVornDVmXPHToZyy3FAfTnGEbQ6ifn+T/29FOzcuxG0LLcYauy5w6djOXO/ACMz3tRf3rA5Y5ZlWHFTeZyy3IAzsPjL99pcdzRq+Sd/ye3tAcQxK1ueS4mChS4wQ1ucIMb3OAGtyTUq269VpT69egAlCDvucPOKXtqz7lH0NPU8VZXe+TdU2TanuLaQ285tCkBtNbqFmXZQiYHQIrQ3Vq10kYM8x2WX4KuOZMJN+cIXcHcMzK2SsS9IGMrcIMb3OAGN7jBDW5wgxvc8nEblq4127q63MkPIEvu4UNd7rNc+7ZtF03zSCXu5AeQJfddTX+Y9t6ataxTd4tJ6JWXO/QAfBm9UnCX7KOqXsp/a9SdFLc188J8fz4MJWNCeeXlDj0AX0avHNx37fOL/13mvg+31javbmuv3Ay4khLcoQfgz+iVgfuLXdx0nu7/PowcW8u9r7VH6WNKcEcdgCbf2W3ctY2GbR/vfXRi3qrV28Y/N8V6W1fm7I44ADZCVwruV05e5LvWvu3kflrWyUV+87um0NkddQC+1FgJuA1rT9uw65Z7vTbOz25+2G2FuCMOIFQ7yzeCzR9nxb/d8HZjp96z9vpfgro6Z3foAbCpuXJwf+1/IRq1mnXp/KGNk8b14Gz5Yrf3fKG80nKHHwCbmivPPZON/jvXh42Qn21kvmeS9ABwi+qXuUUFbnCDG9zgBje4wQ1ucIMb3OAGd7xRjlsArZ0RN98IXcFVS5PQG1zLmXAv8zuAJ5oc9eJKU7uulPo9XHCDG9zk4NvkNVnjx8pNDL5NXpM1xsUEF5PJuamRvMlP7skaK8a9NUcpeiSvP6F3S1BjQRG6gsuf0BtSPY0cycuWG+nLv/G0IoAzq1SJtpSTT96s34y5kyfaErklzfrNmDt5oi2RW9Ks36wqdaJtHLe8Wb+ZcqdNtI3lViMqV5VSPjgP3ChwgxvcKIHUq8rHcKroDe1pekN7mt7Q5lOkvzS9ukpZZUEzrhb4/Z3zjJ7SUotb+WcQwY0CN7jBDW5wgxvc4AY3im6ULDcU3BMaJcsNBfeE3OHBp+Dmzx0efApuAdwRwafg5s4dnRsKbt5nd1RuKLi5c0fkhoKbO3dU8Cm4BbwRDA8+BTd37ojgU3CLudGRJDcU3FO90QFucIMb3OAGN7jBDW5wo8ANbnCDW2T1cku8ygR3fFWXuVVVvqP7P/ZjCHp6helcAAAAAElFTkSuQmCC"></p><p>核心思想是将大的任务拆分成多个小任务（即fork），然后在将多个小任务处理汇总到一个结果上</p><p>提供基本的线程池功能，支持设置最大并发线程数，支持任务排队，支持线程池停止，支持线程池使用情况监控，也是AbstractExecutorService的子类，主要引入了“工作窃取”机制，在多CPU计算机上处理性能更佳</p><ul><li>ForkJoinPool </li></ul><p>用于执行ForkJoinTask任务的执行池， 维护一个队列数组WorkQueue</p><ul><li>WorkQueue</li></ul><p>双向列表,用于任务的有序执行,如果WorkQueue用于自己的执行线程Thread,线程默认将会从top端选取任务用来执行 - LIFO</p><p>因为只有owner的Thread才能从top端取任务,所以在设置变量时, int top; 不需要使用 volatile</p><ul><li>ForkJoinWorkThread</li></ul><p>用于执行任务的线程,用于区别使用非ForkJoinWorkThread线程提交的task;启动一个该Thread,会自动注册一个WorkQueue到Pool,这里规定,拥有Thread的WorkQueue只能出现在WorkQueue数组的奇数位</p><ul><li>ForkJoinTask</li></ul><p>任务, 它比传统的任务更加轻量，不再对是RUNNABLE的子类,提供fork/join方法用于分割任务以及聚合结果</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="work-stealing-工作窃取算法"></a>Work-Stealing 工作窃取算法<a class="hash-link" href="#work-stealing-工作窃取算法" title="Direct link to heading">#</a></h3><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="forkjointask"></a>ForkJoinTask<a class="hash-link" href="#forkjointask" title="Direct link to heading">#</a></h3><p>ForkJoinTask需要通过ForkJoinPool来执行</p><p>ForkJoinTask可以理解为类线程但比线程轻量的实体, 在ForkJoinPool中运行的少量ForkJoinWorkerThread可以持有大量的ForkJoinTask和它的子任务.</p><p>ForkJoinTask同时也是一个轻量的Future,使用时应避免较长阻塞和io</p><p>使用ForkJoin框架，必须首先创建一个ForkJoin任务，提供在任务中执行fork()和join()操作的机制.</p><p>子类:</p><ul><li>RecursiveAction 用于没有返回结果的任务</li><li>RecursiveTask 用于有返回结果的任务。</li></ul><blockquote><p>Recursive [rɪˈkɜːsɪv]</p></blockquote><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="recursivetaskclass"></a>RecursiveTask.class<a class="hash-link" href="#recursivetaskclass" title="Direct link to heading">#</a></h4><p>有返回值</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public abstract class RecursiveTask&lt;V&gt; extends ForkJoinTask&lt;V&gt; {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private static final long serialVersionUID = 5232453952276485270L;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    /**</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * The result of the computation.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     */</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    V result;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // 子类重写此方法</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    protected abstract V compute();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public final V getRawResult() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return result;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    protected final void setRawResult(V value) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        result = value;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    protected final boolean exec() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        result = compute();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return true;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="recursiveactionclass"></a>RecursiveAction.class<a class="hash-link" href="#recursiveactionclass" title="Direct link to heading">#</a></h4><p>没有返回值</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public abstract class RecursiveAction extends ForkJoinTask&lt;Void&gt; {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    protected abstract void compute();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public final Void getRawResult() { return null; }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    protected final void setRawResult(Void mustBeNull) { }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    protected final boolean exec() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        compute();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return true;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p><code>RecursiveAction</code> 和 <code>RecursiveTask</code></p><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="forkjointaskclass"></a>ForkJoinTask.class<a class="hash-link" href="#forkjointaskclass" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public abstract class ForkJoinTask&lt;V&gt; implements Future&lt;V&gt;, Serializable {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    volatile int status;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // 分割函数</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public final ForkJoinTask&lt;V&gt; fork() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        Thread t;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if ((t = Thread.currentThread()) instanceof ForkJoinWorkerThread)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // 放入队列</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            ((ForkJoinWorkerThread)t).workQueue.push(this);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        else</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            ForkJoinPool.common.externalPush(this);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return this;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public final V join() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        int s;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (((s = doJoin()) &amp; ABNORMAL) != 0)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            reportException(s);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return getRawResult();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public abstract V getRawResult();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // 获取当前任务的状态来判断返回什么结果</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private int doJoin() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        int s; Thread t; ForkJoinWorkerThread wt; ForkJoinPool.WorkQueue w;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        // 如果执行完毕，返回任务状态</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return (s = status) &lt; 0 ? s :</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            ((t = Thread.currentThread()) instanceof ForkJoinWorkerThread) ?</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // 从任务数组里取出任务执行</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            (w = (wt = (ForkJoinWorkerThread)t).workQueue).</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            tryUnpush(this) &amp;&amp; (s = doExec()) &lt; 0 ? s :</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // </span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            wt.pool.awaitJoin(w, this, 0L) :</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            externalAwaitDone();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    final int doExec() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        int s; boolean completed;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if ((s = status) &gt;= 0) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                completed = exec();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            } catch (Throwable rex) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                completed = false;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                s = setExceptionalCompletion(rex);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            if (completed)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                s = setDone();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return s;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    protected abstract boolean exec();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private int setDone() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        int s;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (((s = (int)STATUS.getAndBitwiseOr(this, DONE)) &amp; SIGNAL) != 0)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            synchronized (this) { notifyAll(); }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return s | DONE;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // 适配器</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    static final class RunnableExecuteAction extends ForkJoinTask&lt;Void&gt; {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        final Runnable runnable;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        RunnableExecuteAction(Runnable runnable) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            if (runnable == null) throw new NullPointerException();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            this.runnable = runnable;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        public final Void getRawResult() { return null; }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        public final void setRawResult(Void v) { }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        public final boolean exec() { runnable.run(); return true; }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        void internalPropagateException(Throwable ex) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            rethrow(ex); // rethrow outside exec() catches.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        private static final long serialVersionUID = 5232453952276885070L;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="forkjoinpoolclass"></a>ForkJoinPool.class<a class="hash-link" href="#forkjoinpoolclass" title="Direct link to heading">#</a></h3><p>ForkJoinTask需要通过ForkJoinPool来执行，任务分割出的子任务会添加到当前工作线程所维护的双端队列中，进入队列的头部</p><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="结构图-1"></a>结构图<a class="hash-link" href="#结构图-1" title="Direct link to heading">#</a></h4><p><img src="/docs.advanced.way/assets/images/ForkJoinPool-3b05ea1df1f35925d1c98b81c7676d79.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="原理"></a>原理<a class="hash-link" href="#原理" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public class ForkJoinPool extends AbstractExecutorService {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public static interface ForkJoinWorkerThreadFactory {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        public ForkJoinWorkerThread newThread(ForkJoinPool pool);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // 线程工厂</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private static final class DefaultForkJoinWorkerThreadFactory implements ForkJoinWorkerThreadFactory {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        private static final AccessControlContext ACC = contextWithPermissions(</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            new RuntimePermission(&quot;getClassLoader&quot;),</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            new RuntimePermission(&quot;setContextClassLoader&quot;));</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        // 创建 ForkJoinWorkerThread 线程</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        public final ForkJoinWorkerThread newThread(ForkJoinPool pool) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            return AccessController.doPrivileged(</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                new PrivilegedAction&lt;&gt;() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    public ForkJoinWorkerThread run() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        return new ForkJoinWorkerThread(</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                            pool, ClassLoader.getSystemClassLoader()); }},</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                ACC);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // 工作队列</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    @jdk.internal.vm.annotation.Contended</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    static final class WorkQueue {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        final void push(ForkJoinTask&lt;?&gt; task) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            ForkJoinTask&lt;?&gt;[] a;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            int s = top, d, cap, m;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            ForkJoinPool p = pool;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            if ((a = array) != null &amp;&amp; (cap = a.length) &gt; 0) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                // 放入ForkJoinTask数组队列里</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                QA.setRelease(a, (m = cap - 1) &amp; s, task);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                top = s + 1;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (((d = s - (int)BASE.getAcquire(this)) &amp; ~1) == 0 &amp;&amp; p != null) {                 // size 0 or 1</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    VarHandle.fullFence();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    // 唤醒或创建一个工作线程执行任务</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    p.signalWork();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                else if (d == m)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    growArray(false);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public void execute(ForkJoinTask&lt;?&gt; task) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        externalSubmit(task);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public void execute(Runnable task) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (task == null)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            throw new NullPointerException();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        ForkJoinTask&lt;?&gt; job;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (task instanceof ForkJoinTask&lt;?&gt;) // avoid re-wrap</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            job = (ForkJoinTask&lt;?&gt;) task;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        else</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // 转换成 ForkJoinTask</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            job = new ForkJoinTask.RunnableExecuteAction(task);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        externalSubmit(job);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private &lt;T&gt; ForkJoinTask&lt;T&gt; externalSubmit(ForkJoinTask&lt;T&gt; task) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        Thread t; ForkJoinWorkerThread w; WorkQueue q;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (task == null)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            throw new NullPointerException();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (((t = Thread.currentThread()) instanceof ForkJoinWorkerThread) &amp;&amp;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            (w = (ForkJoinWorkerThread)t).pool == this &amp;&amp;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            (q = w.workQueue) != null)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // 放入工作队列中</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            q.push(task);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        else</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            externalPush(task);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return task;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    final void externalPush(ForkJoinTask&lt;?&gt; task) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        int r;                                // initialize caller&#x27;s probe</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if ((r = ThreadLocalRandom.getProbe()) == 0) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            ThreadLocalRandom.localInit();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            r = ThreadLocalRandom.getProbe();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        for (;;) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            WorkQueue q;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            int md = mode, n;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            WorkQueue[] ws = workQueues;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            if ((md &amp; SHUTDOWN) != 0 || ws == null || (n = ws.length) &lt;= 0)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                throw new RejectedExecutionException();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            else if ((q = ws[(n - 1) &amp; r &amp; SQMASK]) == null) { // add queue</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                int qid = (r | QUIET) &amp; ~(FIFO | OWNED);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                Object lock = workerNamePrefix;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                ForkJoinTask&lt;?&gt;[] qa =</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    new ForkJoinTask&lt;?&gt;[INITIAL_QUEUE_CAPACITY];</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                q = new WorkQueue(this, null);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                q.array = qa;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                q.id = qid;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                q.source = QUIET;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (lock != null) {     // unless disabled, lock pool to install</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    synchronized (lock) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        WorkQueue[] vs; int i, vn;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        if ((vs = workQueues) != null &amp;&amp; (vn = vs.length) &gt; 0 &amp;&amp;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                            vs[i = qid &amp; (vn - 1) &amp; SQMASK] == null)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                            vs[i] = q;  // else another thread already installed</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            else if (!q.tryLockPhase()) // move if busy</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                r = ThreadLocalRandom.advanceProbe(r);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            else {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (q.lockedPush(task))</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    signalWork();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                return;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // 唤醒或创建一个工作线程执行任务</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    final void signalWork() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        for (;;) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            long c; int sp; WorkQueue[] ws; int i; WorkQueue v;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            if ((c = ctl) &gt;= 0L)                      // enough workers</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                break;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            else if ((sp = (int)c) == 0) {            // no idle workers</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if ((c &amp; ADD_WORKER) != 0L)           // too few workers</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    tryAddWorker(c);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                break;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            else if ((ws = workQueues) == null)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                break;                                // unstarted/terminated</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            else if (ws.length &lt;= (i = sp &amp; SMASK))</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                break;                                // terminated</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            else if ((v = ws[i]) == null)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                break;                                // terminating</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            else {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                int np = sp &amp; ~UNSIGNALLED;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                int vp = v.phase;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                long nc = (v.stackPred &amp; SP_MASK) | (UC_MASK &amp; (c + RC_UNIT));</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                Thread vt = v.owner;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (sp == vp &amp;&amp; CTL.compareAndSet(this, c, nc)) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    v.phase = np;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    if (vt != null &amp;&amp; v.source &lt; 0)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        // 唤醒工作线程</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        LockSupport.unpark(vt);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    break;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private void tryAddWorker(long c) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        do {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            long nc = ((RC_MASK &amp; (c + RC_UNIT)) |</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                       (TC_MASK &amp; (c + TC_UNIT)));</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            if (ctl == c &amp;&amp; CTL.compareAndSet(this, c, nc)) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                createWorker();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                break;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        } while (((c = ctl) &amp; ADD_WORKER) != 0L &amp;&amp; (int)c == 0);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // 创建工作线程</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private boolean createWorker() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        ForkJoinWorkerThreadFactory fac = factory;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        Throwable ex = null;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        ForkJoinWorkerThread wt = null;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            if (fac != null &amp;&amp; (wt = fac.newThread(this)) != null) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                wt.start();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                return true;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        } catch (Throwable rex) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            ex = rex;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        deregisterWorker(wt, ex);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return false;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    final void runWorker(WorkQueue w) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        int r = (w.id ^ ThreadLocalRandom.nextSecondarySeed()) | FIFO; // rng</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        w.array = new ForkJoinTask&lt;?&gt;[INITIAL_QUEUE_CAPACITY]; // initialize</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        for (;;) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            int phase;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            if (scan(w, r)) {                     // scan until apparently empty</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                r ^= r &lt;&lt; 13; r ^= r &gt;&gt;&gt; 17; r ^= r &lt;&lt; 5; // move (xorshift)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            else if ((phase = w.phase) &gt;= 0) {    // enqueue, then rescan</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                long np = (w.phase = (phase + SS_SEQ) | UNSIGNALLED) &amp; SP_MASK;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                long c, nc;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                do {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    w.stackPred = (int)(c = ctl);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    nc = ((c - RC_UNIT) &amp; UC_MASK) | np;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                } while (!CTL.weakCompareAndSet(this, c, nc));</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            else {                                // already queued</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                int pred = w.stackPred;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                Thread.interrupted();             // clear before park</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                w.source = DORMANT;               // enable signal</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                long c = ctl;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                int md = mode, rc = (md &amp; SMASK) + (int)(c &gt;&gt; RC_SHIFT);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (md &lt; 0)                       // terminating</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    break;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                else if (rc &lt;= 0 &amp;&amp; (md &amp; SHUTDOWN) != 0 &amp;&amp;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                         tryTerminate(false, false))</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    break;                        // quiescent shutdown</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                else if (rc &lt;= 0 &amp;&amp; pred != 0 &amp;&amp; phase == (int)c) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    long nc = (UC_MASK &amp; (c - TC_UNIT)) | (SP_MASK &amp; pred);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    long d = keepAlive + System.currentTimeMillis();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    LockSupport.parkUntil(this, d);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    if (ctl == c &amp;&amp;               // drop on timeout if all idle</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        d - System.currentTimeMillis() &lt;= TIMEOUT_SLOP &amp;&amp;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        CTL.compareAndSet(this, c, nc)) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        w.phase = QUIET;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        break;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                else if (w.phase &lt; 0)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    LockSupport.park(this);       // OK if spuriously woken</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                w.source = 0;                     // disable signal</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="forkjoinworkerthreadclass"></a>ForkJoinWorkerThread.class<a class="hash-link" href="#forkjoinworkerthreadclass" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public class ForkJoinWorkerThread extends Thread {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    final ForkJoinPool pool;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    final ForkJoinPool.WorkQueue workQueue;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    protected ForkJoinWorkerThread(ForkJoinPool pool) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        super(&quot;aForkJoinWorkerThread&quot;);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        this.pool = pool;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        this.workQueue = pool.registerWorker(this);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public ForkJoinPool getPool() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return pool;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public int getPoolIndex() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return workQueue.getPoolIndex();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public void run() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (workQueue.array == null) { // only run once</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            Throwable exception = null;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                onStart();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                pool.runWorker(workQueue);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            } catch (Throwable ex) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                exception = ex;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            } finally {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    onTermination(exception);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                } catch (Throwable ex) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    if (exception == null)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        exception = ex;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                } finally {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    pool.deregisterWorker(this, exception);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    protected void onStart() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    protected void onTermination(Throwable exception) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/Goldwood1024/docs.advanced.way/docs/docs/java/hc/线程池.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col text--right"><em><small>Last updated on <time datetime="2021-03-22T07:06:00.000Z" class="lastUpdatedDate_1WI_">3/22/2021</time></small></em></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs.advanced.way/docs/java/hc/并发工具类"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« 并发工具类</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs.advanced.way/docs/java/hc/锁"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">锁 »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#线程池简介" class="table-of-contents__link">线程池简介</a><ul><li><a href="#executor-框架" class="table-of-contents__link">Executor 框架</a></li></ul></li><li><a href="#架构图" class="table-of-contents__link">架构图</a><ul><li><a href="#核心类" class="table-of-contents__link">核心类</a></li></ul></li><li><a href="#threadpoolexecutor" class="table-of-contents__link">ThreadPoolExecutor</a><ul><li><a href="#结构图" class="table-of-contents__link">结构图</a></li><li><a href="#执行流程" class="table-of-contents__link">执行流程</a></li><li><a href="#threadpoolexecutorclass" class="table-of-contents__link">ThreadPoolExecutor.class</a></li><li><a href="#worker" class="table-of-contents__link">Worker</a></li><li><a href="#拒绝策略" class="table-of-contents__link">拒绝策略</a></li><li><a href="#任务队列" class="table-of-contents__link">任务队列</a></li><li><a href="#合理的配置线程池" class="table-of-contents__link">合理的配置线程池</a></li></ul></li><li><a href="#executors" class="table-of-contents__link">Executors</a><ul><li><a href="#fixedthreadpool" class="table-of-contents__link">FixedThreadPool</a></li><li><a href="#singlethreadexecutor" class="table-of-contents__link">SingleThreadExecutor</a></li><li><a href="#cachedthreadpool" class="table-of-contents__link">CachedThreadPool</a></li><li><a href="#scheduledthreadpool" class="table-of-contents__link">ScheduledThreadPool</a></li><li><a href="#workstealingpool" class="table-of-contents__link">WorkStealingPool</a></li></ul></li><li><a href="#forkjoin-框架" class="table-of-contents__link">Fork/Join 框架</a><ul><li><a href="#work-stealing-工作窃取算法" class="table-of-contents__link">Work-Stealing 工作窃取算法</a></li><li><a href="#forkjointask" class="table-of-contents__link">ForkJoinTask</a></li><li><a href="#forkjoinpoolclass" class="table-of-contents__link">ForkJoinPool.class</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2021 进阶之路, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/docs.advanced.way/assets/js/styles.d2979f79.js"></script>
<script src="/docs.advanced.way/assets/js/runtime~main.c79be437.js"></script>
<script src="/docs.advanced.way/assets/js/main.a0c081f8.js"></script>
<script src="/docs.advanced.way/assets/js/1.68ccfdd8.js"></script>
<script src="/docs.advanced.way/assets/js/2.0ae89a79.js"></script>
<script src="/docs.advanced.way/assets/js/3.ef70b8bc.js"></script>
<script src="/docs.advanced.way/assets/js/1be78505.8900d4c5.js"></script>
<script src="/docs.advanced.way/assets/js/202.499d5c45.js"></script>
<script src="/docs.advanced.way/assets/js/935f2afb.410f6dda.js"></script>
<script src="/docs.advanced.way/assets/js/17896441.a99ce0cd.js"></script>
<script src="/docs.advanced.way/assets/js/6424d8c8.473276fb.js"></script>
</body>
</html>