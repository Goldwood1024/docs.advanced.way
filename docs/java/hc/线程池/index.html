<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.72">
<link rel="alternate" type="application/rss+xml" href="/docs.advanced.way/blog/rss.xml" title="è¿›é˜¶ä¹‹è·¯ Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/docs.advanced.way/blog/atom.xml" title="è¿›é˜¶ä¹‹è·¯ Blog Atom Feed"><title data-react-helmet="true">çº¿ç¨‹æ±  | è¿›é˜¶ä¹‹è·¯</title><meta data-react-helmet="true" property="og:url" content="https://Goldwood1024.github.io/docs.advanced.way/docs/java/hc/çº¿ç¨‹æ± "><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="çº¿ç¨‹æ±  | è¿›é˜¶ä¹‹è·¯"><meta data-react-helmet="true" name="description" content="çº¿ç¨‹æ± ç®€ä»‹"><meta data-react-helmet="true" property="og:description" content="çº¿ç¨‹æ± ç®€ä»‹"><link data-react-helmet="true" rel="shortcut icon" href="/docs.advanced.way/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://Goldwood1024.github.io/docs.advanced.way/docs/java/hc/çº¿ç¨‹æ± "><link data-react-helmet="true" rel="alternate" href="https://Goldwood1024.github.io/docs.advanced.way/docs/java/hc/çº¿ç¨‹æ± " hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://Goldwood1024.github.io/docs.advanced.way/docs/java/hc/çº¿ç¨‹æ± " hreflang="x-default"><link rel="stylesheet" href="/docs.advanced.way/assets/css/styles.1814d5b2.css">
<link rel="preload" href="/docs.advanced.way/assets/js/styles.d2979f79.js" as="script">
<link rel="preload" href="/docs.advanced.way/assets/js/runtime~main.c79be437.js" as="script">
<link rel="preload" href="/docs.advanced.way/assets/js/main.a0c081f8.js" as="script">
<link rel="preload" href="/docs.advanced.way/assets/js/1.68ccfdd8.js" as="script">
<link rel="preload" href="/docs.advanced.way/assets/js/2.0ae89a79.js" as="script">
<link rel="preload" href="/docs.advanced.way/assets/js/3.ef70b8bc.js" as="script">
<link rel="preload" href="/docs.advanced.way/assets/js/1be78505.8900d4c5.js" as="script">
<link rel="preload" href="/docs.advanced.way/assets/js/202.499d5c45.js" as="script">
<link rel="preload" href="/docs.advanced.way/assets/js/935f2afb.410f6dda.js" as="script">
<link rel="preload" href="/docs.advanced.way/assets/js/17896441.a99ce0cd.js" as="script">
<link rel="preload" href="/docs.advanced.way/assets/js/6424d8c8.473276fb.js" as="script">
</head>
<body>
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_2qcr"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/docs.advanced.way/"><img src="/docs.advanced.way/img/logo.svg" alt="è¿›é˜¶ä¹‹è·¯ Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/docs.advanced.way/img/logo.svg" alt="è¿›é˜¶ä¹‹è·¯ Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">è¿›é˜¶ä¹‹è·¯</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.advanced.way/docs/java/">Java</a><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link">å¸¸ç”¨æ¡†æ¶</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs.advanced.way/docs/framework/spring/">å¸¸ç”¨æ¡†æ¶</a></li><li><a class="dropdown__link" href="/docs.advanced.way/docs/framework/mybatis/">Mybatis</a></li><li><a class="dropdown__link" href="/docs.advanced.way/docs/framework/auth/auth">æƒé™ç®¡ç†</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link">ä¸­é—´ä»¶</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs.advanced.way/docs/distributed/">åˆ†å¸ƒå¼</a></li><li><a class="dropdown__link" href="/docs.advanced.way/docs/tranctional/">äº‹åŠ¡</a></li><li><a class="dropdown__link" href="/docs.advanced.way/docs/mq/">æ¶ˆæ¯é˜Ÿåˆ—</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link">äº‘åŸç”Ÿ</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs.advanced.way/docs/cloud/docker/base/é•œåƒ/">Dockerå®¹å™¨</a></li><li><a class="dropdown__link" href="/docs.advanced.way/docs/k8s/">K8s</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link">æœåŠ¡å™¨</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs.advanced.way/docs/linux/">Linux</a></li><li><a class="dropdown__link" href="/docs.advanced.way/docs/cache/">ç¼“å­˜</a></li><li><a class="dropdown__link" href="/docs.advanced.way/docs/db/mysql/InnoDB/">æ•°æ®åº“</a></li><li><a class="dropdown__link" href="/docs.advanced.way/docs/cs/network/tcpip/">è®¡ç®—æœºç³»ç»Ÿ</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link">ç¼–ç å®è·µ</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs.advanced.way/docs/algorithm/algorithm/">ç®—æ³•/æ•°æ®ç»“æ„</a></li><li><a class="dropdown__link" href="/docs.advanced.way/docs/patterns/">è®¾è®¡æ¨¡å¼</a></li><li><a class="dropdown__link" href="/docs.advanced.way/docs/architecture/">æ¶æ„è®¾è®¡</a></li><li><a class="dropdown__link" href="/docs.advanced.way/docs/job/java/">é¢è¯•</a></li><li><a class="dropdown__link" href="/docs.advanced.way/docs/memo/tool/sublime/">å¤‡å¿˜</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link">å°ç™¾ç§‘</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs.advanced.way/docs/cyclopedia/chinese/notes/dingding/">è¯¾å ‚ç¬”è®°</a></li><li><a class="dropdown__link" href="/docs.advanced.way/docs/cyclopedia/chinese/lan/idiom/">å¤§ä¸­å›½</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs.advanced.way/blog">åšå®¢</a><a href="https://github.com/Goldwood1024/docs.advanced.way.git" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_GrZ2"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ğŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ğŸŒ</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/docs.advanced.way/"><img src="/docs.advanced.way/img/logo.svg" alt="è¿›é˜¶ä¹‹è·¯ Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/docs.advanced.way/img/logo.svg" alt="è¿›é˜¶ä¹‹è·¯ Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">è¿›é˜¶ä¹‹è·¯</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs.advanced.way/docs/java/">Java</a></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">å¸¸ç”¨æ¡†æ¶</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/framework/spring/">å¸¸ç”¨æ¡†æ¶</a></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/framework/mybatis/">Mybatis</a></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/framework/auth/auth">æƒé™ç®¡ç†</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">ä¸­é—´ä»¶</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/distributed/">åˆ†å¸ƒå¼</a></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/tranctional/">äº‹åŠ¡</a></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/mq/">æ¶ˆæ¯é˜Ÿåˆ—</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">äº‘åŸç”Ÿ</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/cloud/docker/base/é•œåƒ/">Dockerå®¹å™¨</a></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/k8s/">K8s</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">æœåŠ¡å™¨</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/linux/">Linux</a></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/cache/">ç¼“å­˜</a></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/db/mysql/InnoDB/">æ•°æ®åº“</a></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/cs/network/tcpip/">è®¡ç®—æœºç³»ç»Ÿ</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">ç¼–ç å®è·µ</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/algorithm/algorithm/">ç®—æ³•/æ•°æ®ç»“æ„</a></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/patterns/">è®¾è®¡æ¨¡å¼</a></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/architecture/">æ¶æ„è®¾è®¡</a></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/job/java/">é¢è¯•</a></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/memo/tool/sublime/">å¤‡å¿˜</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">å°ç™¾ç§‘</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/cyclopedia/chinese/notes/dingding/">è¯¾å ‚ç¬”è®°</a></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/cyclopedia/chinese/lan/idiom/">å¤§ä¸­å›½</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/blog">åšå®¢</a></li><li class="menu__list-item"><a href="https://github.com/Goldwood1024/docs.advanced.way.git" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper main-docs-wrapper"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo sidebarWithHideableNavbar_267A"><a tabindex="-1" class="sidebarLogo_3h0W" href="/docs.advanced.way/"><img src="/docs.advanced.way/img/logo.svg" alt="è¿›é˜¶ä¹‹è·¯ Logo" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/docs.advanced.way/img/logo.svg" alt="è¿›é˜¶ä¹‹è·¯ Logo" class="themedImage_1VuW themedImage--dark_hz6m"><strong>è¿›é˜¶ä¹‹è·¯</strong></a><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">åŸºç¡€</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/">ç®€ä»‹</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/object">é¢å‘å¯¹è±¡</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/æ•°æ®ç±»å‹">æ•°æ®ç±»å‹</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/å…³é”®å­—">å…³é”®å­—</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/String">String</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/io">I/O</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/nio">NIO</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/Reference">å¯¹è±¡å¼•ç”¨</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/ä»£ç†">ä»£ç†</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/å‡½æ•°å¼æ¥å£">å‡½æ•°å¼æ¥å£</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/åå°„">åå°„</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/base64">Base64ç¼–ç </a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/jdk">JDK</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">é›†åˆ</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/collection/Collection">Collection</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/collection/List">List</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/collection/Map">Map</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">é«˜å¹¶å‘</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs.advanced.way/docs/java/hc/é«˜å¹¶å‘">é«˜å¹¶å‘</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs.advanced.way/docs/java/hc/å¤šçº¿ç¨‹">å¤šçº¿ç¨‹</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs.advanced.way/docs/java/hc/å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯">å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs.advanced.way/docs/java/hc/å†…å­˜æ¨¡å‹">å†…å­˜æ¨¡å‹</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs.advanced.way/docs/java/hc/åŸå­ç±»">åŸå­ç±»</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs.advanced.way/docs/java/hc/å¹¶å‘å®¹å™¨">å¹¶å‘å®¹å™¨</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs.advanced.way/docs/java/hc/å¹¶å‘å·¥å…·ç±»">å¹¶å‘å·¥å…·ç±»</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs.advanced.way/docs/java/hc/çº¿ç¨‹æ± ">çº¿ç¨‹æ± </a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs.advanced.way/docs/java/hc/é”">é”</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">JVM</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/jvm/å¯¹è±¡åˆ›å»ºè¿‡ç¨‹">å¯¹è±¡åˆ›å»ºè¿‡ç¨‹</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/jvm/å¯¹è±¡å›æ”¶æœºåˆ¶">å¯¹è±¡å›æ”¶æœºåˆ¶</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/jvm/jvmå‚æ•°">JVMå‚æ•°</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/jvm/jvmå†…å­˜æ¨¡å‹">å†…å­˜æ¨¡å‹</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/jvm/å†…å­˜ä¼˜åŒ–">å†…å­˜ä¼˜åŒ–</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/jvm/åƒåœ¾æ”¶é›†å™¨">åƒåœ¾æ”¶é›†å™¨</a></li></ul></li></ul></div><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_1CGd"><svg width="20" height="20" role="img" class="collapseSidebarButtonIcon_3E-R"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><header><h1 class="docTitle_3a4h">çº¿ç¨‹æ± </h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="çº¿ç¨‹æ± ç®€ä»‹"></a>çº¿ç¨‹æ± ç®€ä»‹<a class="hash-link" href="#çº¿ç¨‹æ± ç®€ä»‹" title="Direct link to heading">#</a></h2><p>åœ¨ä½¿ç”¨çº¿ç¨‹æ± ä¹‹åï¼Œåˆ›å»ºçº¿ç¨‹å˜æˆäº†ä»çº¿ç¨‹æ± è·å¾—ç©ºé—²çº¿ç¨‹ï¼Œå…³é—­çº¿ç¨‹å˜æˆäº†å‘çº¿ç¨‹æ± å½’è¿˜çº¿ç¨‹ã€‚  </p><p>å¥½å¤„:</p><ul><li>é™ä½èµ„æºæ¶ˆè€—ã€‚é€šè¿‡é‡å¤åˆ©ç”¨å·²åˆ›å»ºçš„çº¿ç¨‹é™ä½çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯é€ æˆçš„æ¶ˆè€—ã€‚</li><li>æé«˜å“åº”é€Ÿåº¦ã€‚å½“ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œä»»åŠ¡å¯ä»¥ä¸éœ€è¦ç­‰åˆ°çº¿ç¨‹åˆ›å»ºå°±èƒ½ç«‹å³æ‰§è¡Œã€‚</li><li>æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§ã€‚çº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æºï¼Œå¦‚æœæ— é™åˆ¶çš„åˆ›å»ºï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥è¿›è¡Œç»Ÿä¸€çš„åˆ†é…ï¼Œè°ƒä¼˜å’Œç›‘æ§ã€‚</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="executor-æ¡†æ¶"></a>Executor æ¡†æ¶<a class="hash-link" href="#executor-æ¡†æ¶" title="Direct link to heading">#</a></h3><p>javaçº¿ç¨‹è¢«ä¸€å¯¹ä¸€çš„æ˜ å°„æˆæœ¬åœ°æ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼Œæ“ä½œç³»ç»Ÿä¼šè°ƒåº¦æ‰€æœ‰çš„çº¿ç¨‹å¹¶åˆ†é…å¯ç”¨çš„CPU.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="æ¶æ„å›¾"></a>æ¶æ„å›¾<a class="hash-link" href="#æ¶æ„å›¾" title="Direct link to heading">#</a></h2><p><img src="/docs.advanced.way/assets/images/java-7-concurrent-executors-uml-class-diagram-example-5a060fcf244bf15c9a95fb91837c8677.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="æ ¸å¿ƒç±»"></a>æ ¸å¿ƒç±»<a class="hash-link" href="#æ ¸å¿ƒç±»" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="executorclass"></a>Executor.class<a class="hash-link" href="#executorclass" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public interface Executor {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    void execute(Runnable command);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>æ˜¯ <code>Executor</code> æ¡†æ¶çš„åŸºç¡€ï¼Œå°†ä»»åŠ¡çš„æäº¤å’Œä»»åŠ¡çš„æ‰§è¡Œåˆ†ç¦»å¼€</p><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="executorserviceclass"></a>ExecutorService.class<a class="hash-link" href="#executorserviceclass" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public interface ExecutorService extends Executor {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    /**</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * å…³é—­æ‰§è¡Œå™¨, ä¸»è¦æœ‰ä»¥ä¸‹ç‰¹ç‚¹:</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * 1. å·²ç»æäº¤ç»™è¯¥æ‰§è¡Œå™¨çš„ä»»åŠ¡å°†ä¼šç»§ç»­æ‰§è¡Œ, ä½†æ˜¯ä¸å†æ¥å—æ–°ä»»åŠ¡çš„æäº¤;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * 2. å¦‚æœæ‰§è¡Œå™¨å·²ç»å…³é—­äº†, åˆ™å†æ¬¡è°ƒç”¨æ²¡æœ‰å‰¯ä½œç”¨.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     */</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    void shutdown();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    /**</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * ç«‹å³å…³é—­æ‰§è¡Œå™¨, ä¸»è¦æœ‰ä»¥ä¸‹ç‰¹ç‚¹:</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * 1. å°è¯•åœæ­¢æ‰€æœ‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡, æ— æ³•ä¿è¯èƒ½å¤Ÿåœæ­¢æˆåŠŸ, ä½†ä¼šå°½åŠ›å°è¯•(ä¾‹å¦‚, é€šè¿‡ Thread.interruptä¸­æ–­ä»»åŠ¡, ä½†æ˜¯ä¸å“åº”ä¸­æ–­çš„ä»»åŠ¡å¯èƒ½æ— æ³•ç»ˆæ­¢);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * 2. æš‚åœå¤„ç†å·²ç»æäº¤ä½†æœªæ‰§è¡Œçš„ä»»åŠ¡;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     *</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * @return è¿”å›å·²ç»æäº¤ä½†æœªæ‰§è¡Œçš„ä»»åŠ¡åˆ—è¡¨</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     */</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    List&lt;Runnable&gt; shutdownNow();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // å¦‚æœè¯¥æ‰§è¡Œå™¨å·²ç»å…³é—­, åˆ™è¿”å›true.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    boolean isShutdown();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    /**</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * åˆ¤æ–­æ‰§è¡Œå™¨æ˜¯å¦å·²ç»ã€ç»ˆæ­¢ã€‘.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * &lt;p&gt;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * ä»…å½“æ‰§è¡Œå™¨å·²å…³é—­ä¸”æ‰€æœ‰ä»»åŠ¡éƒ½å·²ç»æ‰§è¡Œå®Œæˆ, æ‰è¿”å›true.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * æ³¨æ„: é™¤éé¦–å…ˆè°ƒç”¨ shutdown æˆ– shutdownNow, å¦åˆ™è¯¥æ–¹æ³•æ°¸è¿œè¿”å›false.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     */</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    boolean isTerminated();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // é˜»å¡è°ƒç”¨çº¿ç¨‹, ç­‰å¾…æ‰§è¡Œå™¨åˆ°è¾¾ã€ç»ˆæ­¢ã€‘çŠ¶æ€.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    boolean awaitTermination(long timeout, TimeUnit unit)throws InterruptedException;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // æäº¤ä¸€ä¸ªå…·æœ‰è¿”å›å€¼çš„ä»»åŠ¡ç”¨äºæ‰§è¡Œ.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    &lt;T&gt; Future&lt;T&gt; submit(Callable&lt;T&gt; task);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // æäº¤ä¸€ä¸ª Runnable ä»»åŠ¡ç”¨äºæ‰§è¡Œ.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    &lt;T&gt; Future&lt;T&gt; submit(Runnable task, T result);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // æäº¤ä¸€ä¸ª Runnable ä»»åŠ¡ç”¨äºæ‰§è¡Œ.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    Future&lt;?&gt; submit(Runnable task);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // æ‰§è¡Œç»™å®šé›†åˆä¸­çš„æ‰€æœ‰ä»»åŠ¡, å½“æ‰€æœ‰ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæˆå, è¿”å›ä¿æŒä»»åŠ¡çŠ¶æ€å’Œç»“æœçš„ Future åˆ—è¡¨.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    &lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        throws InterruptedException;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // æ‰§è¡Œç»™å®šé›†åˆä¸­çš„æ‰€æœ‰ä»»åŠ¡, å½“æ‰€æœ‰ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæˆåæˆ–è¶…æ—¶æœŸæ»¡æ—¶ï¼ˆæ— è®ºå“ªä¸ªé¦–å…ˆå‘ç”Ÿï¼‰, è¿”å›ä¿æŒä»»åŠ¡çŠ¶æ€å’Œç»“æœçš„ Future åˆ—è¡¨</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    &lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                                  long timeout, TimeUnit unit)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        throws InterruptedException;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // æ‰§è¡Œç»™å®šé›†åˆä¸­çš„ä»»åŠ¡, åªæœ‰å…¶ä¸­æŸä¸ªä»»åŠ¡ç‡å…ˆæˆåŠŸå®Œæˆï¼ˆæœªæŠ›å‡ºå¼‚å¸¸ï¼‰, åˆ™è¿”å›å…¶ç»“æœ. ä¸€æ—¦æ­£å¸¸æˆ–å¼‚å¸¸è¿”å›å, åˆ™å–æ¶ˆå°šæœªå®Œæˆçš„ä»»åŠ¡.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    &lt;T&gt; T invokeAny(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        throws InterruptedException, ExecutionException;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // æ‰§è¡Œç»™å®šé›†åˆä¸­çš„ä»»åŠ¡, å¦‚æœåœ¨ç»™å®šçš„è¶…æ—¶æœŸæ»¡å‰, æŸä¸ªä»»åŠ¡å·²æˆåŠŸå®Œæˆï¼ˆæœªæŠ›å‡ºå¼‚å¸¸ï¼‰, åˆ™è¿”å›å…¶ç»“æœ. ä¸€æ—¦æ­£å¸¸æˆ–å¼‚å¸¸è¿”å›å, åˆ™å–æ¶ˆå°šæœªå®Œæˆçš„ä»»åŠ¡</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    &lt;T&gt; T invokeAny(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    long timeout, TimeUnit unit)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        throws InterruptedException, ExecutionException, TimeoutException;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>ç»§æ‰¿ Executorï¼Œå¢å¼ºäº†å¯¹ä»»åŠ¡çš„æ§åˆ¶ï¼Œå’Œå¯¹è‡ªèº«ç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†</p><ul><li>å…³é—­çº¿ç¨‹æ± </li><li>ç›‘è§†æ‰§è¡Œå™¨çš„çŠ¶æ€</li><li>å¯¹å¼‚æ­¥çš„æ”¯æŒ</li><li>å¯¹æ‰¹å¤„ç†ä»»åŠ¡çš„æ”¯æŒ</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="abstractexecutorserviceclass"></a>AbstractExecutorService.class<a class="hash-link" href="#abstractexecutorserviceclass" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public abstract class AbstractExecutorService implements ExecutorService {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    protected &lt;T&gt; RunnableFuture&lt;T&gt; newTaskFor(Runnable runnable, T value) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return new FutureTask&lt;T&gt;(runnable, value);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    protected &lt;T&gt; RunnableFuture&lt;T&gt; newTaskFor(Callable&lt;T&gt; callable) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return new FutureTask&lt;T&gt;(callable);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public Future&lt;?&gt; submit(Runnable task) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (task == null) throw new NullPointerException();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        RunnableFuture&lt;Void&gt; ftask = newTaskFor(task, null);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        execute(ftask);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return ftask;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public &lt;T&gt; Future&lt;T&gt; submit(Runnable task, T result) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (task == null) throw new NullPointerException();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        RunnableFuture&lt;T&gt; ftask = newTaskFor(task, result);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        execute(ftask);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return ftask;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public &lt;T&gt; Future&lt;T&gt; submit(Callable&lt;T&gt; task) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (task == null) throw new NullPointerException();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        RunnableFuture&lt;T&gt; ftask = newTaskFor(task);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        execute(ftask);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return ftask;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private &lt;T&gt; T doInvokeAny(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                              boolean timed, long nanos)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        throws InterruptedException, ExecutionException, TimeoutException {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (tasks == null)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            throw new NullPointerException();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        int ntasks = tasks.size();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (ntasks == 0)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            throw new IllegalArgumentException();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        ArrayList&lt;Future&lt;T&gt;&gt; futures = new ArrayList&lt;&gt;(ntasks);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        ExecutorCompletionService&lt;T&gt; ecs =</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            new ExecutorCompletionService&lt;T&gt;(this);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // Record exceptions so that if we fail to obtain any</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // result, we can throw the last exception we got.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            ExecutionException ee = null;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            final long deadline = timed ? System.nanoTime() + nanos : 0L;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            Iterator&lt;? extends Callable&lt;T&gt;&gt; it = tasks.iterator();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // Start one task for sure; the rest incrementally</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            futures.add(ecs.submit(it.next()));</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            --ntasks;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            int active = 1;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            for (;;) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                Future&lt;T&gt; f = ecs.poll();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (f == null) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    if (ntasks &gt; 0) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        --ntasks;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        futures.add(ecs.submit(it.next()));</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        ++active;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    else if (active == 0)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        break;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    else if (timed) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        f = ecs.poll(nanos, NANOSECONDS);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        if (f == null)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                            throw new TimeoutException();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        nanos = deadline - System.nanoTime();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    else</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        f = ecs.take();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (f != null) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    --active;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        return f.get();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    } catch (ExecutionException eex) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        ee = eex;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    } catch (RuntimeException rex) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        ee = new ExecutionException(rex);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            if (ee == null)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                ee = new ExecutionException();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            throw ee;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        } finally {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            cancelAll(futures);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public &lt;T&gt; T invokeAny(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        throws InterruptedException, ExecutionException {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            return doInvokeAny(tasks, false, 0);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        } catch (TimeoutException cannotHappen) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            assert false;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            return null;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public &lt;T&gt; T invokeAny(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                           long timeout, TimeUnit unit)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        throws InterruptedException, ExecutionException, TimeoutException {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return doInvokeAny(tasks, true, unit.toNanos(timeout));</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public &lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        throws InterruptedException {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (tasks == null)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            throw new NullPointerException();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        ArrayList&lt;Future&lt;T&gt;&gt; futures = new ArrayList&lt;&gt;(tasks.size());</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            for (Callable&lt;T&gt; t : tasks) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                RunnableFuture&lt;T&gt; f = newTaskFor(t);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                futures.add(f);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                execute(f);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            for (int i = 0, size = futures.size(); i &lt; size; i++) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                Future&lt;T&gt; f = futures.get(i);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (!f.isDone()) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    try { f.get(); }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    catch (CancellationException | ExecutionException ignore) {}</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            return futures;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        } catch (Throwable t) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            cancelAll(futures);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            throw t;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public &lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                                         long timeout, TimeUnit unit)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        throws InterruptedException {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (tasks == null)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            throw new NullPointerException();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        final long nanos = unit.toNanos(timeout);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        final long deadline = System.nanoTime() + nanos;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        ArrayList&lt;Future&lt;T&gt;&gt; futures = new ArrayList&lt;&gt;(tasks.size());</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        int j = 0;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        timedOut: try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            for (Callable&lt;T&gt; t : tasks)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                futures.add(newTaskFor(t));</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            final int size = futures.size();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // Interleave time checks and calls to execute in case</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // executor doesn&#x27;t have any/much parallelism.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            for (int i = 0; i &lt; size; i++) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (((i == 0) ? nanos : deadline - System.nanoTime()) &lt;= 0L)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    break timedOut;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                execute((Runnable)futures.get(i));</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            for (; j &lt; size; j++) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                Future&lt;T&gt; f = futures.get(j);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (!f.isDone()) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    try { f.get(deadline - System.nanoTime(), NANOSECONDS); }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    catch (CancellationException | ExecutionException ignore) {}</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    catch (TimeoutException timedOut) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        break timedOut;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            return futures;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        } catch (Throwable t) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            cancelAll(futures);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            throw t;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        // Timed out before all the tasks could be completed; cancel remaining</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        cancelAll(futures, j);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return futures;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private static &lt;T&gt; void cancelAll(ArrayList&lt;Future&lt;T&gt;&gt; futures) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        cancelAll(futures, 0);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private static &lt;T&gt; void cancelAll(ArrayList&lt;Future&lt;T&gt;&gt; futures, int j) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        for (int size = futures.size(); j &lt; size; j++)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            futures.get(j).cancel(true);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p><code>ExecutorService</code> ç±»çš„æŠ½è±¡å®ç°</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="threadpoolexecutor"></a>ThreadPoolExecutor<a class="hash-link" href="#threadpoolexecutor" title="Direct link to heading">#</a></h2><p><code>ThreadPoolExecutor</code> æ˜¯çº¿ç¨‹æ± çš„æ ¸å¿ƒå®ç°ç±»ï¼Œç”¨æ¥æ‰§è¡Œè¢«æäº¤çš„ä»»åŠ¡</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="ç»“æ„å›¾"></a>ç»“æ„å›¾<a class="hash-link" href="#ç»“æ„å›¾" title="Direct link to heading">#</a></h3><p><img src="/docs.advanced.way/assets/images/ThreadPoolExecutor-c4504db2cc35911ed2d6b509a8077f2d.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="æ‰§è¡Œæµç¨‹"></a>æ‰§è¡Œæµç¨‹<a class="hash-link" href="#æ‰§è¡Œæµç¨‹" title="Direct link to heading">#</a></h3><p><img src="/docs.advanced.way/assets/images/11183270-a01aea078d7f4178-c08184849bd69b9c718e15b36385fd9b.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="threadpoolexecutorclass"></a>ThreadPoolExecutor.class<a class="hash-link" href="#threadpoolexecutorclass" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public class ThreadPoolExecutor extends AbstractExecutorService {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    </span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private final BlockingQueue&lt;Runnable&gt; workQueue;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private volatile ThreadFactory threadFactory;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private volatile RejectedExecutionHandler handler;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private volatile long keepAliveTime;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private volatile int corePoolSize;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private volatile int maximumPoolSize;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private static final RejectedExecutionHandler defaultHandler = new AbortPolicy();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private int largestPoolSize;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    /**</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * @param corePoolSize æ ¸å¿ƒçº¿ç¨‹æ•°</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * @param maximumPoolSize æœ€å¤§çº¿ç¨‹æ•°</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * @param keepAliveTime çº¿ç¨‹æ´»åŠ¨ä¿æŒæ—¶é—´</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * @param unit æ—¶é—´å•ä½</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * @param workQueue æ’é˜Ÿç­–ç•¥</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * @param threadFactory çº¿ç¨‹å·¥å‚</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * @param handler æ‹’ç»ç­–ç•¥</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     */</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public ThreadPoolExecutor(int corePoolSize,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                              int maximumPoolSize,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                              long keepAliveTime,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                              TimeUnit unit,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                              BlockingQueue&lt;Runnable&gt; workQueue,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                              ThreadFactory threadFactory,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                              RejectedExecutionHandler handler) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (corePoolSize &lt; 0 ||</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            maximumPoolSize &lt;= 0 ||</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            maximumPoolSize &lt; corePoolSize ||</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            keepAliveTime &lt; 0)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            throw new IllegalArgumentException();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (workQueue == null || threadFactory == null || handler == null)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            throw new NullPointerException();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        this.corePoolSize = corePoolSize;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        this.maximumPoolSize = maximumPoolSize;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        this.workQueue = workQueue;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        this.keepAliveTime = unit.toNanos(keepAliveTime);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        this.threadFactory = threadFactory;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        this.handler = handler;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public void execute(Runnable command) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (command == null)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            throw new NullPointerException();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        /*</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         * Proceed in 3 steps:</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         *</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         * 1. If fewer than corePoolSize threads are running, try to</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         * start a new thread with the given command as its first</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         * task.  The call to addWorker atomically checks runState and</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         * workerCount, and so prevents false alarms that would add</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         * threads when it shouldn&#x27;t, by returning false.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         *</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         * 2. If a task can be successfully queued, then we still need</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         * to double-check whether we should have added a thread</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         * (because existing ones died since last checking) or that</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         * the pool shut down since entry into this method. So we</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         * recheck state and if necessary roll back the enqueuing if</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         * stopped, or start a new thread if there are none.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         *</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         * 3. If we cannot queue task, then we try to add a new</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         * thread.  If it fails, we know we are shut down or saturated</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         * and so reject the task.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">         */</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        int c = ctl.get();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        // å°äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œåˆ™åˆ›å»ºçº¿ç¨‹å¹¶æ‰§è¡Œä»»åŠ¡</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (workerCountOf(c) &lt; corePoolSize) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            if (addWorker(command, true))</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                return;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            c = ctl.get();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        </span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        // çº¿ç¨‹æ•°&gt;=æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå°†ä»»åŠ¡æ”¾å…¥å·¥ä½œé˜Ÿåˆ—</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (isRunning(c) &amp;&amp; workQueue.offer(command)) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            int recheck = ctl.get();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            if (! isRunning(recheck) &amp;&amp; remove(command))</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                reject(command);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            else if (workerCountOf(recheck) == 0)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                addWorker(null, false);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        // æ— æ³•æ”¾å…¥å·¥ä½œé˜Ÿåˆ—ï¼Œæ‰§è¡Œæ‹’ç»ç­–ç•¥</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        else if (!addWorker(command, false))</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            reject(command);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private boolean addWorker(Runnable firstTask, boolean core) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        retry:</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        for (int c = ctl.get();;) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // Check if queue empty only if necessary.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            if (runStateAtLeast(c, SHUTDOWN)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    &amp;&amp; (runStateAtLeast(c, STOP)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    || firstTask != null</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    || workQueue.isEmpty()))</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                return false;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            for (;;) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (workerCountOf(c)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    &gt;= ((core ? corePoolSize : maximumPoolSize) &amp; COUNT_MASK))</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    return false;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (compareAndIncrementWorkerCount(c))</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    break retry;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                c = ctl.get();  // Re-read ctl</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (runStateAtLeast(c, SHUTDOWN))</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    continue retry;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                // else CAS failed due to workerCount change; retry inner loop</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        // çº¿ç¨‹å¯åŠ¨æ ‡å¿—ä½</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        boolean workerStarted = false;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        // çº¿ç¨‹æ˜¯å¦åŠ å…¥workers æ ‡å¿—ä½</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        boolean workerAdded = false;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        Worker w = null;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // åˆ›å»º worker</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            w = new Worker(firstTask);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            final Thread t = w.thread;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            if (t != null) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                final ReentrantLock mainLock = this.mainLock;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                mainLock.lock();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    // è·å–åˆ°é”ä»¥åä»éœ€æ£€æŸ¥ctlï¼Œå¯èƒ½åœ¨ä¸Šä¸€ä¸ªè·å–åˆ°é”å¤„ç†çš„çº¿ç¨‹å¯èƒ½ä¼šæ”¹å˜runState</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    // å¦‚ ThreadFactory åˆ›å»ºå¤±è´¥ æˆ–çº¿ç¨‹æ± è¢« shut downç­‰</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    int c = ctl.get();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    if (isRunning(c) ||</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        (runStateLessThan(c, STOP) &amp;&amp; firstTask == null)) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        if (t.getState() != Thread.State.NEW)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                            throw new IllegalThreadStateException();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        // åŠ å…¥åˆ°å·¥ä½œé˜Ÿåˆ—</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        workers.add(w);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        workerAdded = true;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        int s = workers.size();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        if (s &gt; largestPoolSize)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                            largestPoolSize = s;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                } finally {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    mainLock.unlock();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (workerAdded) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    // å¯åŠ¨çº¿ç¨‹</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    t.start();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    // å·²å¯åŠ¨</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    workerStarted = true;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        } finally {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // çº¿ç¨‹åŠ å…¥å¤±è´¥</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            if (! workerStarted)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                addWorkerFailed(w);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return workerStarted;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private static boolean isRunning(int c) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return c &lt; SHUTDOWN;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public boolean remove(Runnable task) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        boolean removed = workQueue.remove(task);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        tryTerminate(); // In case SHUTDOWN and now empty</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return removed;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // æ‹’ç»ç­–ç•¥</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    final void reject(Runnable command) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        handler.rejectedExecution(command, this);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public BlockingQueue&lt;Runnable&gt; getQueue() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return workQueue;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public ThreadFactory getThreadFactory() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return threadFactory;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // å…³é—­çº¿ç¨‹æ± </span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public void shutdown() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        final ReentrantLock mainLock = this.mainLock;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        mainLock.lock();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            checkShutdownAccess();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            advanceRunState(SHUTDOWN);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            interruptIdleWorkers();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            onShutdown(); // hook for ScheduledThreadPoolExecutor</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        } finally {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            mainLock.unlock();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        tryTerminate();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private void interruptIdleWorkers() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        interruptIdleWorkers(false);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private void interruptIdleWorkers(boolean onlyOne) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        final ReentrantLock mainLock = this.mainLock;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        mainLock.lock();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // éå†å·¥ä½œé˜Ÿåˆ—</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            for (Worker w : workers) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                Thread t = w.thread;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (!t.isInterrupted() &amp;&amp; w.tryLock()) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        t.interrupt();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    } catch (SecurityException ignore) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    } finally {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        w.unlock();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (onlyOne)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    break;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        } finally {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            mainLock.unlock();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // æ‰§è¡Œä»»åŠ¡</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    final void runWorker(Worker w) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        Thread wt = Thread.currentThread();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        Runnable task = w.firstTask;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        w.firstTask = null;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        w.unlock(); // allow interrupts</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        boolean completedAbruptly = true;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // loop ç›´è‡³ task = null ï¼ˆçº¿ç¨‹æ± å…³é—­ã€è¶…æ—¶ç­‰ï¼‰</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            while (task != null || (task = getTask()) != null) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                w.lock();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                // If pool is stopping, ensure thread is interrupted;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                // if not, ensure thread is not interrupted.  This</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                // requires a recheck in second case to deal with</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                // shutdownNow race while clearing interrupt</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if ((runStateAtLeast(ctl.get(), STOP) ||</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                     (Thread.interrupted() &amp;&amp;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                      runStateAtLeast(ctl.get(), STOP))) &amp;&amp;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    !wt.isInterrupted())</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    wt.interrupt();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    beforeExecute(wt, task);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        task.run();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        afterExecute(task, null);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    } catch (Throwable ex) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        afterExecute(task, ex);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        throw ex;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                } finally {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    task = null;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    w.completedTasks++;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    w.unlock();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            completedAbruptly = false;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        } finally {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            processWorkerExit(w, completedAbruptly);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // ä»å·¥ä½œé˜Ÿåˆ—ä¸­è¿”å›ä¸€ä¸ªä»»åŠ¡</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private Runnable getTask() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        // æœ€è¿‘ä¸€æ¬¡ poll() æ˜¯å¦è¶…æ—¶</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        boolean timedOut = false;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        for (;;) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            int c = ctl.get();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // æ˜¯å¦ç»§ç»­å¤„ç†ä»»åŠ¡</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            if (runStateAtLeast(c, SHUTDOWN) &amp;&amp; (runStateAtLeast(c, STOP) || workQueue.isEmpty())) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                decrementWorkerCount();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                return null;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            int wc = workerCountOf(c);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // æ˜¯å¦å…è®¸è¶…æ—¶</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            boolean timed = allowCoreThreadTimeOut || wc &gt; corePoolSize;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            if ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut))</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                &amp;&amp; (wc &gt; 1 || workQueue.isEmpty())) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (compareAndDecrementWorkerCount(c))</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    return null;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                continue;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                // å–å‡ºä¸€ä¸ªä»»åŠ¡</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                Runnable r = timed ?</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    workQueue.take();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (r != null)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    return r;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                timedOut = true;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            } catch (InterruptedException retry) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                timedOut = false;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private void processWorkerExit(Worker w, boolean completedAbruptly) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (completedAbruptly) // If abrupt, then workerCount wasn&#x27;t adjusted</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            decrementWorkerCount();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        final ReentrantLock mainLock = this.mainLock;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        mainLock.lock();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            completedTaskCount += w.completedTasks;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            workers.remove(w);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        } finally {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            mainLock.unlock();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        tryTerminate();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        int c = ctl.get();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (runStateLessThan(c, STOP)) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            if (!completedAbruptly) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                int min = allowCoreThreadTimeOut ? 0 : corePoolSize;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (min == 0 &amp;&amp; ! workQueue.isEmpty())</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    min = 1;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (workerCountOf(c) &gt;= min)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    return; // replacement not needed</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            addWorker(null, false);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    protected void beforeExecute(Thread t, Runnable r) { }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    protected void afterExecute(Runnable r, Throwable t) { }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="worker"></a>Worker<a class="hash-link" href="#worker" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">// Worker å®ç°äº†ç®€å•çš„ éé‡å…¥äº’æ–¥é”</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">private final class Worker</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        extends AbstractQueuedSynchronizer</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        implements Runnable</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">{</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private static final long serialVersionUID = 6138294804551838833L;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // æ¯ä¸ªworkeræœ‰è‡ªå·±çš„å†…éƒ¨çº¿ç¨‹ï¼ŒThreadFactoryåˆ›å»ºå¤±è´¥æ—¶æ˜¯null</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    final Thread thread;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // åˆå§‹åŒ–ä»»åŠ¡ï¼Œå¯èƒ½æ˜¯null</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    Runnable firstTask;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // æ¯ä¸ªworkerçš„å®Œæˆä»»åŠ¡æ•°</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    volatile long completedTasks;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    Worker(Runnable firstTask) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        //  // ç¦æ­¢çº¿ç¨‹åœ¨å¯åŠ¨å‰è¢«æ‰“æ–­</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        setState(-1);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        this.firstTask = firstTask;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        // åˆ›å»ºçº¿ç¨‹</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        this.thread = getThreadFactory().newThread(this);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // æ‰§è¡Œæ–¹æ³•</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public void run() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        runWorker(this);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // Lock methods</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    //</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // The value 0 represents the unlocked state.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // The value 1 represents the locked state.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // state = 0 ä»£è¡¨æœªé”ï¼›state = 1 ä»£è¡¨å·²é”</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    protected boolean isHeldExclusively() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return getState() != 0;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    protected boolean tryAcquire(int unused) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (compareAndSetState(0, 1)) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            setExclusiveOwnerThread(Thread.currentThread());</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            return true;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return false;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    protected boolean tryRelease(int unused) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        setExclusiveOwnerThread(null);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        setState(0);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return true;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public void lock()        { acquire(1); }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public boolean tryLock()  { return tryAcquire(1); }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public void unlock()      { release(1); }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public boolean isLocked() { return isHeldExclusively(); }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    void interruptIfStarted() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        Thread t;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (getState() &gt;= 0 &amp;&amp; (t = thread) != null &amp;&amp; !t.isInterrupted()) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                t.interrupt();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            } catch (SecurityException ignore) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="æ‹’ç»ç­–ç•¥"></a>æ‹’ç»ç­–ç•¥<a class="hash-link" href="#æ‹’ç»ç­–ç•¥" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">// å£°æ˜æ‹’ç»ç­–ç•¥æ¥å£</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public interface RejectedExecutionHandler {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    void rejectedExecution(Runnable r, ThreadPoolExecutor executor);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public static class AbortPolicy implements RejectedExecutionHandler {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public AbortPolicy() { }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // ç›´æ¥æŠ›å‡ºå¼‚å¸¸</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        throw new RejectedExecutionException(&quot;Task &quot; + r.toString() +</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                                                &quot; rejected from &quot; +</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                                                e.toString());</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public static class CallerRunsPolicy implements RejectedExecutionHandler {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public CallerRunsPolicy() { }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // åªç”¨è°ƒç”¨è€…æ‰€åœ¨çº¿ç¨‹æ¥è¿è¡Œä»»åŠ¡</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (!e.isShutdown()) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            r.run();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public static class DiscardPolicy implements RejectedExecutionHandler {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public DiscardPolicy() { }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // ä¸åšå¤„ç†ï¼Œç›´æ¥ä¸¢å¼ƒ</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public static class DiscardOldestPolicy implements RejectedExecutionHandler {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public DiscardOldestPolicy() { }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // ä¸¢å¼ƒå·¥ä½œé˜Ÿåˆ—æœ€è¿‘çš„ä¸€ä¸ªä»»åŠ¡ï¼Œå¹¶æ‰§è¡Œå½“å‰ä»»åŠ¡</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (!e.isShutdown()) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // ç§»é™¤é˜Ÿåˆ—å¤´å…ƒç´ </span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            e.getQueue().poll();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // æ‰§è¡Œä»»åŠ¡</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            e.execute(r);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="ä»»åŠ¡é˜Ÿåˆ—"></a>ä»»åŠ¡é˜Ÿåˆ—<a class="hash-link" href="#ä»»åŠ¡é˜Ÿåˆ—" title="Direct link to heading">#</a></h3><ul><li>ArrayBlockingQueue åŸºäºæ•°ç»„ç»“æ„çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—FIFO</li><li>LinkedBlockingQueue åŸºäºé“¾è¡¨ç»“æ„çš„é˜»å¡é˜Ÿåˆ—</li><li>SynchronousQueue ä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ï¼Œæ¯ä¸ªæ’å…¥æ“ä½œå¿…é¡»ç­‰åˆ°å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ç§»é™¤</li><li>PriorityBlockingQueue å…·æœ‰ä¼˜å…ˆçº§çš„æ— é™é˜»å¡é˜Ÿåˆ—</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="åˆç†çš„é…ç½®çº¿ç¨‹æ± "></a>åˆç†çš„é…ç½®çº¿ç¨‹æ± <a class="hash-link" href="#åˆç†çš„é…ç½®çº¿ç¨‹æ± " title="Direct link to heading">#</a></h3><ul><li>CPUå¯†é›†å‹ N+1</li><li>IOå¯†é›†å‹ 2*N</li><li>æ··åˆå‹</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="executors"></a>Executors<a class="hash-link" href="#executors" title="Direct link to heading">#</a></h2><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">// é»˜è®¤çš„çº¿ç¨‹å·¥å‚</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public static ThreadFactory defaultThreadFactory() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    return new DefaultThreadFactory();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">private static class DefaultThreadFactory implements ThreadFactory {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private static final AtomicInteger poolNumber = new AtomicInteger(1);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private final ThreadGroup group;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private final AtomicInteger threadNumber = new AtomicInteger(1);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private final String namePrefix;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    DefaultThreadFactory() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        SecurityManager s = System.getSecurityManager();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        // çº¿ç¨‹ç»„</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        group = (s != null) ? s.getThreadGroup() : Thread.currentThread().getThreadGroup();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        namePrefix = &quot;pool-&quot; +</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        poolNumber.getAndIncrement() +</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        &quot;-thread-&quot;;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public Thread newThread(Runnable r) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        Thread t = new Thread(group, r,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                                namePrefix + threadNumber.getAndIncrement(),</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                                0);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (t.isDaemon())</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            t.setDaemon(false);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (t.getPriority() != Thread.NORM_PRIORITY)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            t.setPriority(Thread.NORM_PRIORITY);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return t;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="fixedthreadpool"></a>FixedThreadPool<a class="hash-link" href="#fixedthreadpool" title="Direct link to heading">#</a></h3><p>åˆ›å»ºå®šé•¿çš„çº¿ç¨‹æ± </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public static ExecutorService newFixedThreadPool(int nThreads) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // æ ¸å¿ƒçº¿ç¨‹æ•°å’Œæœ€å¤§çº¿ç¨‹æ•°ç›¸ç­‰ï¼Œä½¿ç”¨é»˜è®¤çš„çº¿ç¨‹å·¥å‚ï¼ŒåŸºäºé“¾è¡¨çš„é˜»å¡é˜Ÿåˆ—, 0L:ç©ºé—²çº¿ç¨‹ä¼šç«‹å³ç»ˆæ­¢</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    return new ThreadPoolExecutor(nThreads, nThreads,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                                      0L, TimeUnit.MILLISECONDS,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                                      new LinkedBlockingQueue&lt;Runnable&gt;());</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="singlethreadexecutor"></a>SingleThreadExecutor<a class="hash-link" href="#singlethreadexecutor" title="Direct link to heading">#</a></h3><p>åˆ›å»ºåªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public static ExecutorService newSingleThreadExecutor() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    return new FinalizableDelegatedExecutorService</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        (new ThreadPoolExecutor(1, 1,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                                0L, TimeUnit.MILLISECONDS,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                                new LinkedBlockingQueue&lt;Runnable&gt;()));</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="cachedthreadpool"></a>CachedThreadPool<a class="hash-link" href="#cachedthreadpool" title="Direct link to heading">#</a></h3><p>å¯ç¼“å­˜çº¿ç¨‹æ± </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public static ExecutorService newCachedThreadPool() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    return new ThreadPoolExecutor(0, Integer.MAX_VALUE,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                                    60L, TimeUnit.SECONDS,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                                    new SynchronousQueue&lt;Runnable&gt;());</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="scheduledthreadpool"></a>ScheduledThreadPool<a class="hash-link" href="#scheduledthreadpool" title="Direct link to heading">#</a></h3><p>åˆ›å»ºä¸€ä¸ªå®šé•¿çº¿ç¨‹æ± ï¼Œæ”¯æŒå®šæ—¶åŠå‘¨æœŸæ€§ä»»åŠ¡æ‰§è¡Œ</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public static ScheduledExecutorService newScheduledThreadPool(int corePoolSize, </span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        ThreadFactory threadFactory) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    return new ScheduledThreadPoolExecutor(corePoolSize, threadFactory);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="workstealingpool"></a>WorkStealingPool<a class="hash-link" href="#workstealingpool" title="Direct link to heading">#</a></h3><p>åŸºäºå·¥ä½œçªƒå–æ¨¡å¼çš„çº¿ç¨‹æ± </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public static final ForkJoinWorkerThreadFactory defaultForkJoinWorkerThreadFactory </span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        = new DefaultForkJoinWorkerThreadFactory();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public static ExecutorService newWorkStealingPool() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    return new ForkJoinPool</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        // é»˜è®¤cpuæ ¸å¿ƒæ•°</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        (Runtime.getRuntime().availableProcessors(),</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            ForkJoinPool.defaultForkJoinWorkerThreadFactory,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            null, true);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">// æŒ‡å®šcpuæ ¸å¿ƒæ•°</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public static ExecutorService newWorkStealingPool(int parallelism) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    return new ForkJoinPool</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        (parallelism,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            ForkJoinPool.defaultForkJoinWorkerThreadFactory,</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            null, true);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="forkjoin-æ¡†æ¶"></a>Fork/Join æ¡†æ¶<a class="hash-link" href="#forkjoin-æ¡†æ¶" title="Direct link to heading">#</a></h2><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAW4AAAEXCAMAAAC6UV60AAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAERUExURf///yAgIL7r1EDEfAAAAP9/f9/f339/f0BAQL+/v9v/////2zs6ODoAAP9BQWY6Ov/bkP8DA7a2tp+fn2ZmZjo6Zma2/zqQ2wWxU/+2Ztvb2/+/v7b//5CQkP//tpDb/wAAOmZmkJBmZv/btmLOkyW8av/b25CQwf9iYjo6kABmtpA5Q2aQtra22/koKNu2kPz19f+bm7ZmZkVmtpC2ttvgttvbkDpmZraQZmZmOpBmOtKQOp/fxH/Xp5C22wAmgGWPirZmMLa2kLbb/zpmkEUALuPy58WQkNuQZtvb/yQ6HZC2/9u2tv+2kNu2Zv+2tjqRtwBmkD+XZ2a2y5CQZti+2GaQ22Y6ZjoAZv9UVJC2kNzXSWgAAAvISURBVHja7d17W9PYFgbwAOWWpLeYChSLtJUWD1DK/SIiopbRUXFGZ+bM+f4f5DRtKtlpLivp3s3e+K4/5pk87K6s/AihxPCiaahftOwcv6qCM66WlmVsBW5wgxvcKHCDG9zgBje4wS3GqFXVPVtG9SO4RXK/rTzTmjvm8+HWb+bzVhXcwri/mL8b5/lv7hleMk0z90YHtyBuo/HPj7PipntuN4uV74f9sx3cgrjP/3uja2sud7P2bsMc0YObP/e+fXOs9bmvP1t7g5P90rw4ewduMdzGX/rtzoX5aXN3b/D+ZL94kXu6b+7q4Bb0rdKytNHF5LPdrr7KnZnmmX2sg1s0t6ad3No3J7U2LibT4XbeFpaKv4NbGPdtzbIuc5/M987lo2nvVn+rPAe3sPfdtfbDT/H79rX29cN7Hdzifoj33i/RebUCt3StwA1ucIMbBW5wgxvc4AY3uMGtCHdtmVAWZZEJ7tiqLRFqp0xZtdQDJ5c6KMMA3OBGDcu4q/n+ofG0+FIXwT3Rnh5LHVZmL9lnoIxGXQj3RHt6LCf3ztjzZoK4J9vT46iWVTSP93StWTyrXJ+8NStF81sf4aRRn+XMPeGeFCKdD60D95zbKB5pa7mnpfzmVa3dRzg3n0e86qEK5XlqrYfuSTuIeWlLKe7tf2O513IrfYiXp/kV50v8Mt/fJHHPbyflDthTHHdhXi3ug9gr6qvcUw/CzodP0Y+0TvBdIsWe5h8dd8lc0Ur5ldIQoVE/zf9HEHeKPT0ibmO//w1s1vl9j91i/eo8/4el998NV2bf5lY4v2dIv6fHdHYrUOAGN7jBDW5wgxvc4AY3uMEN7oyqu10oFMqd/n/m1aR25u84828rMW6rUx5Uoasmd9edv6PI/ENvVbVH3h1l5ne81dUeesuiXaU8xtfpUB7ky+TBsgXa/JQnERfET9vLLfEq08yCm9/8S7kpnBwzMrZKwi1lK3CDG9zgBje4wQ1ucIMb3BJzs0nEUVHEcnLT58+Iu1W1bu2LUQIum0QcFUUsC3fa+TPiblrVjz9/KYBNIvZEERtjuX+ycNPmb16a5t9yXEyMk52b4YBsErEnitj4OvbcqTwXE8L8zjP5zpPLUly772ru78AwScRMFHFJYm7C/KX8G915Ll8C7pYTyXphVnZ1fxKxJ4pYYm7S/JomxdndbNSP9/bzg0H8ScTeKGJZuanzO0dwJMkbwVJ+9Hn3ZrUyUcRSX0wI8/ev3rua1NxMFLGC3Mz849rycXuiiJXkfpjfeR9r1K5l4G42Ht46MUnEniji5nnujS/cXBpuyvxruU0zL8kbwdKH0e/1M0nEMVHE8pzd6eaX7RZVTBSx9Leo4qKUcUeQK/cUW4Eb3OAGN7jBDW5wgxvc4Ab3r8KdWyTUIWWRnQ03ZbRGg7JqCtxdyhyL5Q5llZUFd40yWYc0/xNNkuqo8TuJoVUoKDUuuMGtIDcxMjiAW46wYeIUAdyZzE+MDA7gliNsmDhFAHcW81Mjg8e55Qgbpk4xzp3F/OTI4DFuOcKGyVOMcU95/lbBqVZ4OHGBqUHAhqf+DY81PhiuEBwpvJ1w/jK7XdDiXnnPddz57fV+dUMjg7vrTN3fs9vrEbHGg49vCw4/Ka+Lmn/4ynm+b8Xc+Jr04cQxrxQdj1PWxM5/IJA7TThxzCunyi1gfiHc6SOD4145HW5x84s5u4XVlM5uYQVucIMb3OAGN7jBDW5wg1sp7vlRBq0gEsH9B7fsygLvOjr3NDtlbhm93YLYDF3R/e+H7cv3ok7tbb4ZvUMPcamuovvfi9V2vfmlxjoeIjN0Rfe/F6s98KZqUzJ0l2kZutUM+ncpL7wr31GWBYpRMnqXC6SMXmd+0Rm0gvsvznBrP7MYNP+MyW/+nvhHQgX3X1zk1j641Qy/3GinFbjBDW5wgxvc4AY3uMEN7gy5E4TPpuLm0z+cO3H/hNzJ5/dxpw6fJXKL6O81mrB/LPek8/u4aeGzbHqudyOOO0V/Juk2jpvU35ed69lZLHeKcF5mY+xiQgifZdNzmY34i0nS/mzSbfzFJL6/LzvXuzPCxSRpOC+7t/FrNyE8l40ELCXiTtqfTbolXLtj+/uzc0uJuJOG87J783PTwmfTc6foryU5u4nhud7s3ETcqcJ5Q85ucvhsSu50/b1Jt9HcCfofaSm4U4bzejbGLyaU8NlJLiaJ+3uzVwkXE0J/Ns014cUkcTivd4PKzYTPCuAO78+Mnprb29+XncuFOzycl9mgc3vCc90JWx95cof0Z5NuJ+D+2X/U0R2fF/d4OG/A/H5uSvism55bGgbQMlG6sdyJ+7NJt7HchP5uR3d8Zv547gThvEHzj53dKcNnyWc3//6s0UT9CWf3ZPNTb1HFhc9Oeotqgv6kW1S0/ulvURHnxx1B3IAFN7jBDW5wgxvc4AY3uMEN7gm5F7lVMLfY/otLlFfeUBYtBXPb3HaQ63M/oSz8809f2mxgBWboWoFLY/rTM24XSJ+oVd92LXCoXtD8y4FLa2nmr1G/DF6/1oSW6P6rYttrVy+U4gA3uKXi3ihWRv/Or62ZRyE3fGmrsuAmTkZbJp7bOKz/TEUt2bshL6StyoKbOBltGS4mj+tiYuwXnSdAnQha7eStk2N4WjRN/1cbbVUW3MTJiMt4c2/NeWvQ/NB+5kbQaoPYyI0Pb56t5b45H3dXz4auejrH1pZobt/+YicbHkH4Ya745ufL3Z1ly53DjaDVh3P0/6c/lPPhrbnBqm70Km91xXL3AnYXNdncFuUwPdXTRFd/DjeClpnD+ZDnkx2xKuOKmuzFlnQH0J/DjaDVornDVmXPHToZyy3FAfTnGEbQ6ifn+T/29FOzcuxG0LLcYauy5w6djOXO/ACMz3tRf3rA5Y5ZlWHFTeZyy3IAzsPjL99pcdzRq+Sd/ye3tAcQxK1ueS4mChS4wQ1ucIMb3OAGtyTUq269VpT69egAlCDvucPOKXtqz7lH0NPU8VZXe+TdU2TanuLaQ285tCkBtNbqFmXZQiYHQIrQ3Vq10kYM8x2WX4KuOZMJN+cIXcHcMzK2SsS9IGMrcIMb3OAGN7jBDW5wgxvc8nEblq4127q63MkPIEvu4UNd7rNc+7ZtF03zSCXu5AeQJfddTX+Y9t6ataxTd4tJ6JWXO/QAfBm9UnCX7KOqXsp/a9SdFLc188J8fz4MJWNCeeXlDj0AX0avHNx37fOL/13mvg+31javbmuv3Ay4khLcoQfgz+iVgfuLXdx0nu7/PowcW8u9r7VH6WNKcEcdgCbf2W3ctY2GbR/vfXRi3qrV28Y/N8V6W1fm7I44ADZCVwruV05e5LvWvu3kflrWyUV+87um0NkddQC+1FgJuA1rT9uw65Z7vTbOz25+2G2FuCMOIFQ7yzeCzR9nxb/d8HZjp96z9vpfgro6Z3foAbCpuXJwf+1/IRq1mnXp/KGNk8b14Gz5Yrf3fKG80nKHHwCbmivPPZON/jvXh42Qn21kvmeS9ABwi+qXuUUFbnCDG9zgBje4wQ1ucIMb3OAGd7xRjlsArZ0RN98IXcFVS5PQG1zLmXAv8zuAJ5oc9eJKU7uulPo9XHCDG9zk4NvkNVnjx8pNDL5NXpM1xsUEF5PJuamRvMlP7skaK8a9NUcpeiSvP6F3S1BjQRG6gsuf0BtSPY0cycuWG+nLv/G0IoAzq1SJtpSTT96s34y5kyfaErklzfrNmDt5oi2RW9Ks36wqdaJtHLe8Wb+ZcqdNtI3lViMqV5VSPjgP3ChwgxvcKIHUq8rHcKroDe1pekN7mt7Q5lOkvzS9ukpZZUEzrhb4/Z3zjJ7SUotb+WcQwY0CN7jBDW5wgxvc4AY3im6ULDcU3BMaJcsNBfeE3OHBp+Dmzx0efApuAdwRwafg5s4dnRsKbt5nd1RuKLi5c0fkhoKbO3dU8Cm4BbwRDA8+BTd37ojgU3CLudGRJDcU3FO90QFucIMb3OAGN7jBDW5wo8ANbnCDW2T1cku8ygR3fFWXuVVVvqP7P/ZjCHp6helcAAAAAElFTkSuQmCC"></p><p>æ ¸å¿ƒæ€æƒ³æ˜¯å°†å¤§çš„ä»»åŠ¡æ‹†åˆ†æˆå¤šä¸ªå°ä»»åŠ¡ï¼ˆå³forkï¼‰ï¼Œç„¶ååœ¨å°†å¤šä¸ªå°ä»»åŠ¡å¤„ç†æ±‡æ€»åˆ°ä¸€ä¸ªç»“æœä¸Š</p><p>æä¾›åŸºæœ¬çš„çº¿ç¨‹æ± åŠŸèƒ½ï¼Œæ”¯æŒè®¾ç½®æœ€å¤§å¹¶å‘çº¿ç¨‹æ•°ï¼Œæ”¯æŒä»»åŠ¡æ’é˜Ÿï¼Œæ”¯æŒçº¿ç¨‹æ± åœæ­¢ï¼Œæ”¯æŒçº¿ç¨‹æ± ä½¿ç”¨æƒ…å†µç›‘æ§ï¼Œä¹Ÿæ˜¯AbstractExecutorServiceçš„å­ç±»ï¼Œä¸»è¦å¼•å…¥äº†â€œå·¥ä½œçªƒå–â€æœºåˆ¶ï¼Œåœ¨å¤šCPUè®¡ç®—æœºä¸Šå¤„ç†æ€§èƒ½æ›´ä½³</p><ul><li>ForkJoinPool </li></ul><p>ç”¨äºæ‰§è¡ŒForkJoinTaskä»»åŠ¡çš„æ‰§è¡Œæ± ï¼Œ ç»´æŠ¤ä¸€ä¸ªé˜Ÿåˆ—æ•°ç»„WorkQueue</p><ul><li>WorkQueue</li></ul><p>åŒå‘åˆ—è¡¨,ç”¨äºä»»åŠ¡çš„æœ‰åºæ‰§è¡Œ,å¦‚æœWorkQueueç”¨äºè‡ªå·±çš„æ‰§è¡Œçº¿ç¨‹Thread,çº¿ç¨‹é»˜è®¤å°†ä¼šä»topç«¯é€‰å–ä»»åŠ¡ç”¨æ¥æ‰§è¡Œ - LIFO</p><p>å› ä¸ºåªæœ‰ownerçš„Threadæ‰èƒ½ä»topç«¯å–ä»»åŠ¡,æ‰€ä»¥åœ¨è®¾ç½®å˜é‡æ—¶, int top; ä¸éœ€è¦ä½¿ç”¨ volatile</p><ul><li>ForkJoinWorkThread</li></ul><p>ç”¨äºæ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹,ç”¨äºåŒºåˆ«ä½¿ç”¨éForkJoinWorkThreadçº¿ç¨‹æäº¤çš„task;å¯åŠ¨ä¸€ä¸ªè¯¥Thread,ä¼šè‡ªåŠ¨æ³¨å†Œä¸€ä¸ªWorkQueueåˆ°Pool,è¿™é‡Œè§„å®š,æ‹¥æœ‰Threadçš„WorkQueueåªèƒ½å‡ºç°åœ¨WorkQueueæ•°ç»„çš„å¥‡æ•°ä½</p><ul><li>ForkJoinTask</li></ul><p>ä»»åŠ¡, å®ƒæ¯”ä¼ ç»Ÿçš„ä»»åŠ¡æ›´åŠ è½»é‡ï¼Œä¸å†å¯¹æ˜¯RUNNABLEçš„å­ç±»,æä¾›fork/joinæ–¹æ³•ç”¨äºåˆ†å‰²ä»»åŠ¡ä»¥åŠèšåˆç»“æœ</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="work-stealing-å·¥ä½œçªƒå–ç®—æ³•"></a>Work-Stealing å·¥ä½œçªƒå–ç®—æ³•<a class="hash-link" href="#work-stealing-å·¥ä½œçªƒå–ç®—æ³•" title="Direct link to heading">#</a></h3><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="forkjointask"></a>ForkJoinTask<a class="hash-link" href="#forkjointask" title="Direct link to heading">#</a></h3><p>ForkJoinTaskéœ€è¦é€šè¿‡ForkJoinPoolæ¥æ‰§è¡Œ</p><p>ForkJoinTaskå¯ä»¥ç†è§£ä¸ºç±»çº¿ç¨‹ä½†æ¯”çº¿ç¨‹è½»é‡çš„å®ä½“, åœ¨ForkJoinPoolä¸­è¿è¡Œçš„å°‘é‡ForkJoinWorkerThreadå¯ä»¥æŒæœ‰å¤§é‡çš„ForkJoinTaskå’Œå®ƒçš„å­ä»»åŠ¡.</p><p>ForkJoinTaskåŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ªè½»é‡çš„Future,ä½¿ç”¨æ—¶åº”é¿å…è¾ƒé•¿é˜»å¡å’Œio</p><p>ä½¿ç”¨ForkJoinæ¡†æ¶ï¼Œå¿…é¡»é¦–å…ˆåˆ›å»ºä¸€ä¸ªForkJoinä»»åŠ¡ï¼Œæä¾›åœ¨ä»»åŠ¡ä¸­æ‰§è¡Œfork()å’Œjoin()æ“ä½œçš„æœºåˆ¶.</p><p>å­ç±»:</p><ul><li>RecursiveAction ç”¨äºæ²¡æœ‰è¿”å›ç»“æœçš„ä»»åŠ¡</li><li>RecursiveTask ç”¨äºæœ‰è¿”å›ç»“æœçš„ä»»åŠ¡ã€‚</li></ul><blockquote><p>Recursive [rÉªËˆkÉœËsÉªv]</p></blockquote><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="recursivetaskclass"></a>RecursiveTask.class<a class="hash-link" href="#recursivetaskclass" title="Direct link to heading">#</a></h4><p>æœ‰è¿”å›å€¼</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public abstract class RecursiveTask&lt;V&gt; extends ForkJoinTask&lt;V&gt; {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private static final long serialVersionUID = 5232453952276485270L;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    /**</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     * The result of the computation.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">     */</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    V result;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // å­ç±»é‡å†™æ­¤æ–¹æ³•</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    protected abstract V compute();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public final V getRawResult() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return result;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    protected final void setRawResult(V value) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        result = value;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    protected final boolean exec() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        result = compute();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return true;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="recursiveactionclass"></a>RecursiveAction.class<a class="hash-link" href="#recursiveactionclass" title="Direct link to heading">#</a></h4><p>æ²¡æœ‰è¿”å›å€¼</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public abstract class RecursiveAction extends ForkJoinTask&lt;Void&gt; {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    protected abstract void compute();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public final Void getRawResult() { return null; }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    protected final void setRawResult(Void mustBeNull) { }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    protected final boolean exec() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        compute();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return true;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p><code>RecursiveAction</code> å’Œ <code>RecursiveTask</code></p><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="forkjointaskclass"></a>ForkJoinTask.class<a class="hash-link" href="#forkjointaskclass" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public abstract class ForkJoinTask&lt;V&gt; implements Future&lt;V&gt;, Serializable {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    volatile int status;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // åˆ†å‰²å‡½æ•°</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public final ForkJoinTask&lt;V&gt; fork() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        Thread t;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if ((t = Thread.currentThread()) instanceof ForkJoinWorkerThread)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // æ”¾å…¥é˜Ÿåˆ—</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            ((ForkJoinWorkerThread)t).workQueue.push(this);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        else</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            ForkJoinPool.common.externalPush(this);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return this;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public final V join() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        int s;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (((s = doJoin()) &amp; ABNORMAL) != 0)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            reportException(s);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return getRawResult();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public abstract V getRawResult();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // è·å–å½“å‰ä»»åŠ¡çš„çŠ¶æ€æ¥åˆ¤æ–­è¿”å›ä»€ä¹ˆç»“æœ</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private int doJoin() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        int s; Thread t; ForkJoinWorkerThread wt; ForkJoinPool.WorkQueue w;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        // å¦‚æœæ‰§è¡Œå®Œæ¯•ï¼Œè¿”å›ä»»åŠ¡çŠ¶æ€</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return (s = status) &lt; 0 ? s :</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            ((t = Thread.currentThread()) instanceof ForkJoinWorkerThread) ?</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // ä»ä»»åŠ¡æ•°ç»„é‡Œå–å‡ºä»»åŠ¡æ‰§è¡Œ</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            (w = (wt = (ForkJoinWorkerThread)t).workQueue).</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            tryUnpush(this) &amp;&amp; (s = doExec()) &lt; 0 ? s :</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // </span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            wt.pool.awaitJoin(w, this, 0L) :</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            externalAwaitDone();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    final int doExec() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        int s; boolean completed;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if ((s = status) &gt;= 0) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                completed = exec();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            } catch (Throwable rex) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                completed = false;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                s = setExceptionalCompletion(rex);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            if (completed)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                s = setDone();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return s;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    protected abstract boolean exec();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private int setDone() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        int s;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (((s = (int)STATUS.getAndBitwiseOr(this, DONE)) &amp; SIGNAL) != 0)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            synchronized (this) { notifyAll(); }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return s | DONE;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // é€‚é…å™¨</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    static final class RunnableExecuteAction extends ForkJoinTask&lt;Void&gt; {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        final Runnable runnable;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        RunnableExecuteAction(Runnable runnable) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            if (runnable == null) throw new NullPointerException();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            this.runnable = runnable;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        public final Void getRawResult() { return null; }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        public final void setRawResult(Void v) { }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        public final boolean exec() { runnable.run(); return true; }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        void internalPropagateException(Throwable ex) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            rethrow(ex); // rethrow outside exec() catches.</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        private static final long serialVersionUID = 5232453952276885070L;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="forkjoinpoolclass"></a>ForkJoinPool.class<a class="hash-link" href="#forkjoinpoolclass" title="Direct link to heading">#</a></h3><p>ForkJoinTaskéœ€è¦é€šè¿‡ForkJoinPoolæ¥æ‰§è¡Œï¼Œä»»åŠ¡åˆ†å‰²å‡ºçš„å­ä»»åŠ¡ä¼šæ·»åŠ åˆ°å½“å‰å·¥ä½œçº¿ç¨‹æ‰€ç»´æŠ¤çš„åŒç«¯é˜Ÿåˆ—ä¸­ï¼Œè¿›å…¥é˜Ÿåˆ—çš„å¤´éƒ¨</p><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="ç»“æ„å›¾-1"></a>ç»“æ„å›¾<a class="hash-link" href="#ç»“æ„å›¾-1" title="Direct link to heading">#</a></h4><p><img src="/docs.advanced.way/assets/images/ForkJoinPool-3b05ea1df1f35925d1c98b81c7676d79.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="åŸç†"></a>åŸç†<a class="hash-link" href="#åŸç†" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public class ForkJoinPool extends AbstractExecutorService {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public static interface ForkJoinWorkerThreadFactory {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        public ForkJoinWorkerThread newThread(ForkJoinPool pool);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // çº¿ç¨‹å·¥å‚</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private static final class DefaultForkJoinWorkerThreadFactory implements ForkJoinWorkerThreadFactory {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        private static final AccessControlContext ACC = contextWithPermissions(</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            new RuntimePermission(&quot;getClassLoader&quot;),</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            new RuntimePermission(&quot;setContextClassLoader&quot;));</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        // åˆ›å»º ForkJoinWorkerThread çº¿ç¨‹</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        public final ForkJoinWorkerThread newThread(ForkJoinPool pool) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            return AccessController.doPrivileged(</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                new PrivilegedAction&lt;&gt;() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    public ForkJoinWorkerThread run() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        return new ForkJoinWorkerThread(</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                            pool, ClassLoader.getSystemClassLoader()); }},</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                ACC);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // å·¥ä½œé˜Ÿåˆ—</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    @jdk.internal.vm.annotation.Contended</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    static final class WorkQueue {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        final void push(ForkJoinTask&lt;?&gt; task) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            ForkJoinTask&lt;?&gt;[] a;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            int s = top, d, cap, m;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            ForkJoinPool p = pool;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            if ((a = array) != null &amp;&amp; (cap = a.length) &gt; 0) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                // æ”¾å…¥ForkJoinTaskæ•°ç»„é˜Ÿåˆ—é‡Œ</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                QA.setRelease(a, (m = cap - 1) &amp; s, task);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                top = s + 1;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (((d = s - (int)BASE.getAcquire(this)) &amp; ~1) == 0 &amp;&amp; p != null) {                 // size 0 or 1</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    VarHandle.fullFence();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    // å”¤é†’æˆ–åˆ›å»ºä¸€ä¸ªå·¥ä½œçº¿ç¨‹æ‰§è¡Œä»»åŠ¡</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    p.signalWork();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                else if (d == m)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    growArray(false);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public void execute(ForkJoinTask&lt;?&gt; task) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        externalSubmit(task);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public void execute(Runnable task) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (task == null)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            throw new NullPointerException();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        ForkJoinTask&lt;?&gt; job;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (task instanceof ForkJoinTask&lt;?&gt;) // avoid re-wrap</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            job = (ForkJoinTask&lt;?&gt;) task;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        else</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // è½¬æ¢æˆ ForkJoinTask</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            job = new ForkJoinTask.RunnableExecuteAction(task);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        externalSubmit(job);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private &lt;T&gt; ForkJoinTask&lt;T&gt; externalSubmit(ForkJoinTask&lt;T&gt; task) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        Thread t; ForkJoinWorkerThread w; WorkQueue q;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (task == null)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            throw new NullPointerException();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (((t = Thread.currentThread()) instanceof ForkJoinWorkerThread) &amp;&amp;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            (w = (ForkJoinWorkerThread)t).pool == this &amp;&amp;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            (q = w.workQueue) != null)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            // æ”¾å…¥å·¥ä½œé˜Ÿåˆ—ä¸­</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            q.push(task);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        else</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            externalPush(task);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return task;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    final void externalPush(ForkJoinTask&lt;?&gt; task) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        int r;                                // initialize caller&#x27;s probe</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if ((r = ThreadLocalRandom.getProbe()) == 0) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            ThreadLocalRandom.localInit();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            r = ThreadLocalRandom.getProbe();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        for (;;) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            WorkQueue q;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            int md = mode, n;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            WorkQueue[] ws = workQueues;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            if ((md &amp; SHUTDOWN) != 0 || ws == null || (n = ws.length) &lt;= 0)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                throw new RejectedExecutionException();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            else if ((q = ws[(n - 1) &amp; r &amp; SQMASK]) == null) { // add queue</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                int qid = (r | QUIET) &amp; ~(FIFO | OWNED);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                Object lock = workerNamePrefix;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                ForkJoinTask&lt;?&gt;[] qa =</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    new ForkJoinTask&lt;?&gt;[INITIAL_QUEUE_CAPACITY];</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                q = new WorkQueue(this, null);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                q.array = qa;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                q.id = qid;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                q.source = QUIET;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (lock != null) {     // unless disabled, lock pool to install</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    synchronized (lock) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        WorkQueue[] vs; int i, vn;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        if ((vs = workQueues) != null &amp;&amp; (vn = vs.length) &gt; 0 &amp;&amp;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                            vs[i = qid &amp; (vn - 1) &amp; SQMASK] == null)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                            vs[i] = q;  // else another thread already installed</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            else if (!q.tryLockPhase()) // move if busy</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                r = ThreadLocalRandom.advanceProbe(r);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            else {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (q.lockedPush(task))</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    signalWork();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                return;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // å”¤é†’æˆ–åˆ›å»ºä¸€ä¸ªå·¥ä½œçº¿ç¨‹æ‰§è¡Œä»»åŠ¡</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    final void signalWork() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        for (;;) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            long c; int sp; WorkQueue[] ws; int i; WorkQueue v;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            if ((c = ctl) &gt;= 0L)                      // enough workers</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                break;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            else if ((sp = (int)c) == 0) {            // no idle workers</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if ((c &amp; ADD_WORKER) != 0L)           // too few workers</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    tryAddWorker(c);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                break;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            else if ((ws = workQueues) == null)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                break;                                // unstarted/terminated</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            else if (ws.length &lt;= (i = sp &amp; SMASK))</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                break;                                // terminated</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            else if ((v = ws[i]) == null)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                break;                                // terminating</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            else {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                int np = sp &amp; ~UNSIGNALLED;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                int vp = v.phase;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                long nc = (v.stackPred &amp; SP_MASK) | (UC_MASK &amp; (c + RC_UNIT));</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                Thread vt = v.owner;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (sp == vp &amp;&amp; CTL.compareAndSet(this, c, nc)) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    v.phase = np;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    if (vt != null &amp;&amp; v.source &lt; 0)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        // å”¤é†’å·¥ä½œçº¿ç¨‹</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        LockSupport.unpark(vt);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    break;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private void tryAddWorker(long c) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        do {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            long nc = ((RC_MASK &amp; (c + RC_UNIT)) |</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                       (TC_MASK &amp; (c + TC_UNIT)));</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            if (ctl == c &amp;&amp; CTL.compareAndSet(this, c, nc)) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                createWorker();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                break;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        } while (((c = ctl) &amp; ADD_WORKER) != 0L &amp;&amp; (int)c == 0);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    // åˆ›å»ºå·¥ä½œçº¿ç¨‹</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    private boolean createWorker() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        ForkJoinWorkerThreadFactory fac = factory;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        Throwable ex = null;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        ForkJoinWorkerThread wt = null;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            if (fac != null &amp;&amp; (wt = fac.newThread(this)) != null) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                wt.start();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                return true;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        } catch (Throwable rex) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            ex = rex;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        deregisterWorker(wt, ex);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return false;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    final void runWorker(WorkQueue w) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        int r = (w.id ^ ThreadLocalRandom.nextSecondarySeed()) | FIFO; // rng</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        w.array = new ForkJoinTask&lt;?&gt;[INITIAL_QUEUE_CAPACITY]; // initialize</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        for (;;) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            int phase;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            if (scan(w, r)) {                     // scan until apparently empty</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                r ^= r &lt;&lt; 13; r ^= r &gt;&gt;&gt; 17; r ^= r &lt;&lt; 5; // move (xorshift)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            else if ((phase = w.phase) &gt;= 0) {    // enqueue, then rescan</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                long np = (w.phase = (phase + SS_SEQ) | UNSIGNALLED) &amp; SP_MASK;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                long c, nc;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                do {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    w.stackPred = (int)(c = ctl);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    nc = ((c - RC_UNIT) &amp; UC_MASK) | np;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                } while (!CTL.weakCompareAndSet(this, c, nc));</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            else {                                // already queued</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                int pred = w.stackPred;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                Thread.interrupted();             // clear before park</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                w.source = DORMANT;               // enable signal</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                long c = ctl;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                int md = mode, rc = (md &amp; SMASK) + (int)(c &gt;&gt; RC_SHIFT);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                if (md &lt; 0)                       // terminating</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    break;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                else if (rc &lt;= 0 &amp;&amp; (md &amp; SHUTDOWN) != 0 &amp;&amp;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                         tryTerminate(false, false))</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    break;                        // quiescent shutdown</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                else if (rc &lt;= 0 &amp;&amp; pred != 0 &amp;&amp; phase == (int)c) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    long nc = (UC_MASK &amp; (c - TC_UNIT)) | (SP_MASK &amp; pred);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    long d = keepAlive + System.currentTimeMillis();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    LockSupport.parkUntil(this, d);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    if (ctl == c &amp;&amp;               // drop on timeout if all idle</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        d - System.currentTimeMillis() &lt;= TIMEOUT_SLOP &amp;&amp;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        CTL.compareAndSet(this, c, nc)) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        w.phase = QUIET;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        break;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                else if (w.phase &lt; 0)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    LockSupport.park(this);       // OK if spuriously woken</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                w.source = 0;                     // disable signal</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="forkjoinworkerthreadclass"></a>ForkJoinWorkerThread.class<a class="hash-link" href="#forkjoinworkerthreadclass" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:rgb(36, 41, 46);background-color:#f6f8fa"><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">public class ForkJoinWorkerThread extends Thread {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    final ForkJoinPool pool;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    final ForkJoinPool.WorkQueue workQueue;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    protected ForkJoinWorkerThread(ForkJoinPool pool) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        super(&quot;aForkJoinWorkerThread&quot;);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        this.pool = pool;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        this.workQueue = pool.registerWorker(this);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public ForkJoinPool getPool() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return pool;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public int getPoolIndex() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        return workQueue.getPoolIndex();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    public void run() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        if (workQueue.array == null) { // only run once</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            Throwable exception = null;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                onStart();</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                pool.runWorker(workQueue);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            } catch (Throwable ex) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                exception = ex;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            } finally {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                try {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    onTermination(exception);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                } catch (Throwable ex) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    if (exception == null)</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                        exception = ex;</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                } finally {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                    pool.deregisterWorker(this, exception);</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">                }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">            }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">        }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    protected void onStart() {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    protected void onTermination(Throwable exception) {</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">    }</span></div><div class="token-line" style="color:rgb(36, 41, 46)"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/Goldwood1024/docs.advanced.way/docs/docs/java/hc/çº¿ç¨‹æ± .md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col text--right"><em><small>Last updated on <time datetime="2021-03-22T07:06:00.000Z" class="lastUpdatedDate_1WI_">3/22/2021</time></small></em></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs.advanced.way/docs/java/hc/å¹¶å‘å·¥å…·ç±»"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« å¹¶å‘å·¥å…·ç±»</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs.advanced.way/docs/java/hc/é”"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">é” Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#çº¿ç¨‹æ± ç®€ä»‹" class="table-of-contents__link">çº¿ç¨‹æ± ç®€ä»‹</a><ul><li><a href="#executor-æ¡†æ¶" class="table-of-contents__link">Executor æ¡†æ¶</a></li></ul></li><li><a href="#æ¶æ„å›¾" class="table-of-contents__link">æ¶æ„å›¾</a><ul><li><a href="#æ ¸å¿ƒç±»" class="table-of-contents__link">æ ¸å¿ƒç±»</a></li></ul></li><li><a href="#threadpoolexecutor" class="table-of-contents__link">ThreadPoolExecutor</a><ul><li><a href="#ç»“æ„å›¾" class="table-of-contents__link">ç»“æ„å›¾</a></li><li><a href="#æ‰§è¡Œæµç¨‹" class="table-of-contents__link">æ‰§è¡Œæµç¨‹</a></li><li><a href="#threadpoolexecutorclass" class="table-of-contents__link">ThreadPoolExecutor.class</a></li><li><a href="#worker" class="table-of-contents__link">Worker</a></li><li><a href="#æ‹’ç»ç­–ç•¥" class="table-of-contents__link">æ‹’ç»ç­–ç•¥</a></li><li><a href="#ä»»åŠ¡é˜Ÿåˆ—" class="table-of-contents__link">ä»»åŠ¡é˜Ÿåˆ—</a></li><li><a href="#åˆç†çš„é…ç½®çº¿ç¨‹æ± " class="table-of-contents__link">åˆç†çš„é…ç½®çº¿ç¨‹æ± </a></li></ul></li><li><a href="#executors" class="table-of-contents__link">Executors</a><ul><li><a href="#fixedthreadpool" class="table-of-contents__link">FixedThreadPool</a></li><li><a href="#singlethreadexecutor" class="table-of-contents__link">SingleThreadExecutor</a></li><li><a href="#cachedthreadpool" class="table-of-contents__link">CachedThreadPool</a></li><li><a href="#scheduledthreadpool" class="table-of-contents__link">ScheduledThreadPool</a></li><li><a href="#workstealingpool" class="table-of-contents__link">WorkStealingPool</a></li></ul></li><li><a href="#forkjoin-æ¡†æ¶" class="table-of-contents__link">Fork/Join æ¡†æ¶</a><ul><li><a href="#work-stealing-å·¥ä½œçªƒå–ç®—æ³•" class="table-of-contents__link">Work-Stealing å·¥ä½œçªƒå–ç®—æ³•</a></li><li><a href="#forkjointask" class="table-of-contents__link">ForkJoinTask</a></li><li><a href="#forkjoinpoolclass" class="table-of-contents__link">ForkJoinPool.class</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 è¿›é˜¶ä¹‹è·¯, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/docs.advanced.way/assets/js/styles.d2979f79.js"></script>
<script src="/docs.advanced.way/assets/js/runtime~main.c79be437.js"></script>
<script src="/docs.advanced.way/assets/js/main.a0c081f8.js"></script>
<script src="/docs.advanced.way/assets/js/1.68ccfdd8.js"></script>
<script src="/docs.advanced.way/assets/js/2.0ae89a79.js"></script>
<script src="/docs.advanced.way/assets/js/3.ef70b8bc.js"></script>
<script src="/docs.advanced.way/assets/js/1be78505.8900d4c5.js"></script>
<script src="/docs.advanced.way/assets/js/202.499d5c45.js"></script>
<script src="/docs.advanced.way/assets/js/935f2afb.410f6dda.js"></script>
<script src="/docs.advanced.way/assets/js/17896441.a99ce0cd.js"></script>
<script src="/docs.advanced.way/assets/js/6424d8c8.473276fb.js"></script>
</body>
</html>