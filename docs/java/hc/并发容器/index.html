<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.75">
<link rel="alternate" type="application/rss+xml" href="/docs.advanced.way/blog/rss.xml" title="è¿›é˜¶ä¹‹è·¯ Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/docs.advanced.way/blog/atom.xml" title="è¿›é˜¶ä¹‹è·¯ Blog Atom Feed"><title data-react-helmet="true">å¹¶å‘å®¹å™¨ | è¿›é˜¶ä¹‹è·¯</title><meta data-react-helmet="true" property="og:url" content="https://Goldwood1024.github.io/docs.advanced.way/docs/java/hc/å¹¶å‘å®¹å™¨"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="å¹¶å‘å®¹å™¨ | è¿›é˜¶ä¹‹è·¯"><meta data-react-helmet="true" name="description" content="ConcurrentHashMap"><meta data-react-helmet="true" property="og:description" content="ConcurrentHashMap"><link data-react-helmet="true" rel="shortcut icon" href="/docs.advanced.way/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://Goldwood1024.github.io/docs.advanced.way/docs/java/hc/å¹¶å‘å®¹å™¨"><link data-react-helmet="true" rel="alternate" href="https://Goldwood1024.github.io/docs.advanced.way/docs/java/hc/å¹¶å‘å®¹å™¨" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://Goldwood1024.github.io/docs.advanced.way/docs/java/hc/å¹¶å‘å®¹å™¨" hreflang="x-default"><link rel="stylesheet" href="/docs.advanced.way/assets/css/styles.5e159b62.css">
<link rel="preload" href="/docs.advanced.way/assets/js/runtime~main.aa1c8b94.js" as="script">
<link rel="preload" href="/docs.advanced.way/assets/js/main.8fae9188.js" as="script">
</head>
<body>
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_2qcr"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/docs.advanced.way/"><img src="/docs.advanced.way/img/logo.svg" alt="è¿›é˜¶ä¹‹è·¯ Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/docs.advanced.way/img/logo.svg" alt="è¿›é˜¶ä¹‹è·¯ Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">è¿›é˜¶ä¹‹è·¯</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs.advanced.way/docs/java/">Java</a><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link">ç”Ÿæ€</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs.advanced.way/docs/zoology/spring-family/">Springå®¶æ—</a></li><li><a class="dropdown__link" href="/docs.advanced.way/docs/zoology/framework/mybatis/">å¸¸ç”¨æ¡†æ¶</a></li><li><a class="dropdown__link" href="/docs.advanced.way/docs/zoology/distributed/">åˆ†å¸ƒå¼</a></li><li><a class="dropdown__link" href="/docs.advanced.way/docs/zoology/cloud/docker/base/é•œåƒ/">å®¹å™¨</a></li><li><a class="dropdown__link" href="/docs.advanced.way/docs/zoology/db/mysql/InnoDB/">æ•°æ®åº“</a></li><li><a class="dropdown__link" href="/docs.advanced.way/docs/zoology/os/network/tcpip/">è®¡ç®—æœºç³»ç»Ÿ</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link">ç¼–ç å®è·µ</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs.advanced.way/docs/algorithm/algorithm/">ç®—æ³•/æ•°æ®ç»“æ„</a></li><li><a class="dropdown__link" href="/docs.advanced.way/docs/patterns/">è®¾è®¡æ¨¡å¼</a></li><li><a class="dropdown__link" href="/docs.advanced.way/docs/architecture/">ç³»ç»Ÿæ¶æ„</a></li><li><a class="dropdown__link" href="/docs.advanced.way/docs/practice/memo/tool/sublime/">å¤‡å¿˜å½•</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs.advanced.way/blog">åšå®¢</a><a href="https://github.com/Goldwood1024/docs.advanced.way.git" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ğŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ğŸŒ</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/docs.advanced.way/"><img src="/docs.advanced.way/img/logo.svg" alt="è¿›é˜¶ä¹‹è·¯ Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/docs.advanced.way/img/logo.svg" alt="è¿›é˜¶ä¹‹è·¯ Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">è¿›é˜¶ä¹‹è·¯</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs.advanced.way/docs/java/">Java</a></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">ç”Ÿæ€</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/zoology/spring-family/">Springå®¶æ—</a></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/zoology/framework/mybatis/">å¸¸ç”¨æ¡†æ¶</a></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/zoology/distributed/">åˆ†å¸ƒå¼</a></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/zoology/cloud/docker/base/é•œåƒ/">å®¹å™¨</a></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/zoology/db/mysql/InnoDB/">æ•°æ®åº“</a></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/zoology/os/network/tcpip/">è®¡ç®—æœºç³»ç»Ÿ</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">ç¼–ç å®è·µ</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/algorithm/algorithm/">ç®—æ³•/æ•°æ®ç»“æ„</a></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/patterns/">è®¾è®¡æ¨¡å¼</a></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/architecture/">ç³»ç»Ÿæ¶æ„</a></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/docs/practice/memo/tool/sublime/">å¤‡å¿˜å½•</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/docs.advanced.way/blog">åšå®¢</a></li><li class="menu__list-item"><a href="https://github.com/Goldwood1024/docs.advanced.way.git" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo sidebarWithHideableNavbar_267A"><a tabindex="-1" class="sidebarLogo_3h0W" href="/docs.advanced.way/"><img src="/docs.advanced.way/img/logo.svg" alt="è¿›é˜¶ä¹‹è·¯ Logo" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/docs.advanced.way/img/logo.svg" alt="è¿›é˜¶ä¹‹è·¯ Logo" class="themedImage_1VuW themedImage--dark_hz6m"><strong>è¿›é˜¶ä¹‹è·¯</strong></a><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">åŸºç¡€</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/">ç®€ä»‹</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/object">é¢å‘å¯¹è±¡</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/æ•°æ®ç±»å‹">æ•°æ®ç±»å‹</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/å…³é”®å­—">å…³é”®å­—</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/String">String</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/io">I/O</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/nio">NIO</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/Reference">å¯¹è±¡å¼•ç”¨</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/ä»£ç†">ä»£ç†</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/å‡½æ•°å¼æ¥å£">å‡½æ•°å¼æ¥å£</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/åå°„">åå°„</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/base64">Base64ç¼–ç </a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/base/jdk">JDK</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">é›†åˆ</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/collection/Collection">Collection</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/collection/List">List</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/collection/Map">Map</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">é«˜å¹¶å‘</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs.advanced.way/docs/java/hc/é«˜å¹¶å‘">é«˜å¹¶å‘</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs.advanced.way/docs/java/hc/å¤šçº¿ç¨‹">å¤šçº¿ç¨‹</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs.advanced.way/docs/java/hc/å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯">å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs.advanced.way/docs/java/hc/å†…å­˜æ¨¡å‹">å†…å­˜æ¨¡å‹</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs.advanced.way/docs/java/hc/åŸå­ç±»">åŸå­ç±»</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs.advanced.way/docs/java/hc/å¹¶å‘å®¹å™¨">å¹¶å‘å®¹å™¨</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs.advanced.way/docs/java/hc/å¹¶å‘å·¥å…·ç±»">å¹¶å‘å·¥å…·ç±»</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs.advanced.way/docs/java/hc/çº¿ç¨‹æ± ">çº¿ç¨‹æ± </a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs.advanced.way/docs/java/hc/é”">é”</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">JVM</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/jvm/å¯¹è±¡åˆ›å»ºè¿‡ç¨‹">å¯¹è±¡åˆ›å»ºè¿‡ç¨‹</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/jvm/å¯¹è±¡å›æ”¶æœºåˆ¶">å¯¹è±¡å›æ”¶æœºåˆ¶</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/jvm/jvmå‚æ•°">JVMå‚æ•°</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/jvm/jvmå†…å­˜æ¨¡å‹">å†…å­˜æ¨¡å‹</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/jvm/å†…å­˜ä¼˜åŒ–">å†…å­˜ä¼˜åŒ–</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs.advanced.way/docs/java/jvm/åƒåœ¾æ”¶é›†å™¨">åƒåœ¾æ”¶é›†å™¨</a></li></ul></li></ul></div><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_1CGd"><svg width="20" height="20" role="img" class="collapseSidebarButtonIcon_3E-R"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><header><h1 class="docTitle_3a4h">å¹¶å‘å®¹å™¨</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="concurrenthashmap"></a>ConcurrentHashMap<a class="hash-link" href="#concurrenthashmap" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="ç»“æ„"></a>ç»“æ„<a class="hash-link" href="#ç»“æ„" title="Direct link to heading">#</a></h3><p><img src="/docs.advanced.way/assets/images/ConcurrentHashMap-4d91e2e7d773b275171bf9cca2bfeab0.png"></p><p>CASæ— é”ç®—æ³•ä¸synchronizedä¿è¯å¹¶å‘å®‰å…¨ï¼Œæ”¯æŒå¹¶å‘æ‰©å®¹ï¼Œæ•°æ®ç»“æ„å˜æ›´ä¸ºæ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘ï¼Œæé«˜æ€§èƒ½ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="æºç "></a>æºç <a class="hash-link" href="#æºç " title="Direct link to heading">#</a></h3><p><img src="/docs.advanced.way/assets/images/1162587-20190217130653916-1383228669-83d3407356d1aa2a0e47cae207a2dfc3.png"></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">public interface Map&lt;K, V&gt; {}</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">public interface ConcurrentMap&lt;K,V&gt; extends Map&lt;K,V&gt; {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractMap&lt;K,V&gt; implements Map&lt;K,V&gt; {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public abstract Set&lt;Entry&lt;K,V&gt;&gt; entrySet();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p><code>Map</code> <a href="/docs.advanced.way/docs/java/collection/Map">æ¥å£å®šä¹‰</a></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">public class ConcurrentHashMap&lt;K,V&gt; extends AbstractMap&lt;K,V&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    implements ConcurrentMap&lt;K,V&gt;, Serializable {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private static final int MAXIMUM_CAPACITY = 1 &lt;&lt; 30;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private static final int DEFAULT_CAPACITY = 16;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    static final int MAX_ARRAY_SIZE = Integer.MAX_VALUE - 8;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private static final int DEFAULT_CONCURRENCY_LEVEL = 16;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private static final float LOAD_FACTOR = 0.75f;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    static final int TREEIFY_THRESHOLD = 8;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    static final int UNTREEIFY_THRESHOLD = 6;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    static final int MIN_TREEIFY_CAPACITY = 64;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private static final int MIN_TRANSFER_STRIDE = 16;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private static final int RESIZE_STAMP_BITS = 16;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private static final int MAX_RESIZERS = (1 &lt;&lt; (32 - RESIZE_STAMP_BITS)) - 1;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private static final int RESIZE_STAMP_SHIFT = 32 - RESIZE_STAMP_BITS;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    static final int MOVED     = -1; // hash for forwarding nodes</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    static final int TREEBIN   = -2; // hash for roots of trees</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    static final int RESERVED  = -3; // hash for transient reservations</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    static final int HASH_BITS = 0x7fffffff; // usable bits of normal node hash</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    static final int NCPU = Runtime.getRuntime().availableProcessors();</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // åˆ›å»ºç©ºè¡¨</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    transient volatile Node&lt;K,V&gt;[] table;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // åˆ›å»ºç©ºè¡¨ï¼Œæ‰©å®¹æ—¶ä½¿ç”¨</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private transient volatile Node&lt;K,V&gt;[] nextTable;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private transient volatile long baseCount;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // æ§åˆ¶ table åˆå§‹åŒ–æˆ–æ‰©å®¹</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // 0ä»£è¡¨hashè¡¨è¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // è´Ÿæ•°ä»£è¡¨æ­£åœ¨è¿›è¡Œåˆå§‹åŒ–æˆ–æ‰©å®¹æ“ä½œ</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // -1ä»£è¡¨æ­£åœ¨åˆå§‹åŒ–</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // -ï¼ˆN+1ï¼‰ è¡¨ç¤ºæœ‰Nä¸ªçº¿ç¨‹æ­£åœ¨è¿›è¡Œæ‰©å®¹æ“ä½œ</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // æ­£æ•°æ•°å€¼è¡¨ç¤ºä¸‹ä¸€æ¬¡è¿›è¡Œæ‰©å®¹çš„é˜ˆå€¼ï¼Œæ˜¯å½“å‰ConcurrentHashMapå®¹é‡çš„0.75å€ï¼Œè¿™ä¸loadfactoræ˜¯å¯¹åº”çš„</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private transient volatile int sizeCtl;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // Map.Entry å®ç°ç±»</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    static final class MapEntry&lt;K,V&gt; implements Map.Entry&lt;K,V&gt; {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        final K key; // non-null</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        V val;       // non-null</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        final ConcurrentHashMap&lt;K,V&gt; map;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        MapEntry(K key, V val, ConcurrentHashMap&lt;K,V&gt; map) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            this.key = key;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            this.val = val;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            this.map = map;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        public K getKey()        { return key; }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        public V getValue()      { return val; }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        public int hashCode()    { return key.hashCode() ^ val.hashCode(); }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        public String toString() {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            return Helpers.mapEntryToString(key, val);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        public boolean equals(Object o) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            Object k, v; Map.Entry&lt;?,?&gt; e;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            return ((o instanceof Map.Entry) &amp;&amp;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    (k = (e = (Map.Entry&lt;?,?&gt;)o).getKey()) != null &amp;&amp;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    (v = e.getValue()) != null &amp;&amp;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    (k == key || k.equals(key)) &amp;&amp;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    (v == val || v.equals(val)));</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        public V setValue(V value) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            if (value == null) throw new NullPointerException();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            V v = val;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            val = value;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            map.put(key, value);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            return v;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public V put(K key, V value) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        return putVal(key, value, false);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    final V putVal(K key, V value, boolean onlyIfAbsent) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // key value éƒ½ä¸èƒ½ä¸ºç©º</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        if (key == null || value == null) throw new NullPointerException();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // hash å€¼</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        int hash = spread(key.hashCode());</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // ç”¨äºè®°å½•ç›¸åº”é“¾è¡¨çš„é•¿åº¦</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        int binCount = 0;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // è‡ªæ—‹</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        for (Node&lt;K,V&gt;[] tab = table;;) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            Node&lt;K,V&gt; f;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            int n, i, fh;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            K fk;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            V fv;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // åˆå§‹åŒ–</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            if (tab == null || (n = tab.length) == 0)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                tab = initTable();</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // æ‰¾è¯¥ hash å€¼å¯¹åº”çš„æ•°ç»„ä¸‹æ ‡ï¼Œå¾—åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ f</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            else if ((f = tabAt(tab, i = (n - 1) &amp; hash)) == null) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                // å¦‚æœæ•°ç»„è¯¥ä½ç½®ä¸ºç©º ç”¨ä¸€æ¬¡ CAS æ“ä½œå°†è¿™ä¸ªæ–°å€¼æ”¾å…¥å…¶ä¸­</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                if (casTabAt(tab, i, null, new Node&lt;K,V&gt;(hash, key, value)))</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    // cas æˆåŠŸé€€å‡º</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    break;                   // no lock when adding to empty bin</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            else if ((fh = f.hash) == MOVED)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                // å¸®åŠ©æ•°æ®è¿ç§»</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                tab = helpTransfer(tab, f);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            else if (onlyIfAbsent // check first node without acquiring lock</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                     &amp;&amp; fh == hash</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                     &amp;&amp; ((fk = f.key) == key || (fk != null &amp;&amp; key.equals(fk)))</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                     &amp;&amp; (fv = f.val) != null)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                return fv;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            else {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                V oldVal = null;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                // f æ˜¯è¯¥ä½ç½®çš„å¤´ç»“ç‚¹ï¼Œè€Œä¸”ä¸ä¸ºç©º</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                synchronized (f) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    if (tabAt(tab, i) == f) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        // å¤´ç»“ç‚¹çš„ hash å€¼å¤§äº 0ï¼Œè¯´æ˜æ˜¯é“¾è¡¨</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        if (fh &gt;= 0) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            // ç”¨äºç´¯åŠ ï¼Œè®°å½•é“¾è¡¨çš„é•¿åº¦</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            binCount = 1;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            for (Node&lt;K,V&gt; e = f;; ++binCount) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                K ek;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                // å¦‚æœå‘ç°äº†&quot;ç›¸ç­‰&quot;çš„ keyï¼Œåˆ¤æ–­æ˜¯å¦è¦è¿›è¡Œå€¼è¦†ç›–ï¼Œç„¶åä¹Ÿå°±å¯ä»¥ break äº†</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                if (e.hash == hash &amp;&amp;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                    ((ek = e.key) == key ||</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                     (ek != null &amp;&amp; key.equals(ek)))) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                    oldVal = e.val;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                    if (!onlyIfAbsent)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                        e.val = value;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                    break;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                Node&lt;K,V&gt; pred = e;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                // åˆ°äº†é“¾è¡¨çš„æœ€æœ«ç«¯ï¼Œå°†è¿™ä¸ªæ–°å€¼æ”¾åˆ°é“¾è¡¨çš„æœ€åé¢</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                if ((e = e.next) == null) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                    pred.next = new Node&lt;K,V&gt;(hash, key, value);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                    break;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        // çº¢é»‘æ ‘</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        else if (f instanceof TreeBin) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            Node&lt;K,V&gt; p;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            binCount = 2;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            if ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                                           value)) != null) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                oldVal = p.val;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                if (!onlyIfAbsent)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                    p.val = value;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        else if (f instanceof ReservationNode)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            throw new IllegalStateException(&quot;Recursive update&quot;);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                // binCount != 0 è¯´æ˜ä¸Šé¢åœ¨åšé“¾è¡¨æ“ä½œ</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                if (binCount != 0) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    // åˆ¤æ–­æ˜¯å¦è¦å°†é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    if (binCount &gt;= TREEIFY_THRESHOLD)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        treeifyBin(tab, i);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    if (oldVal != null)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        return oldVal;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        addCount(1L, binCount);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        return null;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    static final int spread(int h) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        return (h ^ (h &gt;&gt;&gt; 16)) &amp; HASH_BITS;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // åˆå§‹åŒ–ä¸€ä¸ªåˆé€‚å¤§å°çš„æ•°ç»„ï¼Œç„¶åä¼šè®¾ç½® sizeCtl</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private final Node&lt;K,V&gt;[] initTable() {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Node&lt;K,V&gt;[] tab; int sc;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        while ((tab = table) == null || tab.length == 0) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // åˆå§‹åŒ–çš„æ“ä½œè¢«å…¶ä»–çº¿ç¨‹æ‰§è¡Œ</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            if ((sc = sizeCtl) &lt; 0)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                Thread.yield(); // lost initialization race; just spin</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // CAS ä¸€ä¸‹ï¼Œå°† sizeCtl è®¾ç½®ä¸º -1ï¼Œä»£è¡¨æŠ¢åˆ°äº†é”</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            else if (U.compareAndSetInt(this, SIZECTL, sc, -1)) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                try {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    if ((tab = table) == null || tab.length == 0) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        // é»˜è®¤å®¹é‡å¤§å°</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        int n = (sc &gt; 0) ? sc : DEFAULT_CAPACITY;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        // åˆå§‹åŒ– Node æ•°ç»„</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])new Node&lt;?,?&gt;[n];</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        table = tab = nt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        sc = n - (n &gt;&gt;&gt; 2);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                } finally {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    // 12</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    sizeCtl = sc;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                break;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        return tab;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">     private final void treeifyBin(Node&lt;K,V&gt;[] tab, int index) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Node&lt;K,V&gt; b; int n;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        if (tab != null) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // æ•°ç»„å°äº 64ï¼Œæ‰©å®¹</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            if ((n = tab.length) &lt; MIN_TREEIFY_CAPACITY)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                // åŠ å€</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                tryPresize(n &lt;&lt; 1);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // æ ‘åŒ–</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            else if ((b = tabAt(tab, index)) != null &amp;&amp; b.hash &gt;= 0) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                synchronized (b) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    if (tabAt(tab, index) == b) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        TreeNode&lt;K,V&gt; hd = null, tl = null;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        for (Node&lt;K,V&gt; e = b; e != null; e = e.next) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            TreeNode&lt;K,V&gt; p =</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                new TreeNode&lt;K,V&gt;(e.hash, e.key, e.val,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                                  null, null);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            if ((p.prev = tl) == null)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                hd = p;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            else</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                tl.next = p;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            tl = p;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        setTabAt(tab, index, new TreeBin&lt;K,V&gt;(hd));</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // ABASE è¡¨ç¤º tableä¸­é¦–ä¸ªå…ƒç´ çš„å†…å­˜åç§»åœ°å€ï¼Œæ‰€ä»¥(long)i &lt;&lt; ASHIFT) + ABASE å¾—åˆ° table[i] çš„å†…å­˜åç§»åœ°</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    static final &lt;K,V&gt; Node&lt;K,V&gt; tabAt(Node&lt;K,V&gt;[] tab, int i) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        return (Node&lt;K,V&gt;)U.getObjectAcquire(tab, ((long)i &lt;&lt; ASHIFT) + ABASE);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    static final &lt;K,V&gt; boolean casTabAt(Node&lt;K,V&gt;[] tab, int i,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                        Node&lt;K,V&gt; c, Node&lt;K,V&gt; v) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        return U.compareAndSetObject(tab, ((long)i &lt;&lt; ASHIFT) + ABASE, c, v);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    static final &lt;K,V&gt; void setTabAt(Node&lt;K,V&gt;[] tab, int i, Node&lt;K,V&gt; v) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        U.putObjectVolatile(tab, ((long)i &lt;&lt; ASHIFT) + ABASE, v);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // 1. æ£€æµ‹æ˜¯å¦éœ€è¦æ‰©å®¹ 2. æ›´æ–°ç»“ç‚¹æ•°é‡</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private final void addCount(long x, int check) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        CounterCell[] cs; long b, s;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        if ((cs = counterCells) != null ||</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            !U.compareAndSetLong(this, BASECOUNT, b = baseCount, s = b + x)) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            CounterCell c; long v; int m;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            boolean uncontended = true;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            if (cs == null || (m = cs.length - 1) &lt; 0 ||</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                (c = cs[ThreadLocalRandom.getProbe() &amp; m]) == null ||</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                !(uncontended =</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                  U.compareAndSetLong(c, CELLVALUE, v = c.value, v + x))) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                fullAddCount(x, uncontended);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                return;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            if (check &lt;= 1)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                return;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            s = sumCount();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        if (check &gt;= 0) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            Node&lt;K,V&gt;[] tab, nt; int n, sc;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            while (s &gt;= (long)(sc = sizeCtl) &amp;&amp; (tab = table) != null &amp;&amp;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   (n = tab.length) &lt; MAXIMUM_CAPACITY) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                int rs = resizeStamp(n);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                if (sc &lt; 0) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    if ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + 1 ||</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        sc == rs + MAX_RESIZERS || (nt = nextTable) == null ||</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        transferIndex &lt;= 0)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        break;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    if (U.compareAndSetInt(this, SIZECTL, sc, sc + 1))</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        transfer(tab, nt);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                else if (U.compareAndSetInt(this, SIZECTL, sc,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                             (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2))</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    transfer(tab, null);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                s = sumCount();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // putï¼Œremoveç­‰æƒ…å†µä¸‹é‡åˆ°æ‰©å®¹ï¼Œå¦‚æœå½“å‰å½“å‰çº¿ç¨‹é‡åˆ°Forwardingç»“ç‚¹ï¼Œ</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // å‘ç°æ­£åœ¨æ‰©å®¹ï¼Œå°±ä¼šå¸®åŠ©æ‰©å®¹ï¼›å¦‚æœæ²¡æœ‰å‘ç°æ‰©å®¹ï¼Œé‚£ä¹ˆä»ç„¶å¯ä»¥ç»§ç»­æ“ä½œ</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    final Node&lt;K,V&gt;[] helpTransfer(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt; f) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Node&lt;K,V&gt;[] nextTab; int sc;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        if (tab != null &amp;&amp; (f instanceof ForwardingNode) &amp;&amp;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            (nextTab = ((ForwardingNode&lt;K,V&gt;)f).nextTable) != null) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            int rs = resizeStamp(tab.length);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            while (nextTab == nextTable &amp;&amp; table == tab &amp;&amp;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                   (sc = sizeCtl) &lt; 0) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                if ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + 1 ||</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    sc == rs + MAX_RESIZERS || transferIndex &lt;= 0)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                // é€šè¿‡CASæ“ä½œè·å–æ‰©å®¹åé¢</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                if (U.compareAndSetInt(this, SIZECTL, sc, sc + 1)) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    // æ•°æ®è¿ç§»</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    transfer(tab, nextTab);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            return nextTab;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        return table;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private final void tryPresize(int size) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // cï¼šsize çš„ 1.5 å€ï¼Œå†åŠ  1ï¼Œå†å¾€ä¸Šå–æœ€è¿‘çš„ 2 çš„ n æ¬¡æ–¹ã€‚</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        int c = (size &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; 1)) ? MAXIMUM_CAPACITY : tableSizeFor(size + (size &gt;&gt;&gt; 1) + 1);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        int sc;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        while ((sc = sizeCtl) &gt;= 0) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            Node&lt;K,V&gt;[] tab = table; int n;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // åˆå§‹åŒ–æ•°ç»„</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            if (tab == null || (n = tab.length) == 0) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                n = (sc &gt; c) ? sc : c;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                if (U.compareAndSetInt(this, SIZECTL, sc, -1)) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    try {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        if (table == tab) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            @SuppressWarnings(&quot;unchecked&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])new Node&lt;?,?&gt;[n];</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            table = nt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            sc = n - (n &gt;&gt;&gt; 2);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    } finally {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        sizeCtl = sc;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            else if (c &lt;= sc || n &gt;= MAXIMUM_CAPACITY)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                break;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            else if (tab == table) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                int rs = resizeStamp(n);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                if (U.compareAndSetInt(this, SIZECTL, sc, (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2))</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    transfer(tab, null);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private static final int tableSizeFor(int c) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        int n = -1 &gt;&gt;&gt; Integer.numberOfLeadingZeros(c - 1);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        return (n &lt; 0) ? 1 : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private final void transfer(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt;[] nextTab) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        int n = tab.length, stride;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // NCPU = cpu æ ¸å¿ƒæ•°</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // è®¡ç®—æ¯æ¡çº¿ç¨‹å¤„ç†çš„æ¡¶ä¸ªæ•°ï¼Œæ¯æ¡çº¿ç¨‹å¤„ç†çš„æ¡¶æ•°é‡ä¸€æ ·ï¼›æ¯ä¸ªçº¿ç¨‹å¤„ç†æ¡¶çš„æœ€å°æ•°ç›®ï¼Œå¯ä»¥çœ‹å‡ºæ ¸æ•°è¶Šé«˜æ­¥é•¿è¶Šå°ï¼Œæœ€å°16ä¸ªï¼Œã€‚</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        if ((stride = (NCPU &gt; 1) ? (n &gt;&gt;&gt; 3) / NCPU : n) &lt; MIN_TRANSFER_STRIDE)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            stride = MIN_TRANSFER_STRIDE; // subdivide range</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // è¿˜æœªæŒ‡å®šä¸‹ä¸€ä¸ªè¡¨ï¼Œåˆ™æ–°å»ºç›®æ ‡è¡¨çš„å¤§å°ï¼›</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        if (nextTab == null) {            // initiating</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            try {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                @SuppressWarnings(&quot;unchecked&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])new Node&lt;?,?&gt;[n &lt;&lt; 1];</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                nextTab = nt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            } catch (Throwable ex) {      // try to cope with OOME</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                sizeCtl = Integer.MAX_VALUE;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                return;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            nextTable = nextTab;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // æ‰©å®¹æ€»è¿›åº¦ï¼Œ&gt;=transferIndexçš„æ¡¶éƒ½å·²åˆ†é…å‡ºå»</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            transferIndex = n;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        int nextn = nextTab.length;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // æ ‡æ˜æ­¤èŠ‚ç‚¹æ­£åœ¨è¿›è¡Œè¿ç§»ï¼Œæ‰©å®¹æœŸé—´çš„å…ƒç´ æŸ¥æ‰¾è¦è°ƒç”¨å…¶find()æ–¹æ³•åœ¨nextTableä¸­æŸ¥æ‰¾å…ƒç´ ã€‚</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        ForwardingNode&lt;K,V&gt; fwd = new ForwardingNode&lt;K,V&gt;(nextTab);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        </span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // å½“å‰çº¿ç¨‹æ˜¯å¦éœ€è¦ç»§ç»­å¯»æ‰¾ä¸‹ä¸€ä¸ªå¯å¤„ç†çš„èŠ‚ç‚¹</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        boolean advance = true;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // æ‰€æœ‰æ¡¶æ˜¯å¦éƒ½å·²è¿ç§»å®Œæˆ</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        boolean finishing = false; // to ensure sweep before committing nextTab</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0, bound = 0;;) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            Node&lt;K,V&gt; f; int fh;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            while (advance) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                int nextIndex, nextBound;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                // å¤„ç†ä¸€ä¸ªæ¡¶å°±iå‡1</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                if (--i &gt;= bound || finishing)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    advance = false;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                // è¿ç§»æ€»è¿›åº¦&lt;=0ï¼Œè¡¨ç¤ºæ‰€æœ‰æ¡¶éƒ½å·²è¿ç§»å®Œæˆï¼Œiç½®-1ï¼Œadvanceä¸ºfalseï¼Œåç»­æ ¹æ®è¿™ä¸ªé€€å‡ºæ‰©å®¹</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                else if ((nextIndex = transferIndex) &lt;= 0) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    i = -1;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    advance = false;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                // é¦–æ¬¡è¿›å…¥forå¾ªç¯ä¼šè¿›å…¥è¯¥å‡½æ•°ï¼Œè®¾ç½®ä»»åŠ¡åŒºé—´</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                else if (U.compareAndSetInt</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                         (this, TRANSFERINDEX, nextIndex,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                          nextBound = (nextIndex &gt; stride ?</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                       nextIndex - stride : 0))) {// transferIndexå‡å»å·²åˆ†é…å‡ºå»çš„æ¡¶ã€‚</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    // ç¡®å®šå½“å‰çº¿ç¨‹æ¯æ¬¡åˆ†é…çš„å¾…è¿ç§»æ¡¶çš„èŒƒå›´ä¸º[bound, nextIndex)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    bound = nextBound;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    i = nextIndex - 1;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    advance = false;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // æ‰©å®¹ç»“æŸï¼ŒnextTable åªæœ‰æ‰©å®¹æ—¶æ‰ä¸ä¸ºnullï¼›å°†tableæŒ‡å‘æ–°è¡¨ï¼Œé‡æ–°è®¾ç½®sizeCtl</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            if (i &lt; 0 || i &gt;= n || i + n &gt;= nextn) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                int sc;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                if (finishing) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    nextTable = null;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    table = nextTab;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    sizeCtl = (n &lt;&lt; 1) - (n &gt;&gt;&gt; 1);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    return;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                // æ¯å½“ä¸€æ¡çº¿ç¨‹æ‰©å®¹ç»“æŸå°±ä¼šæ›´æ–°ä¸€æ¬¡ sizeCtl çš„å€¼ï¼Œè¿›è¡Œå‡1æ“ä½œ,æ‰©å®¹ä¸­ï¼ŒsizeCtlè¡¨ç¤ºæœ‰å¤šå°‘ä¸ªçº¿ç¨‹</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                if (U.compareAndSetInt(this, SIZECTL, sc = sizeCtl, sc - 1)) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    // è¿˜è®°å¾—addCount()å¤„ç»™sizeCtlèµ‹çš„åˆå€¼å—ï¼Ÿç›¸ç­‰æ—¶è¯´æ˜æ²¡æœ‰çº¿ç¨‹åœ¨å‚ä¸æ‰©å®¹äº†ï¼Œ</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    // ç½®finishing=advance=trueï¼Œä¸ºä¿é™©è®©i=nå†æ£€æŸ¥ä¸€æ¬¡ã€‚</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    if ((sc - 2) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        return;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    // å°†iè®¾ç½®ä¸ºnï¼Œå†é‡æ–°æ£€æŸ¥æ˜¯ä¸æ˜¯æ‰€æœ‰çš„ç»“ç‚¹éƒ½å®Œæˆè½¬ç§»äº†</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    finishing = advance = true;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    i = n; // recheck before commit</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // ç©ºæ¡¶ï¼Œæ”¾fwdæ ‡è¯†æ‰©å®¹çŠ¶æ€</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            else if ((f = tabAt(tab, i)) == null)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                // å¦‚æœiå¤„æ˜¯ForwardingNodeè¡¨ç¤ºç¬¬iä¸ªæ¡¶å·²ç»æœ‰çº¿ç¨‹åœ¨è´Ÿè´£è¿ç§»äº†ã€‚</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                advance = casTabAt(tab, i, null, fwd);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // å·²ç»æ”¾ç½®äº†fwdï¼Œæ‰©å®¹äº†ï¼Œæ£€æŸ¥ä¸‹ä¸€ä¸ª</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            else if ((fh = f.hash) == MOVED)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                advance = true; // already processed</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            else {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                // æ¡¶å†…å…ƒç´ è¿ç§»éœ€è¦åŠ é”</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                synchronized (f) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    if (tabAt(tab, i) == f) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        Node&lt;K,V&gt; ln, hn;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        if (fh &gt;= 0) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            // ç”±äºnæ˜¯2çš„å¹‚æ¬¡æ–¹ï¼ˆæ‰€æœ‰äºŒè¿›åˆ¶ä½ä¸­åªæœ‰ä¸€ä¸ª1)ï¼Œå¦‚n=16(0001 0000)ï¼Œç¬¬4ä½ä¸º1ï¼Œé‚£ä¹ˆhash&amp;nåçš„å€¼ç¬¬4ä½åªèƒ½ä¸º0æˆ–1ã€‚</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            // æ‰€ä»¥å¯ä»¥æ ¹æ®hash&amp;nçš„ç»“æœå°†æ‰€æœ‰ç»“ç‚¹åˆ†ä¸ºä¸¤éƒ¨åˆ†ã€‚</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            int runBit = fh &amp; n;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            Node&lt;K,V&gt; lastRun = f;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            for (Node&lt;K,V&gt; p = f.next; p != null; p = p.next) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                int b = p.hash &amp; n;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                if (b != runBit) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                    runBit = b;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                    lastRun = p;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            if (runBit == 0) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                ln = lastRun;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                hn = null;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            else {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                hn = lastRun;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                ln = null;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            // æ‰¾å‡ºæœ€åä¸€æ®µå®Œæ•´çš„ fh&amp;n ä¸å˜çš„é“¾è¡¨ï¼Œè¿™æ ·æœ€åè¿™ä¸€æ®µé“¾è¡¨å°±ä¸ç”¨é‡æ–°åˆ›å»ºæ–°ç»“ç‚¹äº†</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            for (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                int ph = p.hash; K pk = p.key; V pv = p.val;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                if ((ph &amp; n) == 0)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                    ln = new Node&lt;K,V&gt;(ph, pk, pv, ln);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                else</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                    hn = new Node&lt;K,V&gt;(ph, pk, pv, hn);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            // ä½ä½é“¾è¡¨æ”¾åœ¨iå¤„</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            setTabAt(nextTab, i, ln);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            // é«˜ä½é“¾è¡¨æ”¾åœ¨i+nå¤„</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            setTabAt(nextTab, i + n, hn);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            setTabAt(tab, i, fwd);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            advance = true;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        else if (f instanceof TreeBin) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            TreeNode&lt;K,V&gt; lo = null, loTail = null;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            TreeNode&lt;K,V&gt; hi = null, hiTail = null;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            int lc = 0, hc = 0;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            for (Node&lt;K,V&gt; e = t.first; e != null; e = e.next) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                int h = e.hash;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                TreeNode&lt;K,V&gt; p = new TreeNode&lt;K,V&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                    (h, e.key, e.val, null, null);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                if ((h &amp; n) == 0) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                    if ((p.prev = loTail) == null)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                        lo = p;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                    else</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                        loTail.next = p;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                    loTail = p;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                    ++lc;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                else {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                    if ((p.prev = hiTail) == null)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                        hi = p;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                    else</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                        hiTail.next = p;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                    hiTail = p;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                    ++hc;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            ln = (lc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(lo) :</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                (hc != 0) ? new TreeBin&lt;K,V&gt;(lo) : t;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            hn = (hc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(hi) :</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                (lc != 0) ? new TreeBin&lt;K,V&gt;(hi) : t;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            setTabAt(nextTab, i, ln);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            setTabAt(nextTab, i + n, hn);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            setTabAt(tab, i, fwd);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            advance = true;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    static final class ForwardingNode&lt;K,V&gt; extends Node&lt;K,V&gt; {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        final Node&lt;K,V&gt;[] nextTable;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        ForwardingNode(Node&lt;K,V&gt;[] tab) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            super(MOVED, null, null);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            this.nextTable = tab;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Node&lt;K,V&gt; find(int h, Object k) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // loop to avoid arbitrarily deep recursion on forwarding nodes</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            outer: for (Node&lt;K,V&gt;[] tab = nextTable;;) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                Node&lt;K,V&gt; e; int n;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                if (k == null || tab == null || (n = tab.length) == 0 ||</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    (e = tabAt(tab, (n - 1) &amp; h)) == null)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    return null;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                for (;;) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    int eh; K ek;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    if ((eh = e.hash) == h &amp;&amp;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        ((ek = e.key) == k || (ek != null &amp;&amp; k.equals(ek))))</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        return e;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    if (eh &lt; 0) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        if (e instanceof ForwardingNode) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            tab = ((ForwardingNode&lt;K,V&gt;)e).nextTable;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            continue outer;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        else</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            return e.find(h, k);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    if ((e = e.next) == null)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        return null;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public V get(Object key) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; e, p; int n, eh; K ek;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // è®¡ç®—hashå€¼</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        int h = spread(key.hashCode());</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        if ((tab = table) != null &amp;&amp; (n = tab.length) &gt; 0 &amp;&amp; (e = tabAt(tab, (n - 1) &amp; h)) != null) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // åˆ¤æ–­å¤´ç»“ç‚¹æ˜¯å¦å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„èŠ‚ç‚¹</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            if ((eh = e.hash) == h) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                if ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek)))</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    return e.val;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // å¦‚æœå¤´ç»“ç‚¹çš„ hash å°äº 0ï¼Œè¯´æ˜ æ­£åœ¨æ‰©å®¹æˆ–è€…è¯¥ä½ç½®æ˜¯çº¢é»‘æ ‘</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            else if (eh &lt; 0)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                return (p = e.find(h, key)) != null ? p.val : null;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // éå†é“¾è¡¨</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            while ((e = e.next) != null) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                if (e.hash == h &amp;&amp;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek))))</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    return e.val;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        return null;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>put æ–¹æ³•æµç¨‹:</p><ul><li>æ ¹æ® key è®¡ç®—å‡º hashcode ã€‚</li><li>åˆ¤æ–­è¡¨æ˜¯å¦éœ€è¦è¿›è¡Œåˆå§‹åŒ–ã€‚</li><li>å®šä½å‡ºçš„ç›®æ ‡æ¡¶ï¼Œå¦‚æœä¸ºç©ºè¡¨ç¤ºå½“å‰ä½ç½®å¯ä»¥å†™å…¥æ•°æ®ï¼Œåˆ©ç”¨ CAS å°è¯•å†™å…¥ï¼Œå¤±è´¥åˆ™è‡ªæ—‹ã€‚</li><li>å¦‚æœå½“å‰ä½ç½®çš„ hashcode == MOVED == -1,åˆ™å¸®åŠ©æ‰©å®¹ï¼Œæ‰©å®¹å®Œæˆåæ‰è¿›è¡Œæ’å…¥ã€‚</li><li>å¦‚æœæ²¡æœ‰ç‰¹æ®Šæƒ…å†µï¼Œåˆ™åˆ©ç”¨ synchronized é”å†™å…¥æ•°æ®ã€‚</li><li>å¦‚æœæ•°é‡å¤§äº TREEIFY_THRESHOLDï¼ˆ8ï¼‰ åˆ™è¦è½¬æ¢ä¸ºçº¢é»‘æ ‘ã€‚</li><li>æ’å…¥å®Œæˆï¼Œæˆ‘ä»¬åˆ¤æ–­ä¸€ä¸‹æ˜¯ä¸æ˜¯è¦æ‰©å®¹ï¼Œå¹¶è®°å½•ä¸€ä¸‹Nodeæ•°é‡;æ–¹ä¾¿ç»Ÿè®¡</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="concurrentlinkedqueue"></a>ConcurrentLinkedQueue<a class="hash-link" href="#concurrentlinkedqueue" title="Direct link to heading">#</a></h2><p>ä¸€ä¸ªåŸºäºé“¾æ¥èŠ‚ç‚¹çš„æ— ç•Œçº¿ç¨‹å®‰å…¨é˜Ÿåˆ—ï¼Œå®ƒé‡‡ç”¨å…ˆè¿›å…ˆå‡ºçš„è§„åˆ™å¯¹èŠ‚ç‚¹è¿›è¡Œæ’åºï¼Œå½“æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªå…ƒç´ çš„æ—¶å€™ï¼Œå®ƒä¼šæ·»åŠ åˆ°é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œå½“æˆ‘ä»¬è·å–ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œå®ƒä¼šè¿”å›é˜Ÿåˆ—å¤´éƒ¨çš„å…ƒç´ </p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="æ¶æ„å›¾"></a>æ¶æ„å›¾<a class="hash-link" href="#æ¶æ„å›¾" title="Direct link to heading">#</a></h3><p><img src="/docs.advanced.way/assets/images/ConcurrentLinkedQueue-df6dd5aa5b04a54d1b05c9da27c4e841.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="æºç -1"></a>æºç <a class="hash-link" href="#æºç -1" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">public class ConcurrentLinkedQueue&lt;E&gt; extends AbstractQueue&lt;E&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        implements Queue&lt;E&gt;, java.io.Serializable {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    transient volatile Node&lt;E&gt; head;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private transient volatile Node&lt;E&gt; tail;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private static final VarHandle HEAD;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private static final VarHandle TAIL;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    static final VarHandle ITEM;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    static final VarHandle NEXT;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public ConcurrentLinkedQueue() {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        head = tail = new Node&lt;E&gt;();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    static final class Node&lt;E&gt; {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        volatile E item;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        volatile Node&lt;E&gt; next;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        /**</span></div><div class="token-line" style="color:#393A34"><span class="token plain">         * Constructs a node holding item.  Uses relaxed write because</span></div><div class="token-line" style="color:#393A34"><span class="token plain">         * item can only be seen after piggy-backing publication via CAS.</span></div><div class="token-line" style="color:#393A34"><span class="token plain">         */</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Node(E item) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            ITEM.set(this, item);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        /** Constructs a dead dummy node. */</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Node() {}</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        void appendRelaxed(Node&lt;E&gt; next) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // assert next != null;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // assert this.next == null;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            NEXT.set(this, next);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        boolean casItem(E cmp, E val) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // assert item == cmp || item == null;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // assert cmp != null;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // assert val == null;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            return ITEM.compareAndSet(this, cmp, val);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public boolean add(E e) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        return offer(e);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // å…¥é˜Ÿ</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public boolean offer(E e) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // åˆ›å»ºèŠ‚ç‚¹</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        final Node&lt;E&gt; newNode = new Node&lt;E&gt;(Objects.requireNonNull(e));</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // æ ¹æ®tailèŠ‚ç‚¹å®šä½å‡ºå°¾èŠ‚ç‚¹</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        for (Node&lt;E&gt; t = tail, p = t;;) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            Node&lt;E&gt; q = p.next;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // æ”¾å…¥å°¾éƒ¨</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            if (q == null) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                // p is last node</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                // å°†æ–°èŠ‚ç‚¹ç½®ä¸ºå°¾èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                if (NEXT.compareAndSet(p, null, newNode)) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    // Successful CAS is the linearization point</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    // for e to become an element of this queue,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    // and for newNode to become &quot;live&quot;.</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    if (p != t) // hop two nodes at a time; failure is OK</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        TAIL.weakCompareAndSet(this, t, newNode);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    return true;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                // Lost CAS race to another thread; re-read next</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            else if (p == q)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                // We have fallen off list.  If tail is unchanged, it</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                // will also be off-list, in which case we need to</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                // jump to head, from which all live nodes are always</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                // reachable.  Else the new tail is a better bet.</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                p = (t != (t = tail)) ? t : head;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            else</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                // å¯»æ‰¾å°¾èŠ‚ç‚¹</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                // Check for tail updates after two hops.</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                p = (p != t &amp;&amp; t != (t = tail)) ? t : q;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // å‡ºé˜Ÿ</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public E poll() {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        restartFromHead: for (;;) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            for (Node&lt;E&gt; h = head, p = h, q;; p = q) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                final E item;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                if ((item = p.item) != null &amp;&amp; p.casItem(item, null)) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    // Successful CAS is the linearization point</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    // for item to be removed from this queue.</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    if (p != h) // hop two nodes at a time</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        updateHead(h, ((q = p.next) != null) ? q : p);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    return item;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                else if ((q = p.next) == null) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    updateHead(h, p);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    return null;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                else if (p == q)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    continue restartFromHead;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        </span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="copyonwritearraylist"></a>CopyOnWriteArrayList<a class="hash-link" href="#copyonwritearraylist" title="Direct link to heading">#</a></h2><p>Copy-On-Writeç®€ç§°COWï¼Œæ˜¯ä¸€ç§ç”¨äºç¨‹åºè®¾è®¡ä¸­çš„ä¼˜åŒ–ç­–ç•¥ã€‚
å…¶åŸºæœ¬æ€è·¯æ˜¯ï¼Œä»ä¸€å¼€å§‹å¤§å®¶éƒ½åœ¨å…±äº«åŒä¸€ä¸ªå†…å®¹ï¼Œå½“æŸä¸ªäººæƒ³è¦ä¿®æ”¹è¿™ä¸ªå†…å®¹çš„æ—¶å€™ï¼Œæ‰ä¼šçœŸæ­£æŠŠå†…å®¹Copyå‡ºå»å½¢æˆä¸€ä¸ªæ–°çš„å†…å®¹ç„¶åå†æ”¹ï¼Œè¿™æ˜¯ä¸€ç§å»¶æ—¶æ‡’æƒ°ç­–ç•¥</p><p>CopyOnWriteå¹¶å‘å®¹å™¨ç”¨äºè¯»å¤šå†™å°‘çš„å¹¶å‘åœºæ™¯ æ¯”å¦‚: ç™½åå•ï¼Œé»‘åå•ï¼Œå•†å“ç±»ç›®çš„è®¿é—®å’Œæ›´æ–°åœºæ™¯</p><p>ç¼ºç‚¹:</p><ul><li><p>å†…å­˜å ç”¨é—®é¢˜ å› ä¸ºCopyOnWriteçš„å†™æ—¶å¤åˆ¶æœºåˆ¶ï¼Œæ‰€ä»¥åœ¨è¿›è¡Œå†™æ“ä½œçš„æ—¶å€™ï¼Œå†…å­˜é‡Œä¼šåŒæ—¶é©»æ‰ä¸¤ä¸ªå¯¹è±¡çš„å†…å­˜ï¼Œæ—§çš„å¯¹è±¡å’Œæ–°å†™å…¥çš„å¯¹è±¡</p></li><li><p>æ•°æ®ä¸€è‡´æ€§é—®é¢˜ åªèƒ½ä¿è¯æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ï¼Œä¸èƒ½ä¿è¯æ•°æ®çš„å®æ—¶ä¸€è‡´æ€§</p></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="æ¶æ„å›¾-1"></a>æ¶æ„å›¾<a class="hash-link" href="#æ¶æ„å›¾-1" title="Direct link to heading">#</a></h3><p><img src="/docs.advanced.way/assets/images/CopyOnWriteArrayList-b850551cbe36bf1acd54acfe4c221245.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="æºç -2"></a>æºç <a class="hash-link" href="#æºç -2" title="Direct link to heading">#</a></h3><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">public class CopyOnWriteArrayList&lt;E&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    implements List&lt;E&gt;, RandomAccess, Cloneable, java.io.Serializable {</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    final transient Object lock = new Object();</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // å®¹å™¨</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private transient volatile Object[] array;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    final Object[] getArray() {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        return array;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    final void setArray(Object[] a) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        array = a;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // é»˜è®¤æ„é€ å™¨</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public CopyOnWriteArrayList() {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        setArray(new Object[0]);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // è·å–å…ƒç´ </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public E get(int index) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        return elementAt(getArray(), index);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    static &lt;E&gt; E elementAt(Object[] a, int index) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // è¯»çš„æ—¶å€™ä¸éœ€è¦åŠ é”ï¼Œå¦‚æœè¯»çš„æ—¶å€™æœ‰å¤šä¸ªçº¿ç¨‹æ­£åœ¨å‘CopyOnWriteArrayListæ·»åŠ æ•°æ®ï¼Œè¯»è¿˜æ˜¯ä¼šè¯»åˆ°æ—§çš„æ•°æ®</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        return (E) a[index];</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public boolean add(E e) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // åŠ é”</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        synchronized (lock) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // è·å–å®¹å™¨</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            Object[] es = getArray();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            int len = es.length;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // å¤åˆ¶å‡ºæ–°æ•°ç»„</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            es = Arrays.copyOf(es, len + 1);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // æŠŠæ–°å…ƒç´ æ·»åŠ åˆ°æ–°æ•°ç»„é‡Œ</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            es[len] = e;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // æŠŠåŸæ•°ç»„å¼•ç”¨æŒ‡å‘æ–°æ•°ç»„</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            setArray(es);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            return true;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="é˜»å¡é˜Ÿåˆ—"></a>é˜»å¡é˜Ÿåˆ—<a class="hash-link" href="#é˜»å¡é˜Ÿåˆ—" title="Direct link to heading">#</a></h2><p>æ”¯æŒä¸¤ä¸ªé™„åŠ æ“ä½œçš„é˜Ÿåˆ—</p><ul><li>æ”¯æŒé˜»å¡çš„æ’å…¥æ–¹æ³•</li></ul><p>é˜Ÿåˆ—æ»¡æ—¶ï¼Œé˜Ÿåˆ—é˜»å¡æ’å…¥å…ƒç´ çš„çº¿ç¨‹</p><ul><li>æ”¯æŒé˜»å¡çš„ç§»é™¤æ–¹æ³•</li></ul><p>é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œè·å–å…ƒç´ çš„çº¿ç¨‹ä¼šç­‰å¾…é˜Ÿåˆ—ä¸ºéç©º</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="æ ¸å¿ƒç±»"></a>æ ¸å¿ƒç±»<a class="hash-link" href="#æ ¸å¿ƒç±»" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="blockingqueueclass"></a>BlockingQueue.class<a class="hash-link" href="#blockingqueueclass" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">public interface BlockingQueue&lt;E&gt; extends Queue&lt;E&gt;{</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="abstractqueueclass"></a>AbstractQueue.class<a class="hash-link" href="#abstractqueueclass" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractQueue&lt;E&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    extends AbstractCollection&lt;E&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    implements Queue&lt;E&gt; {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="arrayblockingqueue"></a>ArrayBlockingQueue<a class="hash-link" href="#arrayblockingqueue" title="Direct link to heading">#</a></h3><p>ä¸€ä¸ªæ•°ç»„å®ç°çš„æœ‰ç•Œé˜Ÿåˆ—ï¼ˆFIFOï¼‰</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">public class ArrayBlockingQueue&lt;E&gt; extends AbstractQueue&lt;E&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        implements BlockingQueue&lt;E&gt;, java.io.Serializable {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // å®¹å™¨</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    final Object[] items;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // å…ƒç´ ä¸ªæ•°</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    int count;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    final ReentrantLock lock;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private final Condition notEmpty;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private final Condition notFull;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // é»˜è®¤éå…¬å¹³</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public ArrayBlockingQueue(int capacity) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        this(capacity, false);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // å¯ä»¥æŒ‡å®šè®¿é—®æ¨¡å¼ï¼ˆå…¬å¹³æˆ–éå…¬å¹³ï¼‰</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public ArrayBlockingQueue(int capacity, boolean fair) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        if (capacity &lt;= 0)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            throw new IllegalArgumentException();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        this.items = new Object[capacity];</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        lock = new ReentrantLock(fair);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        notEmpty = lock.newCondition();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        notFull =  lock.newCondition();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // æ’å…¥å…ƒç´ </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public boolean offer(E e) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Objects.requireNonNull(e);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        final ReentrantLock lock = this.lock;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        lock.lock();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        try {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            if (count == items.length)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                return false;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            else {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                enqueue(e);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                return true;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            lock.unlock();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public void put(E e) throws InterruptedException {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Objects.requireNonNull(e);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        final ReentrantLock lock = this.lock;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        lock.lockInterruptibly();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        try {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // æ£€æŸ¥æ˜¯å¦å·²æ»¡</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            while (count == items.length)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                notFull.await();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            enqueue(e);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            lock.unlock();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private void enqueue(E e) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // assert lock.isHeldByCurrentThread();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // assert lock.getHoldCount() == 1;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // assert items[putIndex] == null;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        final Object[] items = this.items;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // æ”¾å…¥æ•°ç»„</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        items[putIndex] = e;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        if (++putIndex == items.length) putIndex = 0;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        count++;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        notEmpty.signal();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public E take() throws InterruptedException {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        final ReentrantLock lock = this.lock;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        lock.lockInterruptibly();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        try {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            while (count == 0)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                // é˜»å¡</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                notEmpty.await();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            return dequeue();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            lock.unlock();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private E dequeue() {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // assert lock.isHeldByCurrentThread();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // assert lock.getHoldCount() == 1;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // assert items[takeIndex] != null;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        final Object[] items = this.items;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        @SuppressWarnings(&quot;unchecked&quot;)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        E e = (E) items[takeIndex];</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // ç½®ç©º</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        items[takeIndex] = null;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        if (++takeIndex == items.length) takeIndex = 0;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        count--;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        if (itrs != null)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            itrs.elementDequeued();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        notFull.signal();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        return e;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public int size() {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        final ReentrantLock lock = this.lock;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        lock.lock();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        try {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            return count;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            lock.unlock();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="linkedblockingqueue"></a>LinkedBlockingQueue<a class="hash-link" href="#linkedblockingqueue" title="Direct link to heading">#</a></h3><p>é“¾è¡¨å®ç°çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">public class LinkedBlockingQueue&lt;E&gt; extends AbstractQueue&lt;E&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        implements BlockingQueue&lt;E&gt;, java.io.Serializable {</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private final int capacity;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private final AtomicInteger count = new AtomicInteger();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    transient Node&lt;E&gt; head;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private transient Node&lt;E&gt; last;        </span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    static class Node&lt;E&gt; {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        E item;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        /**</span></div><div class="token-line" style="color:#393A34"><span class="token plain">         * One of:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">         * - the real successor Node</span></div><div class="token-line" style="color:#393A34"><span class="token plain">         * - this Node, meaning the successor is head.next</span></div><div class="token-line" style="color:#393A34"><span class="token plain">         * - null, meaning there is no successor (this is the last node)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">         */</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Node&lt;E&gt; next;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Node(E x) { item = x; }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // Integer.MAX_VALUE</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public LinkedBlockingQueue() {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        this(Integer.MAX_VALUE);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // æŒ‡å®šå®¹é‡</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public LinkedBlockingQueue(int capacity) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        if (capacity &lt;= 0) throw new IllegalArgumentException();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        this.capacity = capacity;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        last = head = new Node&lt;E&gt;(null);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public void put(E e) throws InterruptedException {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        if (e == null) throw new NullPointerException();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        final int c;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        final Node&lt;E&gt; node = new Node&lt;E&gt;(e);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        final ReentrantLock putLock = this.putLock;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        final AtomicInteger count = this.count;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        putLock.lockInterruptibly();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        try {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // åˆ¤æ–­æ˜¯å¦å·²æ»¡</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            while (count.get() == capacity) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                notFull.await();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            enqueue(node);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            c = count.getAndIncrement();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            if (c + 1 &lt; capacity)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                notFull.signal();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            putLock.unlock();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        if (c == 0)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            signalNotEmpty();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }   </span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // æ”¾å…¥å°¾éƒ¨</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private void enqueue(Node&lt;E&gt; node) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        last = last.next = node;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }    </span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public E take() throws InterruptedException {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        final E x;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        final int c;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        final AtomicInteger count = this.count;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        final ReentrantLock takeLock = this.takeLock;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        takeLock.lockInterruptibly();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        try {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // æ˜¯å¦ä¸ºç©º</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            while (count.get() == 0) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                notEmpty.await();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            x = dequeue();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // å…ƒç´ æ•°é‡å‡ä¸€</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            c = count.getAndDecrement();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            if (c &gt; 1)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                notEmpty.signal();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            takeLock.unlock();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        if (c == capacity)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            signalNotFull();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        return x;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private E dequeue() {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // assert takeLock.isHeldByCurrentThread();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // assert head.item == null;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Node&lt;E&gt; h = head;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // å–å¤´ç»“ç‚¹ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Node&lt;E&gt; first = h.next;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        h.next = h; // help GC</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // é‡æ–°æŒ‡å‘å¤´ç»“ç‚¹</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        head = first;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        E x = first.item;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        first.item = null;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        return x;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="linkedtransferqueue"></a>LinkedTransferQueue<a class="hash-link" href="#linkedtransferqueue" title="Direct link to heading">#</a></h3><p>é“¾è¡¨ç»“æ„çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">public class LinkedTransferQueue&lt;E&gt; extends AbstractQueue&lt;E&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    implements TransferQueue&lt;E&gt;, java.io.Serializable  {</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    static final class Node {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        final boolean isData;   // false if this is a request node</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        volatile Object item;   // initially non-null if isData; CASed to match</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        volatile Node next;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        volatile Thread waiter; // null when not waiting for a match</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        /**</span></div><div class="token-line" style="color:#393A34"><span class="token plain">         * Constructs a data node holding item if item is non-null,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">         * else a request node.  Uses relaxed write because item can</span></div><div class="token-line" style="color:#393A34"><span class="token plain">         * only be seen after piggy-backing publication via CAS.</span></div><div class="token-line" style="color:#393A34"><span class="token plain">         */</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Node(Object item) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            ITEM.set(this, item);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            isData = (item != null);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        /** Constructs a (matched data) dummy node. */</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Node() {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            isData = true;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="linkedblockingdeque"></a>LinkedBlockingDeque<a class="hash-link" href="#linkedblockingdeque" title="Direct link to heading">#</a></h3><p>é“¾è¡¨ç»“æ„çš„åŒå‘é˜»å¡é˜Ÿåˆ—</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">public class LinkedBlockingDeque&lt;E&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    extends AbstractQueue&lt;E&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    implements BlockingDeque&lt;E&gt;, java.io.Serializable {</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    static final class Node&lt;E&gt; {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        /**</span></div><div class="token-line" style="color:#393A34"><span class="token plain">         * The item, or null if this node has been removed.</span></div><div class="token-line" style="color:#393A34"><span class="token plain">         */</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        E item;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        /**</span></div><div class="token-line" style="color:#393A34"><span class="token plain">         * One of:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">         * - the real predecessor Node</span></div><div class="token-line" style="color:#393A34"><span class="token plain">         * - this Node, meaning the predecessor is tail</span></div><div class="token-line" style="color:#393A34"><span class="token plain">         * - null, meaning there is no predecessor</span></div><div class="token-line" style="color:#393A34"><span class="token plain">         */</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Node&lt;E&gt; prev;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        /**</span></div><div class="token-line" style="color:#393A34"><span class="token plain">         * One of:</span></div><div class="token-line" style="color:#393A34"><span class="token plain">         * - the real successor Node</span></div><div class="token-line" style="color:#393A34"><span class="token plain">         * - this Node, meaning the successor is head</span></div><div class="token-line" style="color:#393A34"><span class="token plain">         * - null, meaning there is no successor</span></div><div class="token-line" style="color:#393A34"><span class="token plain">         */</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Node&lt;E&gt; next;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Node(E x) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            item = x;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    transient Node&lt;E&gt; first;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    transient Node&lt;E&gt; last;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">     /** Number of items in the deque */</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private transient int count;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    /** Maximum number of items in the deque */</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private final int capacity;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public LinkedBlockingDeque() {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        this(Integer.MAX_VALUE);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public LinkedBlockingDeque(int capacity) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        if (capacity &lt;= 0) throw new IllegalArgumentException();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        this.capacity = capacity;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public boolean offerFirst(E e) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        if (e == null) throw new NullPointerException();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Node&lt;E&gt; node = new Node&lt;E&gt;(e);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        final ReentrantLock lock = this.lock;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        lock.lock();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        try {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            return linkFirst(node);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            lock.unlock();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private boolean linkFirst(Node&lt;E&gt; node) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // assert lock.isHeldByCurrentThread();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        if (count &gt;= capacity)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            return false;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Node&lt;E&gt; f = first;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        node.next = f;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        first = node;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        if (last == null)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            last = node;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        else</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            f.prev = node;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        ++count;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        notEmpty.signal();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        return true;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public E pollFirst() {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        final ReentrantLock lock = this.lock;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        lock.lock();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        try {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            return unlinkFirst();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            lock.unlock();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private E unlinkFirst() {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // assert lock.isHeldByCurrentThread();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Node&lt;E&gt; f = first;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        if (f == null)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            return null;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Node&lt;E&gt; n = f.next;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        E item = f.item;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        f.item = null;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        f.next = f; // help GC</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        first = n;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        if (n == null)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            last = null;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        else</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            n.prev = null;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        --count;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        notFull.signal();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        return item;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="priorityblockingqueue"></a>PriorityBlockingQueue<a class="hash-link" href="#priorityblockingqueue" title="Direct link to heading">#</a></h3><blockquote><p>Priority [praÉªËˆÉ’rÉ™ti], Blocking [blÉ’kÉªÅ‹] queue  [kjuË]</p></blockquote><p>æ”¯æŒä¼˜å…ˆçº§çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">public class PriorityBlockingQueue&lt;E&gt; extends AbstractQueue&lt;E&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    implements BlockingQueue&lt;E&gt;, java.io.Serializable {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private static final int DEFAULT_INITIAL_CAPACITY = 11;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private transient Object[] queue;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private transient int size;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private transient Comparator&lt;? super E&gt; comparator;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private PriorityQueue&lt;E&gt; q;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // é»˜è®¤å®¹é‡ï¼Œè‡ªç„¶åºæ’åˆ—</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public PriorityBlockingQueue() {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        this(DEFAULT_INITIAL_CAPACITY, null);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // æŒ‡å®šå®¹é‡ï¼ˆæœ€å°ä¸º1ï¼‰</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public PriorityBlockingQueue(int initialCapacity,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                 Comparator&lt;? super E&gt; comparator) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        if (initialCapacity &lt; 1)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            throw new IllegalArgumentException();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        this.comparator = comparator;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        this.queue = new Object[Math.max(1, initialCapacity)];</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public void put(E e) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        offer(e); // ä¸éœ€è¦é˜»å¡</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public boolean offer(E e) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        if (e == null)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            throw new NullPointerException();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        final ReentrantLock lock = this.lock;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        lock.lock();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        int n, cap;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Object[] es;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        while ((n = size) &gt;= (cap = (es = queue).length))</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            tryGrow(es, cap);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        try {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            final Comparator&lt;? super E&gt; cmp;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            if ((cmp = comparator) == null)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                siftUpComparable(n, e, es);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            else</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                siftUpUsingComparator(n, e, es, cmp);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            size = n + 1;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            notEmpty.signal();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            lock.unlock();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        return true;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public E take() throws InterruptedException {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        final ReentrantLock lock = this.lock;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        lock.lockInterruptibly();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        E result;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        try {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            while ( (result = dequeue()) == null)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                notEmpty.await();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            lock.unlock();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        return result;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private E dequeue() {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // assert lock.isHeldByCurrentThread();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        final Object[] es;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        final E result;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        if ((result = (E) ((es = queue)[0])) != null) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            final int n;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            final E x = (E) es[(n = --size)];</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            es[n] = null;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            if (n &gt; 0) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                final Comparator&lt;? super E&gt; cmp;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                if ((cmp = comparator) == null)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    siftDownComparable(0, x, es, n);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                else</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    siftDownUsingComparator(0, x, es, n, cmp);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        return result;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="delayqueue"></a>DelayQueue<a class="hash-link" href="#delayqueue" title="Direct link to heading">#</a></h3><p>æ”¯æŒå»¶æ—¶è·å–å…ƒç´ çš„æ— ç•Œé˜Ÿåˆ—ï¼Œé˜Ÿåˆ—ä¸­çš„å…ƒç´ éœ€è¦å®ç° <code>Delayed</code> æ¥å£</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">public class DelayQueue&lt;E extends Delayed&gt; extends AbstractQueue&lt;E&gt;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    implements BlockingQueue&lt;E&gt;{</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private final PriorityQueue&lt;E&gt; q = new PriorityQueue&lt;E&gt;();</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public DelayQueue() {}</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // æ·»åŠ å…ƒç´ </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public boolean offer(E e) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        final ReentrantLock lock = this.lock;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        lock.lock();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        try {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // æ’å…¥é˜Ÿåˆ—ä¸­</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            q.offer(e);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            if (q.peek() == e) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                leader = null;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                available.signal();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            return true;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            lock.unlock();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public E take() throws InterruptedException {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        final ReentrantLock lock = this.lock;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        lock.lockInterruptibly();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        try {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            for (;;) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                E first = q.peek();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                // å¤´å…ƒç´ ä¸ºç©ºnullæ—¶é˜»å¡</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                if (first == null)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    available.await();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                else {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    // å‰©ä½™å»¶è¿Ÿæ—¶é—´</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    long delay = first.getDelay(NANOSECONDS);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    if (delay &lt;= 0L)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        // å¼¹å‡ºå¤´å…ƒç´ </span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        return q.poll();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    first = null; // don&#x27;t retain ref while waiting</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    if (leader != null)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        available.await();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    else {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        Thread thisThread = Thread.currentThread();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        leader = thisThread;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        try {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            available.awaitNanos(delay);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        } finally {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                            if (leader == thisThread)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                leader = null;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            if (leader == null &amp;&amp; q.peek() != null)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                available.signal();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            lock.unlock();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="priorityqueue"></a>PriorityQueue<a class="hash-link" href="#priorityqueue" title="Direct link to heading">#</a></h4><p>ä¼˜å…ˆçº§é˜Ÿåˆ—</p><p>PriorityQueue åº•å±‚é€šè¿‡æ•°ç»„æ¥å®ç°å…ƒç´ çš„å­˜å‚¨</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly java"><div tabindex="0" class="prism-code language-java codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">public class PriorityQueue&lt;E&gt; extends AbstractQueue&lt;E&gt;{</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private static final int DEFAULT_INITIAL_CAPACITY = 11;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // é˜Ÿåˆ—çš„å…ƒç´ ä¿å­˜åœ¨æ•°ç»„queueä¸­ï¼Œå…¶æ•°æ®ç»“æ„ä¸ºæœ€å°å †ï¼Œä¹Ÿå°±æ˜¯ç”¨æ•°ç»„è¡¨ç¤ºçš„å®Œå…¨äºŒå‰æ ‘</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    transient Object[] queue;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    int size;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    transient int modCount;</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public PriorityQueue(int initialCapacity,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                         Comparator&lt;? super E&gt; comparator) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // Note: This restriction of at least one is not actually needed,</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // but continues for 1.5 compatibility</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        if (initialCapacity &lt; 1)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            throw new IllegalArgumentException();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        this.queue = new Object[initialCapacity];</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        this.comparator = comparator;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // æ’å…¥å…ƒç´ </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public boolean offer(E e) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        if (e == null)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            throw new NullPointerException();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // ä¿®æ”¹æ¬¡æ•°</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        modCount++;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        int i = size;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        if (i &gt;= queue.length)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            grow(i + 1);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        siftUp(i, e);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        size = i + 1;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        return true;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private void siftUp(int k, E x) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        if (comparator != null)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // åŸºäºcomparatorå±æ€§è¿›è¡Œå¤§å°æ¯”è¾ƒ</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            siftUpUsingComparator(k, x, queue, comparator);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        else</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            // æ ¹æ®å…ƒç´ è‡ªèº«è¿›è¡Œæ’åº</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            siftUpComparable(k, x, queue);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private static &lt;T&gt; void siftUpComparable(int k, T x, Object[] es) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        Comparable&lt;? super T&gt; key = (Comparable&lt;? super T&gt;) x;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        while (k &gt; 0) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            int parent = (k - 1) &gt;&gt;&gt; 1;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            Object e = es[parent];</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            if (key.compareTo((T) e) &gt;= 0)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                break;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            es[k] = e;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            k = parent;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        es[k] = key;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private static &lt;T&gt; void siftUpUsingComparator(</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        int k, T x, Object[] es, Comparator&lt;? super T&gt; cmp) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        while (k &gt; 0) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            int parent = (k - 1) &gt;&gt;&gt; 1;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            Object e = es[parent];</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            if (cmp.compare(x, (T) e) &gt;= 0)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                break;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            es[k] = e;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            k = parent;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        es[k] = x;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // æ‰©å®¹ å°äº64æ‰©å®¹ä¸¤å€+2ï¼Œå¦åˆ™æ‰©å®¹1.5å€</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private void grow(int minCapacity) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        int oldCapacity = queue.length;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // Double size if small; else grow by 50%</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        int newCapacity = oldCapacity + ((oldCapacity &lt; 64) ?</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                         (oldCapacity + 2) :</span></div><div class="token-line" style="color:#393A34"><span class="token plain">                                         (oldCapacity &gt;&gt; 1));</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // overflow-conscious code</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        if (newCapacity - MAX_ARRAY_SIZE &gt; 0)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            newCapacity = hugeCapacity(minCapacity);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        // å¤åˆ¶æ•°æ®</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        queue = Arrays.copyOf(queue, newCapacity);</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    private static int hugeCapacity(int minCapacity) {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        if (minCapacity &lt; 0) // overflow</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            throw new OutOfMemoryError();</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        return (minCapacity &gt; MAX_ARRAY_SIZE) ?</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            Integer.MAX_VALUE :</span></div><div class="token-line" style="color:#393A34"><span class="token plain">            MAX_ARRAY_SIZE;</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    // å¤´å…ƒç´ </span></div><div class="token-line" style="color:#393A34"><span class="token plain">    public E peek() {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">        return (E) queue[0];</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    }</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor" id="å°é¡¶å †"></a>å°é¡¶å †<a class="hash-link" href="#å°é¡¶å †" title="Direct link to heading">#</a></h4><p><img src="/docs.advanced.way/assets/images/1078540-20191219134028689-155327191-0f0075db90108270be9d753639416663.png"></p><p>å…ƒç´ èŠ‚ç‚¹å…³ç³»</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">leftNo = parentNo * 2 + 1</span></div><div class="token-line" style="color:#393A34"><span class="token plain">rightNo = parentNo * 2 + 2</span></div><div class="token-line" style="color:#393A34"><span class="token plain">parentNo = (currentNo -1) / 2</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">parentNoï¼šè¡¨ç¤ºçˆ¶èŠ‚ç‚¹ä¸‹æ ‡ï¼›</span></div><div class="token-line" style="color:#393A34"><span class="token plain">leftNoï¼šè¡¨ç¤ºå­å…ƒç´ å·¦èŠ‚ç‚¹ä¸‹æ ‡ï¼›</span></div><div class="token-line" style="color:#393A34"><span class="token plain">rightNoï¼šè¡¨ç¤ºå­å…ƒç´ å³èŠ‚ç‚¹ä¸‹æ ‡ï¼›</span></div><div class="token-line" style="color:#393A34"><span class="token plain">currentNoï¼šè¡¨ç¤ºå½“å‰å…ƒç´ èŠ‚ç‚¹ä¸‹æ ‡ï¼›</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>é€šè¿‡ä¸Šè¿°ä¸‰ä¸ªå…¬å¼ï¼Œå¯ä»¥è½»æ˜“è®¡ç®—å‡ºæŸä¸ªèŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä»¥åŠå­èŠ‚ç‚¹çš„ä¸‹æ ‡</p><p><img src="/docs.advanced.way/assets/images/1078540-20191219134058870-285989691-a01a249edd93790d561db70cc67d472b.png"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="å‚è€ƒ"></a>å‚è€ƒ<a class="hash-link" href="#å‚è€ƒ" title="Direct link to heading">#</a></h2><p><a href="https://blog.csdn.net/qq_38293564/article/details/80798310" target="_blank" rel="noopener noreferrer">Javaå¹¶å‘ç¼–ç¨‹ä¹‹ConcurrentLinkedQueueè¯¦è§£</a></p><p><a href="https://www.cnblogs.com/dxflqm/p/12067265.html" target="_blank" rel="noopener noreferrer">æ·±å…¥æµ…å‡ºåˆ†æ PriorityQueue</a></p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/Goldwood1024/docs.advanced.way/tree/master/docs/java/hc/å¹¶å‘å®¹å™¨.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col text--right"><em><small>Last updated on <time datetime="2021-07-06T06:05:23.000Z" class="lastUpdatedDate_1WI_">7/6/2021</time></small></em></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs.advanced.way/docs/java/hc/åŸå­ç±»"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« åŸå­ç±»</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs.advanced.way/docs/java/hc/å¹¶å‘å·¥å…·ç±»"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">å¹¶å‘å·¥å…·ç±» Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#concurrenthashmap" class="table-of-contents__link">ConcurrentHashMap</a><ul><li><a href="#ç»“æ„" class="table-of-contents__link">ç»“æ„</a></li><li><a href="#æºç " class="table-of-contents__link">æºç </a></li></ul></li><li><a href="#concurrentlinkedqueue" class="table-of-contents__link">ConcurrentLinkedQueue</a><ul><li><a href="#æ¶æ„å›¾" class="table-of-contents__link">æ¶æ„å›¾</a></li><li><a href="#æºç -1" class="table-of-contents__link">æºç </a></li></ul></li><li><a href="#copyonwritearraylist" class="table-of-contents__link">CopyOnWriteArrayList</a><ul><li><a href="#æ¶æ„å›¾-1" class="table-of-contents__link">æ¶æ„å›¾</a></li><li><a href="#æºç -2" class="table-of-contents__link">æºç </a></li></ul></li><li><a href="#é˜»å¡é˜Ÿåˆ—" class="table-of-contents__link">é˜»å¡é˜Ÿåˆ—</a><ul><li><a href="#æ ¸å¿ƒç±»" class="table-of-contents__link">æ ¸å¿ƒç±»</a></li><li><a href="#arrayblockingqueue" class="table-of-contents__link">ArrayBlockingQueue</a></li><li><a href="#linkedblockingqueue" class="table-of-contents__link">LinkedBlockingQueue</a></li><li><a href="#linkedtransferqueue" class="table-of-contents__link">LinkedTransferQueue</a></li><li><a href="#linkedblockingdeque" class="table-of-contents__link">LinkedBlockingDeque</a></li><li><a href="#priorityblockingqueue" class="table-of-contents__link">PriorityBlockingQueue</a></li><li><a href="#delayqueue" class="table-of-contents__link">DelayQueue</a></li></ul></li><li><a href="#å‚è€ƒ" class="table-of-contents__link">å‚è€ƒ</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 è¿›é˜¶ä¹‹è·¯, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/docs.advanced.way/assets/js/runtime~main.aa1c8b94.js"></script>
<script src="/docs.advanced.way/assets/js/main.8fae9188.js"></script>
</body>
</html>